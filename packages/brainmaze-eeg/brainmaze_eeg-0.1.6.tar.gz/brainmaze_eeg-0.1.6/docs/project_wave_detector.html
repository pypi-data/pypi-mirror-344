
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>EEG Wave Detection and Analysis &#8212; BrainMaze: A Toolbox to Analyze Brain Electrophysiology, Behavior and Dynamics - EEG</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=67ce15f2"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'project_wave_detector';</script>
    <link rel="icon" href="_static/brainmaze_173x173.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Classifiers" href="classifiers.html" />
    <link rel="prev" title="BrainMaze - EEG" href="index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/brainmaze_1757x1762.png" class="logo__image only-light" alt="BrainMaze: A Toolbox to Analyze Brain Electrophysiology, Behavior and Dynamics - EEG - Home"/>
    <script>document.write(`<img src="_static/brainmaze_1757x1762.png" class="logo__image only-dark" alt="BrainMaze: A Toolbox to Analyze Brain Electrophysiology, Behavior and Dynamics - EEG - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    BrainMaze - EEG
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Projects</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">EEG Wave Detection and Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="classifiers.html">Classifiers</a></li>
<li class="toctree-l1"><a class="reference internal" href="crp.html">CRP</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="features.html">Features</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="features.dataset.html">Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.feature_extraction.html">Feature Extraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.spectral_features.html">Spectral Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.time_domain_features.html">Time Domain Features</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.utils.html">Utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="features.wave_detector.html">Wave Detector</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="hypnogram.html">Hypnogram</a></li>
<li class="toctree-l1"><a class="reference internal" href="preprocessing.html">Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="scikit_modules.html">Scikit Modules</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/bnelair/brainmaze_eeg" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/project_wave_detector.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>EEG Wave Detection and Analysis</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#project-eeg-slow-wave-detection-and-analysis">Project: EEG Slow Wave Detection and Analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgement">Acknowledgement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#version">Version</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examples">Examples</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#code">Code</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="eeg-wave-detection-and-analysis">
<h1>EEG Wave Detection and Analysis<a class="headerlink" href="#eeg-wave-detection-and-analysis" title="Link to this heading">#</a></h1>
<section id="project-eeg-slow-wave-detection-and-analysis">
<h2>Project: EEG Slow Wave Detection and Analysis<a class="headerlink" href="#project-eeg-slow-wave-detection-and-analysis" title="Link to this heading">#</a></h2>
<dl>
<dt>This project was published in the following paper:</dt><dd><div class="line-block">
<div class="line"><br /></div>
<div class="line">Carvalho DZ, Kremen V, Mivalt F, St Louis EK, McCarter SJ, Bukartyk J, Przybelski SA, Kamykowski MG, Spychalla AJ, Machulda MM, Boeve BF, Petersen RC, Jack CR Jr, Lowe VJ, Graff-Radford J, Worrell GA, Somers VK, Varga AW, Vemuri P. Non-rapid eye movement sleep slow-wave activity features are associated with amyloid accumulation in older adults with obstructive sleep apnoea. Brain Commun. 2024 Oct 7;6(5):fcae354. doi: 10.1093/braincomms/fcae354. PMID: 39429245; PMCID: PMC11487750.</div>
<div class="line"><br /></div>
</div>
</dd>
</dl>
<p>Here we conveniently provide a standalone fully functional code example for analysis related to this project - <a class="reference external" href="https://github.com/bnelair/brainmaze_eeg/tree/fmivalt/main/demo/eeg_wave_detection">One file example</a>.
This enables trialing this code without installing the whole Best Toolbox library.
The codes were also embedded into the brainmaze_eeg Toolbox so they can be freely available upon installing the whole <a class="reference external" href="https://github.com/bnelair/brainmaze_eeg/">Brainmaze EEG</a> library. The documentation to the toolbox is available at <a class="reference external" href="https://bnelair.github.io/brainmaze_eeg">Brainmaze EEG</a>.</p>
<p>TBD TBD !!!! For more information on this specific project, see the page describing <a class="reference external" href="https://best-toolbox.readthedocs.io/en/latest/feature_extraction.WaveDetector.html">Wave Detection</a>.</p>
</section>
<section id="acknowledgement">
<h2>Acknowledgement<a class="headerlink" href="#acknowledgement" title="Link to this heading">#</a></h2>
<blockquote>
<div><div class="line-block">
<div class="line"><br /></div>
<div class="line">F. Mivalt et V. Kremen et al., “Electrical brain stimulation and continuous behavioral state tracking in ambulatory humans,” J. Neural Eng., vol. 19, no. 1, p. 016019, Feb. 2022, doi: 10.1088/1741-2552/ac4bfd.</div>
<div class="line"><br /></div>
<div class="line">F. Mivalt et V. Sladky et al., “Automated sleep classification with chronic neural implants in freely behaving canines,” J. Neural Eng., vol. 20, no. 4, p. 046025, Aug. 2023, doi: 10.1088/1741-2552/aced21.</div>
<div class="line"><br /></div>
<div class="line">Gerla, V., Kremen, V., Macas, M., Dudysova, D., Mladek, A., Sos, P., &amp; Lhotska, L. (2019). Iterative expert-in-the-loop classification of sleep PSG recordings using a hierarchical clustering. Journal of Neuroscience Methods, 317(February), 61?70. <a class="reference external" href="https://doi.org/10.1016/j.jneumeth.2019.01.013">https://doi.org/10.1016/j.jneumeth.2019.01.013</a></div>
<div class="line"><br /></div>
<div class="line">Kremen, V., Brinkmann, B. H., Van Gompel, J. J., Stead, S. (Matt) M., St Louis, E. K., &amp; Worrell, G. A. (2018). Automated Unsupervised Behavioral State Classification using Intracranial Electrophysiology. Journal of Neural Engineering. <a class="reference external" href="https://doi.org/10.1088/1741-2552/aae5ab">https://doi.org/10.1088/1741-2552/aae5ab</a></div>
<div class="line"><br /></div>
</div>
</div></blockquote>
</section>
<section id="version">
<h2>Version<a class="headerlink" href="#version" title="Link to this heading">#</a></h2>
<p>Version 1.0 (2024-06-01) by V. Kremen (<a class="reference external" href="mailto:Kremen&#46;Vaclav&#37;&#52;&#48;mayo&#46;edu">Kremen<span>&#46;</span>Vaclav<span>&#64;</span>mayo<span>&#46;</span>edu</a>)</p>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Link to this heading">#</a></h2>
<p>Example of individual slow wave detections.</p>
<a class="reference internal image-reference" href="_images/slow_waves_example.png"><img alt="_images/slow_waves_example.png" src="_images/slow_waves_example.png" style="width: 900px;" />
</a>
<p>Extracted features for the whole night.</p>
<a class="reference internal image-reference" href="_images/slope_vaclav.png"><img alt="_images/slope_vaclav.png" src="_images/slope_vaclav.png" style="width: 900px;" />
</a>
</section>
<section id="code">
<h2>Code<a class="headerlink" href="#code" title="Link to this heading">#</a></h2>
<p>The code is also attached for convenience in here:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># region Description and Acknowledgements</span>
<span class="c1">#</span>
<span class="c1"># Code for extracting and analyzing electrophysiology features from EEG data and saving them to a CSV file.</span>
<span class="c1"># The program particularly analyzes one EEG signal from the Fz-(A1+A2)/2 channel and extracts features from it as a</span>
<span class="c1"># demonstration of the whole signal processing pipeline used in the project cited below.</span>
<span class="c1">#</span>
<span class="c1"># The code also plots the extracted features and saves the plots to PDF files including the PSD analysis figures.</span>
<span class="c1"># The code can also perform statistical analysis on the extracted features.</span>
<span class="c1"># The code can be run from the command line or from a Python IDE.</span>
<span class="c1"># The code requires the following packages to be installed: mne, pandas, numpy, scipy, plotly, tqdm, best, matplotlib.</span>
<span class="c1"># The code is written in Python 3.8.8. and calls also the SlowWaveDetect function from the SlowWaveDetector.py file.</span>
<span class="c1"># The code requires exported sleep saved in patient_one_data.pkl file placed in the directory of the script.</span>
<span class="c1"># The file contains EEG data for whole night recording with its sleep scoring</span>
<span class="c1"># and other metadata (such as sampling frequency).</span>
<span class="c1">#</span>
<span class="c1"># Acknowledgements:</span>
<span class="c1"># The code is part of the project of Analyzing EEG data from sleep studies for publication of manuscript:</span>
<span class="c1"># NREM sleep slow wave activity features are associated with amyloid accumulation in older adults with</span>
<span class="c1"># obstructive sleep apnea. By D. Carvalho et al., 2024</span>
<span class="c1">#</span>
<span class="c1"># The Feature Extractor uses the Behavioral State Analysis Toolbox (BEST) for feature extraction from raw EEG data.</span>
<span class="c1"># The BEST toolbox was developed during multiple projects we appreciate you acknowledge when using</span>
<span class="c1"># or inspired by this toolbox.</span>
<span class="c1">#</span>
<span class="c1"># Hyperlink to documentation of the BEST: https://best-toolbox.readthedocs.io/en/latest/index.html#</span>
<span class="c1">#</span>
<span class="c1"># Sleep classification and feature extraction</span>
<span class="c1"># F. Mivalt et V. Kremen et al., “Electrical brain stimulation and continuous behavioral state tracking in ambulatory humans,” J. Neural Eng., vol. 19, no. 1, p. 016019, Feb. 2022, doi: 10.1088/1741-2552/ac4bfd.</span>
<span class="c1"># F. Mivalt et V. Sladky et al., “Automated sleep classification with chronic neural implants in freely behaving canines,” J. Neural Eng., vol. 20, no. 4, p. 046025, Aug. 2023, doi: 10.1088/1741-2552/aced21.</span>
<span class="c1"># Gerla, V., Kremen, V., Macas, M., Dudysova, D., Mladek, A., Sos, P., &amp; Lhotska, L. (2019). Iterative expert-in-the-loop classification of sleep PSG recordings using a hierarchical clustering. Journal of Neuroscience Methods, 317(February), 61?70. https://doi.org/10.1016/j.jneumeth.2019.01.013</span>
<span class="c1"># Kremen, V., Brinkmann, B. H., Van Gompel, J. J., Stead, S. (Matt) M., St Louis, E. K., &amp; Worrell, G. A. (2018). Automated Unsupervised Behavioral State Classification using Intracranial Electrophysiology. Journal of Neural Engineering. https://doi.org/10.1088/1741-2552/aae5ab</span>
<span class="c1"># Kremen, V., Duque, J. J., Brinkmann, B. H., Berry, B. M., Kucewicz, M. T., Khadjevand, F., G.A. Worrell, G. A. (2017). Behavioral state classification in epileptic brain using intracranial electrophysiology. Journal of Neural Engineering, 14(2), 026001. https://doi.org/10.1088/1741-2552/aa5688</span>
<span class="c1">#</span>
<span class="c1"># The BEST was developed under projects supported by NIH Brain Initiative UH2&amp;3 NS095495 Neurophysiologically-Based</span>
<span class="c1"># Brain State Tracking &amp; Modulation in Focal Epilepsy, DARPA HR0011-20-2-0028 Manipulating and Optimizing Brain Rhythms</span>
<span class="c1"># for Enhancement of Sleep (Morpheus). Filip Mivalt was also partially supported by the grant FEKT-K-22-7649 realized</span>
<span class="c1"># within the project Quality Internal Grants of the Brno University of Technology (KInG BUT),</span>
<span class="c1"># Reg. No. CZ.02.2.69/0.0/0.0/19_073/0016948, which is financed from the OP RDE.</span>
<span class="c1">#</span>
<span class="c1"># License:</span>
<span class="c1"># This software is licensed under GNU license. For the details, see the LICENSE file in the root directory of this project.</span>
<span class="c1"># endregion Description and Acknowledgements</span>
<span class="c1">#</span>
<span class="c1"># Version 1.0 (2024-07-05) by V. Kremen (Kremen.Vaclav@mayo.edu)</span>

<span class="c1"># region Imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mne</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">concurrent.futures</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">savemat</span><span class="p">,</span> <span class="n">loadmat</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">firwin</span><span class="p">,</span> <span class="n">lfilter</span><span class="p">,</span> <span class="n">freqz</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">butter</span><span class="p">,</span> <span class="n">firwin</span><span class="p">,</span> <span class="n">filtfilt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">best.files</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_files</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">best.feature_extraction.SpectralFeatures</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_frequency</span><span class="p">,</span> <span class="n">median_frequency</span><span class="p">,</span> <span class="n">mean_bands</span><span class="p">,</span> <span class="n">relative_bands</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">best.feature_extraction.FeatureExtractor</span><span class="w"> </span><span class="kn">import</span> <span class="n">SleepSpectralFeatureExtractor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">SlowWaveDetector</span><span class="w"> </span><span class="kn">import</span> <span class="n">SlowWaveDetect</span> <span class="c1"># Import the SlowWaveDetect function from SlowWaveDetector.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">best.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">buffer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">best</span><span class="w"> </span><span class="kn">import</span> <span class="n">DELIMITER</span>
<span class="c1"># endregion imports</span>

<span class="c1"># region FILE_PATH</span>
<span class="n">DATA_PATH</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;./patient_one_data.mat&#39;</span>
<span class="c1"># endregion FILE_PATH</span>

<span class="c1"># region Parameters</span>
<span class="n">ToPlotFigures</span> <span class="o">=</span> <span class="kc">True</span>    <span class="c1"># Do you want to print the figures? (True/False)</span>
<span class="n">ToDoStats</span> <span class="o">=</span> <span class="kc">False</span>   <span class="c1"># Do you want to perform statistical analysis after you extracted features? (True/False)</span>
<span class="n">features_path</span> <span class="o">=</span> <span class="s1">&#39;Results_extraction.csv&#39;</span>  <span class="c1"># Where are going to be saved the extracted features?</span>
<span class="n">features_to_plot</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MEAN_PSD0.5-0.9Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;MEAN_PSD1.0-3.9Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;delta_slope&#39;</span><span class="p">,</span> <span class="s1">&#39;slow_delta_slope&#39;</span><span class="p">]</span>    <span class="c1"># Which features to plot?</span>
<span class="n">plot_wave_images</span> <span class="o">=</span> <span class="kc">True</span>    <span class="c1"># Do you want to plot the wave images? (True/False)</span>
<span class="c1"># endregion parameters</span>

<span class="c1"># region Functions</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_epoch</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">x1_</span><span class="p">,</span> <span class="n">x2_</span><span class="p">,</span> <span class="n">t_</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">,</span> <span class="n">hypnogram</span><span class="p">,</span> <span class="n">fs_hypno</span><span class="p">,</span> <span class="n">data_present</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">fsamp</span><span class="p">,</span> <span class="n">path_edf</span><span class="p">):</span>
    <span class="n">epoch_result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;pt_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_id</span>
    <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_</span>
    <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_</span> <span class="o">+</span> <span class="mi">30</span>
    <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
    <span class="n">sleep_stage_in_epoch</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">hypnogram</span><span class="p">[</span><span class="nb">int</span><span class="p">(((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t_</span> <span class="o">+</span> <span class="mi">30</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">fs_hypno</span><span class="p">)])</span>
    <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;sleep_stage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sleep_stage_in_epoch</span>
    <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;data_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_present</span><span class="p">[</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">t_</span> <span class="o">*</span> <span class="n">fs_hypno</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="nb">int</span><span class="p">(((</span><span class="n">t_</span> <span class="o">+</span> <span class="mi">30</span><span class="p">)</span> <span class="o">*</span> <span class="n">fs_hypno</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="n">fs_hypno</span><span class="p">))</span>
    <span class="n">total_record_time</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;CLINIC&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">patient_id</span><span class="p">,</span> <span class="s1">&#39;TotalRecordTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_record_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t_</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">&lt;</span> <span class="n">total_record_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_record_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">t_</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">&gt;</span> <span class="n">total_record_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">x__</span> <span class="o">=</span> <span class="n">x_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">x1__</span> <span class="o">=</span> <span class="n">x1_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">x2__</span> <span class="o">=</span> <span class="n">x2_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
    <span class="n">features</span><span class="p">,</span> <span class="n">feature_names</span> <span class="o">=</span> <span class="n">FeatureExtractor</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
    <span class="n">epoch_result</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">feature</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">features</span><span class="p">))})</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">sleep_stages</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;Awake&#39;</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;NREM1&#39;</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;NREM2&#39;</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;NREM3&#39;</span><span class="p">,</span>
            <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;REM&#39;</span><span class="p">,</span>
            <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;UNKNOWN&#39;</span>
        <span class="p">}</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">date_time</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m-</span><span class="si">%d</span><span class="s2">-%Y_%H-%M-%S&quot;</span><span class="p">)</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="p">[</span><span class="n">pth</span> <span class="k">for</span> <span class="n">pth</span> <span class="ow">in</span> <span class="n">path_edf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pth</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="n">nm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Results</span><span class="se">\\</span><span class="si">{</span><span class="n">nm</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">_EEG_extremes_</span><span class="si">{</span><span class="n">sleep_stages</span><span class="p">[</span><span class="n">sleep_stage_in_epoch</span><span class="p">]</span><span class="si">}</span><span class="s1">_Delta_</span><span class="si">{</span><span class="n">date_time</span><span class="si">}</span><span class="s1">.pdf&#39;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">SlowWaveDetect</span><span class="p">(</span><span class="n">x2__</span><span class="p">,</span> <span class="n">fsamp</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">sleep_stages</span><span class="p">[</span><span class="n">sleep_stage_in_epoch</span><span class="p">],</span> <span class="n">epoch</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">slow_waves</span><span class="p">,</span> <span class="n">slow_wave_amplitudes</span><span class="p">,</span> <span class="n">slow_wave_slopes</span><span class="p">,</span> <span class="n">mean_amplitude</span><span class="p">,</span> <span class="n">std_amplitude</span><span class="p">,</span> <span class="n">mean_slope</span><span class="p">,</span> <span class="n">std_slope</span><span class="p">,</span> <span class="n">num_waves</span> <span class="o">=</span> <span class="n">results</span>

        <span class="k">if</span> <span class="n">num_waves</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;delta_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_slope</span>
            <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;delta_pk2pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_amplitude</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;delta_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;delta_pk2pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">_EEG_extremes_</span><span class="si">{</span><span class="n">sleep_stages</span><span class="p">[</span><span class="n">sleep_stage_in_epoch</span><span class="p">]</span><span class="si">}</span><span class="s1">_SlowWave_</span><span class="si">{</span><span class="n">date_time</span><span class="si">}</span><span class="s1">.pdf&#39;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">SlowWaveDetect</span><span class="p">(</span><span class="n">x1__</span><span class="p">,</span> <span class="n">fsamp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">sleep_stages</span><span class="p">[</span><span class="n">sleep_stage_in_epoch</span><span class="p">],</span> <span class="n">epoch</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">slow_waves</span><span class="p">,</span> <span class="n">slow_wave_amplitudes</span><span class="p">,</span> <span class="n">slow_wave_slopes</span><span class="p">,</span> <span class="n">mean_amplitude</span><span class="p">,</span> <span class="n">std_amplitude</span><span class="p">,</span> <span class="n">mean_slope</span><span class="p">,</span> <span class="n">std_slope</span><span class="p">,</span> <span class="n">num_waves</span> <span class="o">=</span> <span class="n">results</span>

        <span class="k">if</span> <span class="n">num_waves</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;slow_delta_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_slope</span>
            <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;slow_delta_pk2pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_amplitude</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;slow_delta_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;slow_delta_pk2pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;delta_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;delta_pk2pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;slow_delta_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">epoch_result</span><span class="p">[</span><span class="s1">&#39;slow_delta_pk2pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">count</span><span class="p">,</span> <span class="n">epoch_result</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run_parallel_processing</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">xb_01</span><span class="p">,</span> <span class="n">xb_02</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">,</span> <span class="n">hypnogram</span><span class="p">,</span> <span class="n">fs_hypno</span><span class="p">,</span> <span class="n">data_present</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">fsamp</span><span class="p">,</span> <span class="n">path_edf</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">process_epoch</span><span class="p">,</span> <span class="n">x_</span><span class="p">,</span> <span class="n">x1_</span><span class="p">,</span> <span class="n">x2_</span><span class="p">,</span> <span class="n">t_</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">,</span> <span class="n">hypnogram</span><span class="p">,</span> <span class="n">fs_hypno</span><span class="p">,</span> <span class="n">data_present</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">fsamp</span><span class="p">,</span> <span class="n">path_edf</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">x1_</span><span class="p">,</span> <span class="n">x2_</span><span class="p">,</span> <span class="n">t_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">xb_01</span><span class="p">,</span> <span class="n">xb_02</span><span class="p">,</span> <span class="n">tb</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
            <span class="n">count</span><span class="p">,</span> <span class="n">epoch_result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">epoch_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">res</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process_file</span><span class="p">(</span><span class="n">path_edf</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">path_edf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIMITER</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading EDF file: &#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">read_raw_edf</span><span class="p">(</span><span class="n">path_edf</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">info</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">annotations</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">ch_names</span>
    <span class="n">fsamp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;sfreq&#39;</span><span class="p">]</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">orig_time</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span>

    <span class="n">FeatureExtractor</span> <span class="o">=</span> <span class="n">SleepSpectralFeatureExtractor</span><span class="p">(</span>
        <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">,</span>
        <span class="n">segm_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">fbands</span><span class="o">=</span><span class="p">[[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">3.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mf">7.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mf">11.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mf">15.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mf">29.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">35</span><span class="p">]],</span>
        <span class="n">datarate</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">FeatureExtractor</span><span class="o">.</span><span class="n">_extraction_functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">mean_frequency</span><span class="p">,</span> <span class="n">median_frequency</span><span class="p">,</span> <span class="n">mean_bands</span><span class="p">,</span> <span class="n">relative_bands</span><span class="p">]</span>

    <span class="n">patient_id</span> <span class="o">=</span> <span class="n">extract_id</span><span class="p">(</span><span class="n">path_edf</span><span class="p">)</span>
    <span class="n">fzcz</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Fz&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">-</span>
            <span class="p">(((</span><span class="n">data</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;A1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;A2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Read the EEG data C3 - (A1+A2)/2</span>
    <span class="n">data_present</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;DataPresent&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">hypnogram</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;Hypnogram&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>  <span class="c1"># Read the hypnogram</span>
    <span class="n">fs_hypno</span> <span class="o">=</span> <span class="n">fsamp</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">hypnogram</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">fzcz</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Filtering signal...&#39;</span><span class="p">)</span>
    <span class="n">numtaps</span> <span class="o">=</span> <span class="mi">1999</span>
    <span class="n">cutoff_low</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">cutoff_high</span> <span class="o">=</span> <span class="mi">35</span>
    <span class="n">window</span> <span class="o">=</span> <span class="s1">&#39;hamming&#39;</span>
    <span class="n">nyquist_freq</span> <span class="o">=</span> <span class="n">fsamp</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">fir_coeff</span> <span class="o">=</span> <span class="n">firwin</span><span class="p">(</span><span class="n">numtaps</span><span class="p">,</span> <span class="p">[</span><span class="n">cutoff_low</span><span class="p">,</span> <span class="n">cutoff_high</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">pass_zero</span><span class="o">=</span><span class="s1">&#39;bandpass&#39;</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">)</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">freqz</span><span class="p">(</span><span class="n">fir_coeff</span><span class="p">,</span> <span class="n">worN</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>

    <span class="n">fzcz_orig</span> <span class="o">=</span> <span class="n">fzcz</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fir_coeff</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">fzcz_orig_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">fzcz_orig</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">fzcz_padded</span> <span class="o">=</span> <span class="n">lfilter</span><span class="p">(</span><span class="n">fir_coeff</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">fzcz_orig_padded</span><span class="p">)</span>
    <span class="n">fzcz</span> <span class="o">=</span> <span class="n">fzcz_padded</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">]</span>

    <span class="n">numtaps</span> <span class="o">=</span> <span class="mi">19999</span>
    <span class="n">cutoff_low</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">cutoff_high</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">window</span> <span class="o">=</span> <span class="s1">&#39;hamming&#39;</span>

    <span class="n">fir_coeff</span> <span class="o">=</span> <span class="n">firwin</span><span class="p">(</span><span class="n">numtaps</span><span class="p">,</span> <span class="p">[</span><span class="n">cutoff_low</span><span class="p">,</span> <span class="n">cutoff_high</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">pass_zero</span><span class="o">=</span><span class="s1">&#39;bandpass&#39;</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">)</span>
    <span class="n">fzcz_orig_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">fzcz_orig</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">fzcz_01_padded</span> <span class="o">=</span> <span class="n">lfilter</span><span class="p">(</span><span class="n">fir_coeff</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">fzcz_orig_padded</span><span class="p">)</span>
    <span class="n">fzcz_01</span> <span class="o">=</span> <span class="n">fzcz_01_padded</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">]</span>

    <span class="n">numtaps</span> <span class="o">=</span> <span class="mi">9999</span>
    <span class="n">cutoff_low</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cutoff_high</span> <span class="o">=</span> <span class="mf">3.9</span>
    <span class="n">window</span> <span class="o">=</span> <span class="s1">&#39;hamming&#39;</span>

    <span class="n">fir_coeff</span> <span class="o">=</span> <span class="n">firwin</span><span class="p">(</span><span class="n">numtaps</span><span class="p">,</span> <span class="p">[</span><span class="n">cutoff_low</span><span class="p">,</span> <span class="n">cutoff_high</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">pass_zero</span><span class="o">=</span><span class="s1">&#39;bandpass&#39;</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">)</span>
    <span class="n">fzcz_orig_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">fzcz_orig</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="n">fzcz_02_padded</span> <span class="o">=</span> <span class="n">lfilter</span><span class="p">(</span><span class="n">fir_coeff</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">fzcz_orig_padded</span><span class="p">)</span>
    <span class="n">fzcz_02</span> <span class="o">=</span> <span class="n">fzcz_02_padded</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">]</span>

    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fzcz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">fsamp</span><span class="p">)</span>
    <span class="n">xb</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">(</span><span class="n">fzcz</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">,</span> <span class="n">segm_size</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">xb_01</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">(</span><span class="n">fzcz_01</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">,</span> <span class="n">segm_size</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">xb_02</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">(</span><span class="n">fzcz_02</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">,</span> <span class="n">segm_size</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">,</span> <span class="n">segm_size</span><span class="o">=</span><span class="mi">30</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">run_parallel_processing</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">xb_01</span><span class="p">,</span> <span class="n">xb_02</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">patient_id</span><span class="p">,</span> <span class="n">hypnogram</span><span class="p">,</span> <span class="n">fs_hypno</span><span class="p">,</span> <span class="n">data_present</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">fsamp</span><span class="p">,</span>
                                  <span class="n">path_edf</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">this_patient_first_row</span><span class="p">,</span> <span class="n">features_to_plot</span><span class="p">,</span> <span class="n">fzcz</span><span class="p">,</span> <span class="n">fsamp</span><span class="p">,</span> <span class="n">path_edf</span><span class="p">,</span> <span class="n">hypnogram</span>

<span class="k">def</span><span class="w"> </span><span class="nf">butt_filter</span><span class="p">(</span><span class="n">signal_to_filter</span><span class="p">,</span> <span class="n">sampling_frequency_of_signal</span><span class="p">,</span>
                <span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">type_of_filter</span><span class="o">=</span><span class="s1">&#39;lowpass&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter the input signal using a Butterworth filter.</span>

<span class="sd">    :param signal_to_filter: The input signal to be filtered.</span>
<span class="sd">    :param sampling_frequency_of_signal: The sampling frequency of the input signal.</span>
<span class="sd">    :param lowcut: The lower cutoff frequency of the filter.</span>
<span class="sd">    :param highcut: The upper cutoff frequency of the filter.</span>
<span class="sd">    :param order: The order of the filter (default is 5).</span>
<span class="sd">    :param type_of_filter: The type of filter to be applied (default is &#39;lowpass&#39;).</span>
<span class="sd">    :return: The filtered signal.</span>

<span class="sd">    .. note:: This method uses the scipy.signal.butter and scipy.signal.filtfilt functions internally.</span>
<span class="sd">    .. seealso:: `scipy.signal.butter &lt;https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.butter.html&gt;`_,</span>
<span class="sd">                 `scipy.signal.filtfilt &lt;https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.filtfilt.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Normalize the cutoff frequencies</span>
    <span class="n">nyquist</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sampling_frequency_of_signal</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">lowcut</span> <span class="o">/</span> <span class="n">nyquist</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">highcut</span> <span class="o">/</span> <span class="n">nyquist</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Compute the filter coefficients using a Butterworth filter</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;lowpass&#39;</span><span class="p">:</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">btype</span><span class="o">=</span><span class="n">type_of_filter</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;ba&#39;</span><span class="p">)</span>
        <span class="c1"># &#39;ba&#39; is used to get numerator (b) and denominator (a) polynomials of the IIR filter as 1D sequences</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;highpass&#39;</span><span class="p">:</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">btype</span><span class="o">=</span><span class="n">type_of_filter</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;ba&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;bandpass&#39;</span><span class="p">:</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="p">[</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">],</span> <span class="n">btype</span><span class="o">=</span><span class="n">type_of_filter</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;ba&#39;</span><span class="p">)</span>

    <span class="c1"># Apply the zero-phase filter to the signal</span>
    <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">filtfilt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">signal_to_filter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_data</span>

<span class="k">def</span><span class="w"> </span><span class="nf">firwin_bandpass_filter</span><span class="p">(</span><span class="n">signal_to_filter</span><span class="p">,</span> <span class="n">sampling_frequency</span><span class="p">,</span> <span class="n">lowcut</span><span class="p">,</span> <span class="n">highcut</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a finite impulse response (FIR) bandpass filter to a given signal.</span>

<span class="sd">    :param signal_to_filter: The signal to be filtered.</span>
<span class="sd">    :param sampling_frequency: The sampling frequency of the signal.</span>
<span class="sd">    :param lowcut: The lower cutoff frequency of the bandpass filter.</span>
<span class="sd">    :param highcut: The higher cutoff frequency of the bandpass filter.</span>
<span class="sd">    :param order: The order of the filter (optional, default is 10000).</span>
<span class="sd">    :return: The filtered signal.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Normalize the cutoff frequencies</span>
    <span class="n">nyquist</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">sampling_frequency</span>
    <span class="n">low</span> <span class="o">=</span> <span class="n">lowcut</span> <span class="o">/</span> <span class="n">nyquist</span>
    <span class="n">high</span> <span class="o">=</span> <span class="n">highcut</span> <span class="o">/</span> <span class="n">nyquist</span>

    <span class="c1"># Compute the filter coefficients using a Butterworth filter</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">firwin</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="p">[</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">],</span> <span class="n">pass_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">)</span>

    <span class="c1"># Apply the zero-phase filter to the signal</span>
    <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">filtfilt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">signal_to_filter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">filtered_data</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calculate_avg_std</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param group: A pandas DataFrame or Series object representing a group of data.</span>
<span class="sd">    :return: A pandas Series object containing the average and standard deviation of the group&#39;s data.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">nanmean</span><span class="p">()</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">nanstd</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s1">&#39;Average&#39;</span><span class="p">:</span> <span class="n">avg</span><span class="p">,</span> <span class="s1">&#39;Standard Deviation&#39;</span><span class="p">:</span> <span class="n">std</span><span class="p">})</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extract_id</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts an ID from a given path string.</span>

<span class="sd">    :param path: The path string from which to extract the ID.</span>
<span class="sd">    :return: The extracted ID as an integer. If no ID is found, returns None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">(\d</span><span class="si">{8}</span><span class="s1">)_&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
<span class="c1"># endregion Functions</span>

<span class="k">def</span><span class="w"> </span><span class="nf">do_stats</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param path: The path to the features file.</span>
<span class="sd">    :return: None</span>

<span class="sd">    This method calculates the average and standard deviation for specific columns in a features file, based on different filtering conditions. It then saves the results to separate Excel files.</span>

<span class="sd">    The method takes a single parameter:</span>
<span class="sd">    - path: The path to the features file, which should be in CSV format.</span>

<span class="sd">    The method does not return any value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Read the features file</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>  <span class="c1"># Read the metadata file</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pt_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pt_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>  <span class="c1"># Convert the column with the IDs to integers</span>

    <span class="c1"># Columns for which you want to calculate average and standard deviation</span>
    <span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MEAN_DOMINANT_FREQUENCY&#39;</span><span class="p">,</span> <span class="s1">&#39;SPECTRAL_MEDIAN_FREQUENCY&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;MEAN_PSD0.5-0.9Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;MEAN_PSD1.0-3.9Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;MEAN_PSD4.0-7.9Hz&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;MEAN_PSD8.0-11.9Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;MEAN_PSD12.0-15.9Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;MEAN_PSD16.0-29.9Hz&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;MEAN_PSD30.0-35.0Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;REL_PSD_0.5-0.9Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;REL_PSD_1.0-3.9Hz&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;REL_PSD_4.0-7.9Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;REL_PSD_8.0-11.9Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;REL_PSD_12.0-15.9Hz&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;REL_PSD_16.0-29.9Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;REL_PSD_30.0-35.0Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;delta_slope&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;delta_pk2pk&#39;</span><span class="p">,</span> <span class="s1">&#39;slow_delta_slope&#39;</span><span class="p">,</span> <span class="s1">&#39;slow_delta_pk2pk&#39;</span><span class="p">]</span>

    <span class="c1"># region NREM3</span>
    <span class="c1"># Filter rows with &#39;phase&#39; = 0 and &#39;sleep_stage&#39; = 3 or &#39;phase&#39; = 1 and &#39;sleep_stage&#39; = 3</span>
    <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sleep_stage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)]</span>

    <span class="c1"># Group by &#39;pt_id&#39; and &#39;phase&#39;-&#39;sleep_stage&#39; and calculate mean and standard deviation separately</span>
    <span class="n">mean_data</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;pt_id&#39;</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">])[</span><span class="n">feature_columns</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_avg&#39;</span><span class="p">)</span>
    <span class="n">std_data</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;pt_id&#39;</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">])[</span><span class="n">feature_columns</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_std&#39;</span><span class="p">)</span>

    <span class="c1"># Combine the mean and standard deviation DataFrames</span>
    <span class="n">grouped_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mean_data</span><span class="p">,</span> <span class="n">std_data</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Reset the index to have unique &#39;pt_id&#39; on each row</span>
    <span class="n">grouped_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">grouped_data</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s1">&#39;Results_NREM3.xlsx&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># endregion NREM3</span>

    <span class="c1"># region NREM1, NREM2, NREM3</span>
    <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">&amp;</span>
                         <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sleep_stage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sleep_stage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sleep_stage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))]</span>

    <span class="c1"># Group by &#39;pt_id&#39; and &#39;phase&#39;-&#39;sleep_stage&#39; and calculate mean and standard deviation separately</span>
    <span class="n">mean_data</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;pt_id&#39;</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">])[</span><span class="n">feature_columns</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_avg&#39;</span><span class="p">)</span>
    <span class="n">std_data</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;pt_id&#39;</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">])[</span><span class="n">feature_columns</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_std&#39;</span><span class="p">)</span>

    <span class="c1"># Combine the mean and standard deviation DataFrames</span>
    <span class="n">grouped_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mean_data</span><span class="p">,</span> <span class="n">std_data</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Reset the index to have unique &#39;pt_id&#39; on each row</span>
    <span class="n">grouped_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">grouped_data</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s1">&#39;Results_NREM123.xlsx&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># endregion NREM1, NREM2, NREM3</span>

    <span class="c1"># region NREM1, NREM2, NREM3, REM</span>
    <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">&amp;</span>
                         <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sleep_stage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sleep_stage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
                          <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sleep_stage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sleep_stage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))]</span>

    <span class="c1"># Group by &#39;pt_id&#39; and &#39;phase&#39;-&#39;sleep_stage&#39; and calculate mean and standard deviation separately</span>
    <span class="n">mean_data</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;pt_id&#39;</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">])[</span><span class="n">feature_columns</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_avg&#39;</span><span class="p">)</span>
    <span class="n">std_data</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;pt_id&#39;</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">])[</span><span class="n">feature_columns</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_std&#39;</span><span class="p">)</span>

    <span class="c1"># Combine the mean and standard deviation DataFrames</span>
    <span class="n">grouped_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mean_data</span><span class="p">,</span> <span class="n">std_data</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Reset the index to have unique &#39;pt_id&#39; on each row</span>
    <span class="n">grouped_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">grouped_data</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s1">&#39;Results_NREM123_REM.xlsx&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># endregion NREM1, NREM2, NREM3, REM</span>

    <span class="c1"># region REM only</span>
    <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;sleep_stage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)]</span>

    <span class="c1"># Group by &#39;pt_id&#39; and &#39;phase&#39;-&#39;sleep_stage&#39; and calculate mean and standard deviation separately</span>
    <span class="n">mean_data</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;pt_id&#39;</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">])[</span><span class="n">feature_columns</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_avg&#39;</span><span class="p">)</span>
    <span class="n">std_data</span> <span class="o">=</span> <span class="n">filtered_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;pt_id&#39;</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">])[</span><span class="n">feature_columns</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="s1">&#39;_std&#39;</span><span class="p">)</span>

    <span class="c1"># Combine the mean and standard deviation DataFrames</span>
    <span class="n">grouped_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mean_data</span><span class="p">,</span> <span class="n">std_data</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Reset the index to have unique &#39;pt_id&#39; on each row</span>
    <span class="n">grouped_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">grouped_data</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s1">&#39;Results_REM.xlsx&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># endregion REM only</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="c1"># region Main</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># Get the current script directory</span>
    <span class="n">current_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="c1"># Combine the current directory with the filename</span>
    <span class="n">features_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_dir</span><span class="p">,</span> <span class="n">features_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ToDoStats</span><span class="p">:</span>
        <span class="n">do_stats</span><span class="p">(</span><span class="n">features_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">this_patient_first_row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fsamp</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># Sampling rate by default</span>
        <span class="n">columns_of_the_results</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pt_id&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;sleep_stage&#39;</span><span class="p">,</span> <span class="s1">&#39;data_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">]</span> \

        <span class="c1"># Define how to extract EEG features</span>
        <span class="n">FeatureExtractor</span> <span class="o">=</span> <span class="n">SleepSpectralFeatureExtractor</span><span class="p">(</span>
            <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">,</span>
            <span class="n">segm_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">fbands</span><span class="o">=</span><span class="p">[[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">3.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mf">7.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mf">11.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mf">15.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mf">29.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">35</span><span class="p">]],</span>
            <span class="n">datarate</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">FeatureExtractor</span><span class="o">.</span><span class="n">_extraction_functions</span> <span class="o">=</span> \
            <span class="p">[</span>
                <span class="n">mean_frequency</span><span class="p">,</span> <span class="n">median_frequency</span><span class="p">,</span> <span class="n">mean_bands</span><span class="p">,</span> <span class="n">relative_bands</span>
            <span class="p">]</span>

        <span class="c1"># Populate the list of features to calculate</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">features</span><span class="p">,</span> <span class="n">feature_names</span> <span class="o">=</span> <span class="n">FeatureExtractor</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">200</span><span class="p">)])</span>  <span class="c1"># Get the list of features that we will calculate</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">columns_of_the_results</span> <span class="o">=</span> <span class="n">columns_of_the_results</span> <span class="o">+</span> <span class="n">feature_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;delta_slope&#39;</span><span class="p">,</span> <span class="s1">&#39;delta_pk2pk&#39;</span><span class="p">,</span> <span class="s1">&#39;slow_delta_slope&#39;</span><span class="p">,</span>
                                                                           <span class="s1">&#39;slow_delta_pk2pk&#39;</span><span class="p">]</span>  <span class="c1"># merge both lists</span>
        <span class="c1"># Initialize the results dataframe</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="n">columns</span><span class="o">=</span><span class="n">columns_of_the_results</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading the data file: &#39;</span><span class="p">)</span>
        <span class="n">this_patient_first_row</span> <span class="o">=</span> <span class="n">count</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="c1"># Dummy start time of the recording</span>

        <span class="c1"># Re-define how to extract EEG features in case fsamp is different</span>
        <span class="n">FeatureExtractor</span> <span class="o">=</span> <span class="n">SleepSpectralFeatureExtractor</span><span class="p">(</span>
            <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">,</span>
            <span class="n">segm_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
            <span class="n">fbands</span><span class="o">=</span><span class="p">[[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">3.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mf">7.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mf">11.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mf">15.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mf">29.9</span><span class="p">],</span> <span class="p">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">35</span><span class="p">]],</span>
            <span class="n">datarate</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">FeatureExtractor</span><span class="o">.</span><span class="n">_extraction_functions</span> <span class="o">=</span> \
            <span class="p">[</span>
                <span class="n">mean_frequency</span><span class="p">,</span> <span class="n">median_frequency</span><span class="p">,</span> <span class="n">mean_bands</span><span class="p">,</span> <span class="n">relative_bands</span>
            <span class="p">]</span>

        <span class="c1"># region Save the data to a mat file for debugging and preparing the data</span>
        <span class="c1"># from scipy.io import loadmat</span>
        <span class="c1">#</span>
        <span class="c1"># data = {</span>
        <span class="c1">#     &#39;fzcz&#39;: fzcz,</span>
        <span class="c1">#     &#39;patient_id&#39;: 1,</span>
        <span class="c1">#     &#39;data_present&#39;: data_present,</span>
        <span class="c1">#     &#39;hypnogram&#39;: hypnogram,</span>
        <span class="c1">#     &#39;fs_hypno&#39;: fs_hypno,</span>
        <span class="c1">#     &#39;fsamp&#39;: fsamp,</span>
        <span class="c1"># }</span>
        <span class="c1"># filename = f&#39;patient_one_data.pkl&#39;</span>
        <span class="c1"># savemat(DATA_PATH, data, do_compression=True)</span>
        <span class="c1"># endregion Save the data to a mat file</span>

        <span class="c1"># region Load the data from a mat file</span>
        <span class="c1"># Construct the filename with the epoch number</span>

        <span class="c1"># Load the data from the file</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">loadmat</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">)</span>
        <span class="c1"># Extract the variables</span>
        <span class="n">fzcz</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fzcz&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">patient_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;patient_id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data_present</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data_present&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hypnogram</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;hypnogram&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fs_hypno</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fs_hypno&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fsamp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fsamp&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># endregion Load the data from a pickle file</span>

        <span class="c1"># region Filtering the signal</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Filtering signal...&#39;</span><span class="p">)</span>

        <span class="c1"># Design good steep filter parameters from 0.5 - 35Hz</span>
        <span class="n">numtaps</span> <span class="o">=</span> <span class="mi">1999</span>
        <span class="n">cutoff_low</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Lower cutoff frequency in Hz</span>
        <span class="n">cutoff_high</span> <span class="o">=</span> <span class="mi">35</span>  <span class="c1"># Upper cutoff frequency in Hz</span>
        <span class="n">window</span> <span class="o">=</span> <span class="s1">&#39;hamming&#39;</span>  <span class="c1"># You can try other window functions as well</span>
        <span class="n">nyquist_freq</span> <span class="o">=</span> <span class="n">fsamp</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># Nyquist frequency in Hz (half of the sampling rate)</span>

        <span class="c1"># Compute the filter coefficients for bandpass filter</span>
        <span class="n">fir_coeff</span> <span class="o">=</span> <span class="n">firwin</span><span class="p">(</span><span class="n">numtaps</span><span class="p">,</span> <span class="p">[</span><span class="n">cutoff_low</span><span class="p">,</span> <span class="n">cutoff_high</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">pass_zero</span><span class="o">=</span><span class="s1">&#39;bandpass&#39;</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">)</span>

        <span class="c1"># Compute the frequency response of the filter</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">freqz</span><span class="p">(</span><span class="n">fir_coeff</span><span class="p">,</span> <span class="n">worN</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span>

        <span class="c1"># region Check filter design</span>
        <span class="c1"># Plot the magnitude response</span>
        <span class="c1"># plt.figure()</span>
        <span class="c1"># plt.plot(nyquist_freq * w / np.pi, np.abs(h), &#39;b&#39;)</span>
        <span class="c1"># plt.xlim(0, 40)</span>
        <span class="c1"># plt.xlabel(&#39;Frequency (Hz)&#39;)</span>
        <span class="c1"># plt.ylabel(&#39;Magnitude&#39;)</span>
        <span class="c1"># plt.title(&#39;Frequency Response of Bandpass FIR Filter&#39;)</span>
        <span class="c1"># plt.grid()</span>
        <span class="c1"># plt.show()</span>
        <span class="c1"># endregion Check filter design</span>

        <span class="c1"># Filter the signal into 0.05-35 Hz band</span>
        <span class="c1"># fzcz = butt_filter(fzcz, fsamp, lowcut=0.05, highcut=50, order=8, type=&#39;lowpass&#39;)</span>
        <span class="c1"># fzcz_01 = butt_filter(fzcz, fsamp, lowcut=0.1, highcut=2, order=8, type=&#39;bandpass&#39;)</span>
        <span class="c1"># fzcz = firwin_bandpass_filter(fzcz, fsamp, lowcut=0.05, highcut=50, order=1000)</span>
        <span class="n">fzcz_orig</span> <span class="o">=</span> <span class="n">fzcz</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Save the original signal</span>

        <span class="c1"># Pad the input signal at the front and back</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fir_coeff</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">fzcz_orig_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">fzcz_orig</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
        <span class="c1"># Apply filter to the padded signal</span>
        <span class="n">fzcz_padded</span> <span class="o">=</span> <span class="n">lfilter</span><span class="p">(</span><span class="n">fir_coeff</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">fzcz_orig_padded</span><span class="p">)</span>
        <span class="c1"># Remove the padded zeros at the beginning and end to match with the length of the original signal</span>
        <span class="n">fzcz</span> <span class="o">=</span> <span class="n">fzcz_padded</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span>

        <span class="c1"># region Check filtering</span>
        <span class="c1"># # Compute the FFT of the signal &#39;fzcz&#39;</span>
        <span class="c1"># fft_fzcz = np.fft.fft(fzcz)</span>
        <span class="c1">#</span>
        <span class="c1"># # Calculate the corresponding frequencies</span>
        <span class="c1"># n = len(fft_fzcz)  # Number of data points in the FFT</span>
        <span class="c1"># freq = np.fft.fftfreq(n, d=1 / fsamp)</span>
        <span class="c1">#</span>
        <span class="c1"># # Take the absolute value of the complex FFT result to get the magnitude spectrum</span>
        <span class="c1"># magnitude_spectrum = np.abs(fft_fzcz)</span>
        <span class="c1">#</span>
        <span class="c1"># # Plot the magnitude spectrum</span>
        <span class="c1"># plt.figure()</span>
        <span class="c1"># plt.plot(freq, magnitude_spectrum)</span>
        <span class="c1"># plt.xlim(0, 2)</span>
        <span class="c1"># plt.xlabel(&#39;Frequency (Hz)&#39;)</span>
        <span class="c1"># plt.ylabel(&#39;Magnitude&#39;)</span>
        <span class="c1"># plt.title(&#39;FFT of Signal fzcz&#39;)</span>
        <span class="c1"># plt.grid()</span>
        <span class="c1"># plt.show()</span>
        <span class="c1"># endregion Check filtering</span>

        <span class="c1"># Design good steep filter parameters from 0.5 - 0.9Hz - Not used here</span>
        <span class="c1">#numtaps = 19999  # 4999</span>
        <span class="c1"># *New for bypassing the 0.5-0.9Hz filter by faster speed -&gt; don&#39;t use this filter</span>
        <span class="n">numtaps</span> <span class="o">=</span> <span class="mi">99</span>  <span class="c1"># Should be for a good filter: 4999. Not used here now so it is 99 for faster processing</span>
        <span class="n">cutoff_low</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Lower cutoff frequency in Hz</span>
        <span class="n">cutoff_high</span> <span class="o">=</span> <span class="mf">0.9</span>  <span class="c1"># Upper cutoff frequency in Hz</span>
        <span class="n">window</span> <span class="o">=</span> <span class="s1">&#39;hamming&#39;</span>  <span class="c1"># You can try other window functions as well</span>

        <span class="c1"># Compute the filter coefficients for bandpass filter</span>
        <span class="n">fir_coeff</span> <span class="o">=</span> <span class="n">firwin</span><span class="p">(</span><span class="n">numtaps</span><span class="p">,</span> <span class="p">[</span><span class="n">cutoff_low</span><span class="p">,</span> <span class="n">cutoff_high</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">pass_zero</span><span class="o">=</span><span class="s1">&#39;bandpass&#39;</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">)</span>

        <span class="c1"># Compute the frequency response of the filter</span>
        <span class="c1"># w, h = freqz(fir_coeff, worN=8000)</span>

        <span class="c1"># region Check filter design</span>
        <span class="c1"># Plot the magnitude response</span>
        <span class="c1"># plt.figure()</span>
        <span class="c1"># plt.plot(nyquist_freq * w / np.pi, np.abs(h), &#39;b&#39;)</span>
        <span class="c1"># plt.xlim(0, 2)</span>
        <span class="c1"># plt.xlabel(&#39;Frequency (Hz)&#39;)</span>
        <span class="c1"># plt.ylabel(&#39;Magnitude&#39;)</span>
        <span class="c1"># plt.title(&#39;Frequency Response of Bandpass FIR Filter&#39;)</span>
        <span class="c1"># plt.grid()</span>
        <span class="c1"># plt.show()</span>
        <span class="c1"># endregion Check filter design</span>

        <span class="c1"># Pad the input signal at the front and back</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fir_coeff</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">fzcz_orig_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">fzcz_orig</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
        <span class="c1"># Apply filter to the padded signal</span>
        <span class="n">fzcz_01_padded</span> <span class="o">=</span> <span class="n">lfilter</span><span class="p">(</span><span class="n">fir_coeff</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">fzcz_orig_padded</span><span class="p">)</span>
        <span class="c1"># Remove the padded zeros at the beginning and end to match with the length of the original signal</span>
        <span class="n">fzcz_01</span> <span class="o">=</span> <span class="n">fzcz_01_padded</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span>


        <span class="c1"># # Design good steep filter parameters from 1 - 3.9Hz</span>
        <span class="n">numtaps</span> <span class="o">=</span> <span class="mi">9999</span>  <span class="c1"># For steep filter use 9999</span>
        <span class="n">cutoff_low</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Lower cutoff frequency in Hz</span>
        <span class="n">cutoff_high</span> <span class="o">=</span> <span class="mf">3.9</span>  <span class="c1"># Upper cutoff frequency in Hz</span>
        <span class="n">window</span> <span class="o">=</span> <span class="s1">&#39;hamming&#39;</span>  <span class="c1"># You can try other window functions as well</span>

        <span class="c1"># Compute the filter coefficients for bandpass filter</span>
        <span class="n">fir_coeff</span> <span class="o">=</span> <span class="n">firwin</span><span class="p">(</span><span class="n">numtaps</span><span class="p">,</span> <span class="p">[</span><span class="n">cutoff_low</span><span class="p">,</span> <span class="n">cutoff_high</span><span class="p">],</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">pass_zero</span><span class="o">=</span><span class="s1">&#39;bandpass&#39;</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">)</span>

        <span class="c1"># region Check filter design</span>
        <span class="c1"># Compute the frequency response of the filter</span>
        <span class="c1"># w, h = freqz(fir_coeff, worN=8000)</span>
        <span class="c1">#</span>
        <span class="c1"># # region Check filter design</span>
        <span class="c1"># # Plot the magnitude response</span>
        <span class="c1"># plt.figure()</span>
        <span class="c1"># plt.plot(nyquist_freq * w / np.pi, np.abs(h), &#39;b&#39;)</span>
        <span class="c1"># plt.xlim(0, 5)</span>
        <span class="c1"># plt.xlabel(&#39;Frequency (Hz)&#39;)</span>
        <span class="c1"># plt.ylabel(&#39;Magnitude&#39;)</span>
        <span class="c1"># plt.title(&#39;Frequency Response of Bandpass FIR Filter&#39;)</span>
        <span class="c1"># plt.grid()</span>
        <span class="c1"># plt.show()</span>
        <span class="c1"># endregion Check filter design</span>

        <span class="c1"># Filter the signal into 1-3.9 Hz band</span>
        <span class="c1"># Pad the input signal at the front and back</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fir_coeff</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">fzcz_orig_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">fzcz_orig</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
        <span class="c1"># Apply filter to the padded signal</span>
        <span class="n">fzcz_02_padded</span> <span class="o">=</span> <span class="n">lfilter</span><span class="p">(</span><span class="n">fir_coeff</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">fzcz_orig_padded</span><span class="p">)</span>
        <span class="c1">#fzcz = lfilter(fir_coeff, 1.0, fzcz_orig_padded)</span>
        <span class="c1"># Remove the padded zeros at the beginning and end to match with the length of the original signal</span>
        <span class="n">fzcz_02</span> <span class="o">=</span> <span class="n">fzcz_02_padded</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span>

        <span class="c1"># region Check filtering</span>
        <span class="c1"># # Compute the FFT of the signal &#39;fzcz&#39;</span>
        <span class="c1"># fft_fzcz = np.fft.fft(fzcz_01)</span>
        <span class="c1">#</span>
        <span class="c1"># # Calculate the corresponding frequencies</span>
        <span class="c1"># n = len(fft_fzcz)  # Number of data points in the FFT</span>
        <span class="c1"># freq = np.fft.fftfreq(n, d=1 / fsamp)</span>
        <span class="c1">#</span>
        <span class="c1"># # Take the absolute value of the complex FFT result to get the magnitude spectrum</span>
        <span class="c1"># magnitude_spectrum = np.abs(fft_fzcz)</span>
        <span class="c1">#</span>
        <span class="c1"># # Plot the magnitude spectrum</span>
        <span class="c1"># plt.figure()</span>
        <span class="c1"># plt.plot(freq, magnitude_spectrum)</span>
        <span class="c1"># plt.xlim(0, 2)</span>
        <span class="c1"># plt.xlabel(&#39;Frequency (Hz)&#39;)</span>
        <span class="c1"># plt.ylabel(&#39;Magnitude&#39;)</span>
        <span class="c1"># plt.title(&#39;FFT of Signal fzcz&#39;)</span>
        <span class="c1"># plt.grid()</span>
        <span class="c1"># plt.show()</span>
        <span class="c1"># endregion Check filtering</span>
        <span class="c1"># endregion Filtering the signal</span>

        <span class="c1"># Buffer the data to 30 sec epochs and process it sequentially epoch by epoch</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">fzcz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">fsamp</span><span class="p">)</span>  <span class="c1"># Create a time vector for the signal</span>
        <span class="n">xo</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">(</span><span class="n">fzcz_orig</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">,</span> <span class="n">segm_size</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># Buffer the data to 30 sec epochs</span>
        <span class="n">xb</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">(</span><span class="n">fzcz</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">,</span> <span class="n">segm_size</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># Buffer the data to 30 sec epochs for 0.5-30Hz band</span>
        <span class="n">xb_01</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">(</span><span class="n">fzcz_01</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">,</span> <span class="n">segm_size</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># Buffer the data to 30 sec epochs for 0.5-0.9Hz band</span>
        <span class="n">xb_02</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">(</span><span class="n">fzcz_02</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">,</span> <span class="n">segm_size</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="c1"># Buffer the data to 30 sec epochs for 1-3.9Hz band</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fsamp</span><span class="p">,</span> <span class="n">segm_size</span><span class="o">=</span><span class="mi">30</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Buffer the time vector to 30 sec epochs</span>
        <span class="n">epoch</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Epoch counter</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Detecting wave properties at Fz-(A1+A2)/2&#39;</span><span class="p">)</span>
        <span class="c1"># region Loop over all epochs</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">x1_</span><span class="p">,</span> <span class="n">x2_</span><span class="p">,</span> <span class="n">xo_</span><span class="p">,</span><span class="n">t_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">xb_01</span><span class="p">,</span> <span class="n">xb_02</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
            <span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Increment epoch counter</span>
            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;pt_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_id</span>
            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_</span>
            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_</span> <span class="o">+</span> <span class="mi">30</span>
            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="c1"># Get hypnogram score from the middle of the 30 sec epoch</span>
            <span class="n">sleep_stage_in_epoch</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">hypnogram</span><span class="p">[</span><span class="nb">int</span><span class="p">(((</span><span class="mi">2</span> <span class="o">*</span> <span class="n">t_</span> <span class="o">+</span> <span class="mi">30</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">fs_hypno</span><span class="p">)])</span>
            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;sleep_stage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sleep_stage_in_epoch</span>  <span class="c1"># Save the sleep stage</span>
            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;data_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_present</span><span class="p">[</span>
                           <span class="nb">int</span><span class="p">(</span><span class="n">t_</span> <span class="o">*</span> <span class="n">fs_hypno</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="nb">int</span><span class="p">(((</span><span class="n">t_</span> <span class="o">+</span> <span class="mi">30</span><span class="p">)</span> <span class="o">*</span> <span class="n">fs_hypno</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
                            <span class="mi">30</span> <span class="o">*</span> <span class="n">fs_hypno</span><span class="p">))</span>  <span class="c1"># Get the data-rate</span>

            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Save the diagnostic phase flag (dummy)</span>

            <span class="c1"># region To dump epoch data for debugging purposes</span>
            <span class="c1"># import pickle</span>
            <span class="c1"># data = {</span>
            <span class="c1">#     &#39;x_&#39;: x_,</span>
            <span class="c1">#     &#39;x1_&#39;: x1_,</span>
            <span class="c1">#     &#39;x2_&#39;: x2_,</span>
            <span class="c1">#     &#39;xo_&#39;: xo_,</span>
            <span class="c1">#     &#39;t_&#39;: t_,</span>
            <span class="c1">#     &#39;fsamp&#39;: fsamp,</span>
            <span class="c1">#     &#39;epoch&#39;: epoch,</span>
            <span class="c1">#     &#39;start&#39;: t_,</span>
            <span class="c1">#     &#39;end&#39;: t_ + 30,</span>
            <span class="c1">#     &#39;sleep_stage_in_epoch&#39;: sleep_stage_in_epoch</span>
            <span class="c1"># }</span>
            <span class="c1"># filename = f&#39;data_epoch_{epoch}.pkl&#39;</span>
            <span class="c1"># with open(filename, &#39;wb&#39;) as f:</span>
            <span class="c1">#     pickle.dump(data, f)</span>
            <span class="c1"># endregion To dump epoch data for debugging purposes</span>

            <span class="c1"># region To load epoch data for debugging purposes</span>
            <span class="c1"># import pickle</span>
            <span class="c1"># # Epoch number to load</span>
            <span class="c1"># epoch_to_load = 242  # example epoch number</span>
            <span class="c1">#</span>
            <span class="c1"># # Construct the filename with the epoch number</span>
            <span class="c1"># filename = f&#39;data_epoch_{epoch_to_load}.pkl&#39;</span>
            <span class="c1">#</span>
            <span class="c1"># # Load the data from the file</span>
            <span class="c1"># with open(filename, &#39;rb&#39;) as f:</span>
            <span class="c1">#     data = pickle.load(f)</span>
            <span class="c1">#</span>
            <span class="c1"># # Extract the variables</span>
            <span class="c1"># x_ = data[&#39;x_&#39;]</span>
            <span class="c1"># x1_ = data[&#39;x1_&#39;]</span>
            <span class="c1"># x2_ = data[&#39;x2_&#39;]</span>
            <span class="c1"># xo_ = data[&#39;xo_&#39;]</span>
            <span class="c1"># t_ = data[&#39;t_&#39;]</span>
            <span class="c1"># fsamp = data[&#39;fsamp&#39;]</span>
            <span class="c1"># epoch = data[&#39;epoch&#39;]</span>
            <span class="c1"># start = data[&#39;start&#39;]</span>
            <span class="c1"># end = data[&#39;end&#39;]</span>
            <span class="c1"># sleep_stage_in_epoch = data[&#39;sleep_stage&#39;]</span>
            <span class="c1"># endregion To load epoch data for debugging purposes</span>

            <span class="n">xo__</span> <span class="o">=</span> <span class="n">xo_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">x__</span> <span class="o">=</span> <span class="n">x_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">x1__</span> <span class="o">=</span> <span class="n">x1_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">x2__</span> <span class="o">=</span> <span class="n">x2_</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">features</span><span class="p">,</span> <span class="n">feature_names</span> <span class="o">=</span> <span class="n">FeatureExtractor</span><span class="p">(</span><span class="n">x_</span><span class="p">)</span>  <span class="c1"># Get the list of features that we will calculate</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

            <span class="c1"># region Check the data before extracting the features for debugging purposes</span>
            <span class="c1"># # Create time vector</span>
            <span class="c1"># time = np.arange(x__.size) / fsamp</span>
            <span class="c1"># # Set the DPI for the plot</span>
            <span class="c1"># dpi = 300</span>
            <span class="c1"># # Calculate the width and height in inches</span>
            <span class="c1"># width = 1200 / dpi</span>
            <span class="c1"># height = 600 / dpi</span>
            <span class="c1"># # Create new figure with desired DPI and size</span>
            <span class="c1"># plt.figure(figsize=(width, height), dpi=dpi)</span>
            <span class="c1"># # Create plot</span>
            <span class="c1"># plt.plot(time, x__)</span>
            <span class="c1">#</span>
            <span class="c1"># # Set title and labels</span>
            <span class="c1"># plt.title(&#39;Finding minima and maxima of the EEG&#39;)</span>
            <span class="c1"># plt.xlabel(&#39;time (sec)&#39;)</span>
            <span class="c1"># plt.ylabel(&#39;EEG amplitude (uV)&#39;)</span>
            <span class="c1"># # Save the figure as PDF in current directory</span>
            <span class="c1"># # Get current date and time as a string</span>
            <span class="c1"># now = datetime.now()</span>
            <span class="c1"># date_time = now.strftime(&quot;%m-%d-%Y_%H-%M-%S&quot;)</span>
            <span class="c1">#</span>
            <span class="c1"># plt.show()</span>
            <span class="c1"># plt.close()</span>
            <span class="c1"># endregion Check the data before extracting the features for debugging purposes</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Extract Slow Oscillation and Delta wave properties for 0.5-3.9Hz band in this 30 sec epoch</span>
                <span class="n">sleep_stages</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;Awake&#39;</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;NREM1&#39;</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;NREM2&#39;</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;NREM3&#39;</span><span class="p">,</span>
                    <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;REM&#39;</span><span class="p">,</span>
                    <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;UNKNOWN&#39;</span>
                <span class="p">}</span>

                <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">date_time</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m-</span><span class="si">%d</span><span class="s2">-%Y_%H-%M-%S&quot;</span><span class="p">)</span>
                <span class="n">directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Results</span><span class="se">\\</span><span class="s1">1&#39;</span>

                <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">_EEG_extremes_</span><span class="si">{</span><span class="n">sleep_stages</span><span class="p">[</span><span class="n">sleep_stage_in_epoch</span><span class="p">]</span><span class="si">}</span><span class="s1">_SlowWave_</span><span class="si">{</span><span class="n">date_time</span><span class="si">}</span><span class="s1">.pdf&#39;</span>
                <span class="c1"># Detect Slow Oscillations first</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">SlowWaveDetect</span><span class="p">(</span><span class="n">x2__</span><span class="p">,</span> <span class="n">x__</span><span class="p">,</span> <span class="n">fsamp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">sleep_stages</span><span class="p">[</span><span class="n">sleep_stage_in_epoch</span><span class="p">],</span>
                                         <span class="n">epoch</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot_wave_images</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;slow_delta_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;slow_delta_pk2pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">slow_waves</span><span class="p">,</span> <span class="n">slow_wave_amplitudes</span><span class="p">,</span> <span class="n">slow_wave_slopes</span><span class="p">,</span> <span class="n">mean_amplitude</span><span class="p">,</span> <span class="n">std_amplitude</span><span class="p">,</span> <span class="n">mean_slope</span><span class="p">,</span> <span class="n">std_slope</span><span class="p">,</span> <span class="n">num_waves</span> <span class="o">=</span> <span class="n">results</span>

                    <span class="k">if</span> <span class="n">num_waves</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;slow_delta_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_slope</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;slow_delta_pk2pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_amplitude</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;slow_delta_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;slow_delta_pk2pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="se">\\</span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s1">_EEG_extremes_</span><span class="si">{</span><span class="n">sleep_stages</span><span class="p">[</span><span class="n">sleep_stage_in_epoch</span><span class="p">]</span><span class="si">}</span><span class="s1">_Delta_</span><span class="si">{</span><span class="n">date_time</span><span class="si">}</span><span class="s1">.pdf&#39;</span>
                <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># If there were no Slow Oscillations detected, then try to detect Delta waves only</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">SlowWaveDetect</span><span class="p">(</span><span class="n">x2__</span><span class="p">,</span> <span class="n">x__</span><span class="p">,</span> <span class="n">fsamp</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">sleep_stages</span><span class="p">[</span><span class="n">sleep_stage_in_epoch</span><span class="p">],</span>
                                             <span class="n">epoch</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot_wave_images</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If there were Slow Oscillations detected, then try to detect non-overlapping (500 msec distant) Delta waves</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">SlowWaveDetect</span><span class="p">(</span><span class="n">x2__</span><span class="p">,</span> <span class="n">x__</span><span class="p">,</span> <span class="n">fsamp</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">sleep_stages</span><span class="p">[</span><span class="n">sleep_stage_in_epoch</span><span class="p">],</span>
                                             <span class="n">epoch</span><span class="p">,</span> <span class="n">slow_waves</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">plot_wave_images</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;delta_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;delta_pk2pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">slow_waves</span><span class="p">,</span> <span class="n">slow_wave_amplitudes</span><span class="p">,</span> <span class="n">slow_wave_slopes</span><span class="p">,</span> <span class="n">mean_amplitude</span><span class="p">,</span> <span class="n">std_amplitude</span><span class="p">,</span> <span class="n">mean_slope</span><span class="p">,</span> <span class="n">std_slope</span><span class="p">,</span> <span class="n">num_waves</span> <span class="o">=</span> <span class="n">results</span>

                    <span class="k">if</span> <span class="n">num_waves</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;delta_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_slope</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;delta_pk2pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_amplitude</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;delta_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;delta_pk2pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;delta_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;delta_pk2pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;slow_delta_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">count</span><span class="p">,</span> <span class="s1">&#39;slow_delta_pk2pk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># endregion Loop over all epochs</span>

        <span class="c1"># region Plot the results</span>
        <span class="n">first_feat_to_plot</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">second_feat_to_plot</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">third_feat_to_plot</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fourth_feat_to_plot</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">this_patient_first_row</span><span class="p">:</span>
                <span class="n">first_feat_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">features_to_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">second_feat_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">features_to_plot</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">third_feat_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">features_to_plot</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                <span class="n">fourth_feat_to_plot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">features_to_plot</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>

        <span class="c1"># Convert lists to NumPy ndarray</span>
        <span class="n">first_feat_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">first_feat_to_plot</span><span class="p">)</span>
        <span class="n">second_feat_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">second_feat_to_plot</span><span class="p">)</span>
        <span class="n">third_feat_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">third_feat_to_plot</span><span class="p">)</span>
        <span class="n">fourth_feat_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fourth_feat_to_plot</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fzcz</span><span class="p">))</span> <span class="o">/</span> <span class="n">fsamp</span> <span class="o">/</span> <span class="mi">3600</span>  <span class="c1"># Time in hours for raw data</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_feat_to_plot</span><span class="p">))</span> <span class="o">*</span> <span class="mi">30</span> <span class="o">/</span> <span class="mi">3600</span>  <span class="c1"># Time in hours for features</span>

        <span class="c1"># Remove NaN values from the data &amp; time array</span>
        <span class="n">first_nan_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">first_feat_to_plot</span><span class="p">)</span>
        <span class="n">second_nan_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">second_feat_to_plot</span><span class="p">)</span>
        <span class="n">third_nan_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">third_feat_to_plot</span><span class="p">)</span>
        <span class="n">fourth_nan_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fourth_feat_to_plot</span><span class="p">)</span>

        <span class="n">first_feat_to_plot</span> <span class="o">=</span> <span class="n">first_feat_to_plot</span><span class="p">[</span><span class="n">first_nan_mask</span><span class="p">]</span>
        <span class="n">second_feat_to_plot</span> <span class="o">=</span> <span class="n">second_feat_to_plot</span><span class="p">[</span><span class="n">second_nan_mask</span><span class="p">]</span>
        <span class="n">third_feat_to_plot</span> <span class="o">=</span> <span class="n">third_feat_to_plot</span><span class="p">[</span><span class="n">third_nan_mask</span><span class="p">]</span>
        <span class="n">fourth_feat_to_plot</span> <span class="o">=</span> <span class="n">fourth_feat_to_plot</span><span class="p">[</span><span class="n">fourth_nan_mask</span><span class="p">]</span>

        <span class="n">times</span> <span class="o">=</span> <span class="n">tf</span>
        <span class="n">times_first</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">first_nan_mask</span><span class="p">]</span>
        <span class="n">times_second</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">second_nan_mask</span><span class="p">]</span>
        <span class="n">times_third</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">third_nan_mask</span><span class="p">]</span>
        <span class="n">times_fourth</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">fourth_nan_mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ToPlotFigures</span><span class="p">:</span>
            <span class="n">sleep_stages</span> <span class="o">=</span> <span class="p">{</span>
                <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;Awake&#39;</span><span class="p">,</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;NREM1&#39;</span><span class="p">,</span>
                <span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;NREM2&#39;</span><span class="p">,</span>
                <span class="o">-</span><span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;NREM3&#39;</span><span class="p">,</span>
                <span class="o">-</span><span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;REM&#39;</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

            <span class="n">num_intervals</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hypnogram</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">hypnogram</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hypnogram</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                <span class="n">hypnogram</span> <span class="o">=</span> <span class="n">hypnogram</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">hypnogram</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times_first</span><span class="p">,</span> <span class="n">first_feat_to_plot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times_second</span><span class="p">,</span> <span class="n">second_feat_to_plot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times_third</span><span class="p">,</span> <span class="n">third_feat_to_plot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times_fourth</span><span class="p">,</span> <span class="n">fourth_feat_to_plot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_feat_to_plot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">first_feat_to_plot</span><span class="p">,</span> <span class="mi">97</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred while setting y-limits for first_feat_to_plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">second_feat_to_plot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">second_feat_to_plot</span><span class="p">,</span> <span class="mi">97</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred while setting y-limits for second_feat_to_plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">third_feat_to_plot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">third_feat_to_plot</span><span class="p">,</span> <span class="mi">97</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred while setting y-limits for third_feat_to_plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fourth_feat_to_plot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">fourth_feat_to_plot</span><span class="p">,</span> <span class="mi">97</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred while setting y-limits for fourth_feat_to_plot: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">label_size</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">label_size</span><span class="p">)</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sleep_stages</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sleep_stages</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$uV^2 </span><span class="se">\\</span><span class="s1">times Hz^{-1}$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$uV^2 </span><span class="se">\\</span><span class="s1">times Hz^{-1}$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$uV </span><span class="se">\\</span><span class="s1">times sec^{-1}$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$uV </span><span class="se">\\</span><span class="s1">times sec^{-1}$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

            <span class="n">title_string</span> <span class="o">=</span> <span class="s1">&#39;Hypnogram - patient number: 1&#39;</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_string</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">features_to_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">features_to_plot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">features_to_plot</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">features_to_plot</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="n">nm</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Results</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;1&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">features_to_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">features_to_plot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
                 <span class="n">features_to_plot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="c1"># endregion Plot the results</span>

        <span class="c1"># Remove the file if it exists</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;Results_extraction.csv&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;Results_extraction.csv&#39;</span><span class="p">)</span>

        <span class="c1"># Save &#39;res&#39; to a CSV file</span>
        <span class="n">res</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;Results_extraction.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># endregion Loop over all files</span>

        <span class="c1"># Remove the file if it exists</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;Results_extraction.csv&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;Results_extraction.csv&#39;</span><span class="p">)</span>

        <span class="c1"># Save final &#39;res&#39; to a CSV file</span>
        <span class="n">res</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;Results_extraction.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># endregion Main</span>
</pre></div>
</div>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">BrainMaze - EEG</p>
      </div>
    </a>
    <a class="right-next"
       href="classifiers.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Classifiers</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#project-eeg-slow-wave-detection-and-analysis">Project: EEG Slow Wave Detection and Analysis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#acknowledgement">Acknowledgement</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#version">Version</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examples">Examples</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#code">Code</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Filip Mivalt M.Sc., Ph.D.
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2020-present, Mayo Clinic Department of Neurology - Laboratory of Bioelectronics Neurophysiology and Engineering. All rights reserved.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>