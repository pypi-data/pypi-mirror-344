<!DOCTYPE html>
<html>
  <head>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta charset="UTF-8">
    <title>Map Viewer</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var map;
      var qtMapViewer;

      new QWebChannel(qt.webChannelTransport, (channel) => {
        qtMapViewer = channel.objects.qtMapViewer;
        qtMapViewer.getApiKey(); // Request API key from PyQt6
      });

      function notifyMapReady() {
        if (qtMapViewer && qtMapViewer.on_map_ready) {
            qtMapViewer.on_map_ready();
        }
    }

      async function initMap() {
        console.log("Initializing Map...");
        await qtMapViewer.log("Initializing Map...");
        const { Map } = await google.maps.importLibrary("maps");
        const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

         let mapOptions = {
            center: { lat: -34.397, lng: 150.644 },
            zoom: 12,
            mapTypeId: "satellite",
            tilt: 45,
            heading: 90,
            mapId: "GPR_STUDIO_MAP_VIEWER",
            streetViewControl: true, // Enable Street View control
        };
        map = new Map(document.getElementById("map"), mapOptions);
        google.maps.event.addListenerOnce(map, 'tilesloaded', () => {
            notifyMapReady();
        });
      }

      function loadGoogleMaps(apiKey) {
          const script = document.createElement('script');
          script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap&v=weekly&libraries=marker&loading=async`; // Replace YOUR_API_KEY
          script.async = true;
          script.defer = true;
          script.onerror = function() {
            console.error('Failed to load Google Maps API.');
          };
        document.head.appendChild(script);
     }

      function gmap_setCenter(lat, lng) {
        if(map) {
            map.setCenter(new google.maps.LatLng(lat, lng));
        }
      }

      function gmap_setZoom(zoom) {
        if(map) {
            map.setZoom(zoom);
        }
      }

      async function gmap_addMarker(markerProperties, centerToMarker = false) {
        const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
          const marker = new AdvancedMarkerElement({
              map,
            ...markerProperties
          });
          if (centerToMarker) {
            const { lat, lng } = markerProperties.position;
            const newCenter = new google.maps.LatLng(lat, lng);
              map.panTo(newCenter);
          }
      }
      async function gmap_addPolyline(polylineProperties, centerToPolyline = false) {
          let polyline = new google.maps.Polyline(polylineProperties);
          polyline.setMap(map);
          if(centerToPolyline) {
              map.panTo(polyline.getPath().getAt(0));
          }
      }

    </script>
  </body>
</html>
