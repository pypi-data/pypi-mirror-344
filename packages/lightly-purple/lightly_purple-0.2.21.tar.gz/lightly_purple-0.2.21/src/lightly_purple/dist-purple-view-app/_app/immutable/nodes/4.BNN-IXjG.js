import{c as ot,a as _,t as y,n as xt}from"../chunks/C1951IdI.js";import{a as B,i as T,c as dt,d as k,b as St,p as kt}from"../chunks/OpdB38Ru.js";import{p as _t,y as ht,z as yt,q as H,e as pt,f as st,a as vt,v as S,j as e,c as j,l as b,r as z,s as gt,t as D}from"../chunks/CdjFANdp.js";import{f as rt,g as At,h as It,b as O,c as ut,u as Lt}from"../chunks/8eNpkxEe.js";import{u as Ct}from"../chunks/DP8I5Y6A.js";import{r as Ht}from"../chunks/Cbydd1_z.js";import{c as jt,P as zt}from"../chunks/BBLiiV7J.js";import{G as Ft}from"../chunks/ryjTVRkZ.js";import{a as Gt,g as W,u as Mt}from"../chunks/HhvvIgyN.js";import"../chunks/DZOxPCae.js";import{a as Et,S as Rt}from"../chunks/DXC1p2cl.js";const Vt=async({dataset_id:p,offset:t=0,limit:l=10,annotation_label_ids:A,tag_ids:h})=>{const v={data:[],error:void 0};try{const r=await jt.GET("/api/datasets/{dataset_id}/annotations",{params:{path:{dataset_id:p},query:{annotation_label_ids:A,tag_ids:h,offset:t,limit:l}}});if(r.error)throw new Error(JSON.stringify(r.error,null,2));if(!r.data)throw new Error("No data");v.data=r.data}catch(r){v.error="Error loading annotations: "+String(r)}return v};var Pt=y('<div><div class="absolute right-7 top-1 z-10"><!></div> <a class="block"><!></a></div>'),Wt=y('<div slot="noMore"></div>'),Dt=y('<div slot="noResults"></div>'),Ot=y('<div class="viewport flex-1 svelte-1ppli2f"><!></div>'),Bt=y('<div class="flex h-full w-full items-center justify-center"><div>Loading grid...</div></div>');function Tt(p,t){_t(t,!0);const[l,A]=dt(),h=()=>k(X,"$infiniteLoaderIdentifier",l),v=()=>k(t.selectedAnnotationFilterIds,"$selectedAnnotationFilterIds",l),r=()=>k(g,"$tagsSelected",l),I=()=>k(u,"$pickedAnnotationIds",l),{tagsSelected:g}=Ct({dataset_id:t.dataset_id,kind:["annotation"]}),{getDatasetVersion:F}=rt();let U=H(""),q=H(!1);ht(async()=>{S(U,B(await F(t.dataset_id))),S(q,!0)});let X=yt([t.selectedAnnotationFilterIds,g],([c,i])=>c.join(",")+Array.from(i).join(",")),w=H(0);const G=100;let n=H(B([])),R=H(null);pt(()=>{h(),S(n,B([])),S(w,0)});async function Y({detail:{loaded:c,complete:i}}){const L=await Vt({dataset_id:t.dataset_id,limit:G,offset:e(w),annotation_label_ids:v().length>0?v():void 0,tag_ids:r().size>0?Array.from(r()):void 0});L.data.length?(S(w,e(w)+G),e(n).push(...L.data),L.data.length<G?i():c()):i()}const{selectedSampleAnnotationCropIds:u,toggleSampleAnnotationCropSelection:K}=rt(),M=16,Q=At(),[V,lt]=Q;var N=ot(),x=st(N);{var Z=c=>{var i=Ot(),L=j(i);const tt=b(()=>t.itemHeight+M),et=b(()=>t.itemWidth+M),a=b(()=>{var d;return((d=e(R))==null?void 0:d.clientHeight)||0});Ft(L,{get itemCount(){return e(n).length},get itemHeight(){return e(tt)},get itemWidth(){return e(et)},get height(){return e(a)},class:"overflow-none overflow-y-auto dark:[color-scheme:dark]",get style(){return`--sample-width: ${t.itemWidth??""}px; --sample-height: ${t.itemHeight??""}px;`},item:(P,o)=>{let s=()=>o==null?void 0:o().index,m=()=>o==null?void 0:o().style;var J=ot(),at=st(J);{var C=f=>{var E=Pt(),nt=j(E),ft=j(nt);const mt=b(()=>I().has(e(n)[s()].annotation_id));Et(ft,{onSelect:()=>K(e(n)[s()].annotation_id),get isSelected(){return e(mt)}}),z(nt);var it=gt(nt,2),bt=j(it);Xt(bt,{get annotation(){return e(n)[s()]},get width(){return t.itemWidth},get height(){return t.itemHeight},get cachedDatasetVersion(){return e(U)}}),z(it),z(E),D(wt=>{O(E,m()),ut(it,"href",wt)},[()=>V(Ht.toSampleWithAnnotation(e(n)[s()].sample.sample_id,e(n)[s()].annotation_id),void 0)]),_(f,E)};T(at,f=>{e(n)[s()]&&e(n)[s()].sample&&f(C)})}_(P,J)},footer:P=>{It(P,{get identifier(){return h()},$$events:{infinite:Y},$$slots:{noMore:(o,s)=>{var m=Wt();_(o,m)},noResults:(o,s)=>{var m=Dt();_(o,m)}}})},$$slots:{item:!0,footer:!0}}),z(i),St(i,d=>S(R,d),()=>e(R)),_(c,i)},$=c=>{var i=Bt();_(c,i)};T(x,c=>{e(q)?c(Z):c($,!1)})}_(p,N),vt(),A()}var Ut=xt("<svg><!></svg>"),qt=y('<div class="annotation-box svelte-1pj3t6a"><div class="annotation-label text-sm text-white svelte-1pj3t6a"></div> <!></div>'),Nt=y('<div class="crop rounded-lg bg-black svelte-1pj3t6a"><!></div>'),Jt=y('<div class="crop flex items-center justify-center rounded-lg bg-black svelte-1pj3t6a"><div class="text-xs text-gray-400">Loading...</div></div>');function Xt(p,t){_t(t,!0);const[l,A]=dt(),h=()=>k(X,"$customLabelColorsStore",l),v=()=>k(lt,"$taskMap",l),r=()=>k(q,"$isHidden",l);let I=kt(t,"cachedDatasetVersion",3,"");const g=20,F=t.annotation.sample,{getDatasetVersion:U}=rt(),{isHidden:q}=Gt(),{customLabelColorsStore:X}=Mt();let w=H(B(I())),G=H(!!I());ht(async()=>{!I()&&t.annotation.annotation_id&&(S(w,B(await U(t.annotation.annotation_id.split("-")[0]))),S(G,!0))});function n(){return Math.min(t.width/(t.annotation.width+g*2),t.height/(t.annotation.height+g*2))}function R(){const a=n();return-(t.annotation.x-g)*a+(t.width-(t.annotation.width+g*2)*a)/2}function Y(){const a=n();return-(t.annotation.y-g)*a+(t.height-(t.annotation.height+g*2)*a)/2}let u=t.annotation.annotation_label.annotation_label_name;const K=b(()=>{var a;return((a=h()[u])==null?void 0:a.color)??W(u,1).color}),M=b(()=>{var a;return(a=h()[u])==null||a.color,W(u,.4).color}),Q=b(()=>{var a;return((a=h()[u])==null?void 0:a.alpha)??.4}),V=!!t.annotation.segmentation__binary_mask__rle_row_wise,{taskMap:lt}=Lt(),N=b(()=>t.annotation.annotation_task_id&&v().has(t.annotation.annotation_task_id)?v().get(t.annotation.annotation_task_id).is_prediction:!1),x=n(),Z=R(),$=Y(),c=b(()=>`${zt+encodeURIComponent(F.file_path_abs)}${e(w)?`?v=${e(w)}`:""}`);var i=ot(),L=st(i);{var tt=a=>{var d=Nt(),ct=j(d);{var P=o=>{var s=qt(),m=j(s);m.textContent=u;var J=gt(m,2);{var at=C=>{var f=Ut(),E=j(f);Rt(E,{get segmentation(){return t.annotation.segmentation__binary_mask__rle_row_wise},get width(){return F.width},get colorFill(){return e(M)},get opacity(){return e(Q)}}),z(f),D(()=>ut(f,"viewBox",`${t.annotation.x} ${t.annotation.y} ${t.annotation.width} ${t.annotation.height}`)),_(C,f)};T(J,C=>{V&&C(at)})}z(s),D((C,f)=>{O(s,C),O(m,f)},[()=>`
                left: ${(t.width-t.annotation.width*x)/2}px;
                top: ${(t.height-t.annotation.height*x)/2}px;
                width: ${t.annotation.width*x}px;
                height: ${t.annotation.height*x}px;
                border-color: ${V?"transparent":e(K)??W(u).color};
                background-color: ${V?"transparent":e(M)??W(u,.4).color};
                border-style: ${e(N)?"dashed":"solid"};
                
            `,()=>`background-color: ${e(M)??W(u,.4).color};`]),_(o,s)};T(ct,o=>{r()||o(P)})}z(d),D(()=>O(d,`
        width: ${t.width}px;
        height: ${t.height}px;
        background-image: url("${e(c)}");
        background-position: ${Z}px ${$}px;
        background-size: ${F.width*x}px ${F.height*x}px;
        background-repeat: no-repeat;
    `)),_(a,d)},et=a=>{var d=Jt();D(()=>O(d,`width: ${t.width}px; height: ${t.height}px;`)),_(a,d)};T(L,a=>{e(G)?a(tt):a(et,!1)})}_(p,i),vt(),A()}function se(p,t){const[l,A]=dt(),h=()=>k(g,"$boundedSampleSize",l),{datasetId:v,sampleSize:r,selectedAnnotationFilterIds:I}=t.data,g=r.sampleSize;Tt(p,{get itemHeight(){return h().height},get itemWidth(){return h().width},dataset_id:v,selectedAnnotationFilterIds:I}),A()}export{se as component};
