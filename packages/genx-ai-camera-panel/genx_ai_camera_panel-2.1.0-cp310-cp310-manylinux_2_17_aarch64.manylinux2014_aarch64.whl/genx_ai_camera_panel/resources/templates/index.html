<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GenX AI Camera Panel</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/bootstrap-icons.min.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/dataTables.bootstrap5.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/responsive.bootstrap5.css') }}" rel="stylesheet" />
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
        }

        body {
            background-color: #f8f9fc;
        }

        .navbar {
            background: linear-gradient(135deg,
                    var(--primary-color),
                    #224abe);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .stats-card {
            background: linear-gradient(45deg, #4e73df, #224abe);
            color: white;
        }

        .btn-custom {
            border-radius: 10px;
            padding: 8px 20px;
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .dashboard-header {
            padding: 2rem 0;
            background: white;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e3e6f0;
        }

        .stat-icon {
            font-size: 2rem;
            opacity: 0.8;
        }

        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        .table thead {
            background-color: var(--primary-color);
            color: white;
        }

        .table>tbody>tr>td {
            vertical-align: middle;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .camera-stream-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
            overflow: hidden;
        }

        .iframe-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>

<body>
    <div class="container-fluid mt-4">
        <h2 class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mx-2">
            <label for="" class="mb-3 mb-md-0" style="user-select: none">
                <span class="text-danger h1 fw-bold">GenX</span>
                <span class="h6">Camera Panel</span>
            </label>
            <div class="btn-group">
                <form id="streamingMethodForm" action="/streaming-method" method="POST" style="display: inline;">
                    <select class="form-select form-select-sm rounded me-2" id="streamingMethod" name="streamingMethod"
                        style="width: auto;" title="Streaming Method" onchange="this.form.submit()">
                        <option value="ffmpeg" {% if not streaming_method or streaming_method=='ffmpeg' %}selected{%
                            endif %}>FFMPEG</option>
                        <option value="tunnel" {% if streaming_method=='tunnel' %}selected{% endif %}>Tunnel</option>
                    </select>
                </form> <button class="btn btn-secondary btn-sm rounded me-2" id="viewToggle">
                    <i class="bi-grid" id="viewToggleIcon"></i>
                    <span id="viewToggleText">Grid View</span>
                </button>
                <a href="/camera/export" class="btn btn-warning btn-sm rounded me-2">
                    <i class="bi-save me-1 cursor-pointer"></i>
                    Export
                </a>
                <button class="btn btn-primary btn-sm rounded me-2" data-bs-toggle="modal" data-bs-target="#scanModal">
                    <i class="bi-camera me-1 cursor-pointer"></i>
                    Scan
                </button>
                <a href="/logout" class="btn btn-danger btn-sm rounded">
                    <i class="bi-box-arrow-right me-1 cursor-pointer"></i>
                    Logout
                </a>
            </div>
        </h2>
        <div class="btn-group mt-4 flex-wrap" id="selectionBtnGroup">
            <button class="btn btn-success btn-sm rounded me-2 mb-2" id="btnPublishSelected"
                title="Publish selected cameras">
                <i class="bi-play-circle me-1 cursor-pointer"></i>
                Publish
            </button>
            <button class="btn btn-danger btn-sm rounded me-2 mb-2" id="btnStopSelected" title="Stop selected cameras">
                <i class="bi-stop-circle me-1 cursor-pointer"></i>
                Stop
            </button>
            <button class="btn btn-warning btn-sm rounded me-2 mb-2" id="btnDeleteSelected"
                title="Delete selected cameras">
                <i class="bi-trash me-1 cursor-pointer"></i>
                Delete
            </button>
            <button class="btn btn-primary btn-sm rounded me-2 mb-2" data-bs-toggle="modal" data-bs-target="#editModal"
                title="Edit selected cameras">
                <i class="bi-pencil me-1 cursor-pointer"></i>
                Edit
            </button>
        </div>

        <table class="table table-hover table-responsive nowrap" id="cameraTable" style="width: 100%">
            <thead>
                <tr>
                    <th data-dt-order="disable">
                        <input type="checkbox" class="form-check-input ms-3" id="checkAll" />
                    </th>
                    <th>Id</th>
                    <th searchable>Hostname</th>
                    <th searchable>IP Address</th>
                    <th searchable>Port</th>
                    <th searchable>Username</th>
                    <th searchable>Profile Token</th>
                    <th searchable>Manufacturer</th>
                    <th searchable>Model</th>
                    <th searchable>Firmware Version</th>
                    <th searchable>Serial Number</th>
                    <th searchable>Hardware ID</th>
                    <th searchable>Resolution</th>
                    <th searchable>FPS</th>
                    <th searchable>Bitrate</th>
                    <th searchable>Encoding</th>
                    <th searchable>Stream URL</th>
                    <th searchable>Remote Stream URL</th>
                    <th searchable>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for camera in cameras %}
                {% set local_stream_url = get_rtsp_url(camera, 'local') %}
                {% set remote_stream_url = get_rtsp_url(camera, 'remote') %}
                {% set _, remote_port = tunnel_helper.parse_address(remote_stream_url) %}
                {% set status = ffmpeg_helper.check_stream_status(remote_stream_url) if streaming_method == 'ffmpeg'
                else tunnel_helper.check_tunnel_status(remote_port) if remote_stream_url else None %}
                <tr>
                    <td>
                        <input type="checkbox" class="checkRow form-check-input"
                            data-id="{{ camera[CameraTableIndex.ID] }}" onclick="event.stopPropagation();" />
                    </td>
                    <td>{{ camera[CameraTableIndex.ID] }}</td>
                    <td>{{ camera[CameraTableIndex.HOSTNAME] }}</td>
                    <td>{{ camera[CameraTableIndex.IP_ADDRESS] }}</td>
                    <td>{{ camera[CameraTableIndex.PORT_NUMBER] }}</td>
                    <td>{{ camera[CameraTableIndex.USERNAME] }}</td>
                    <td>{{ camera[CameraTableIndex.PROFILE_TOKEN] }}</td>
                    <td>{{ camera[CameraTableIndex.MANUFACTURER] }}</td>
                    <td>{{ camera[CameraTableIndex.MODEL] }}</td>
                    <td>{{ camera[CameraTableIndex.FIRMWARE_VERSION] }}</td>
                    <td>{{ camera[CameraTableIndex.SERIAL_NUMBER] }}</td>
                    <td>{{ camera[CameraTableIndex.HARDWARE_ID] }}</td>
                    <td>{{ camera[CameraTableIndex.RESOLUTION] }}</td>
                    <td>{{ camera[CameraTableIndex.FPS] }}</td>
                    <td>{{ camera[CameraTableIndex.BITRATE] }}</td>
                    <td>{{ camera[CameraTableIndex.ENCODING] }}</td>
                    <td>
                        <a href="{{ local_stream_url }}" title="{{ local_stream_url }}" target="_blank">Link</a>
                        <i class="bi-link-45deg ms-1 cursor-pointer fs-5 btnLinkCamera" data-bs-toggle="modal"
                            data-bs-target="#linkCameraModal" data-id="{{ camera[CameraTableIndex.ID] }}"
                            data-link-type="local" title="Link Local Camera" tabindex="" role="button"></i>
                        <i class="bi-clipboard ms-1 cursor-pointer fs-5" onclick="copyLink('{{ local_stream_url }}')"
                            onkeypress="copyLink('{{ local_stream_url }}')" title="Copy Local Stream URL" tabindex=""
                            role="button"></i>
                    </td>
                    <td>
                        {% if camera[CameraTableIndex.REMOTE_STREAM_URL] !=
                        None %}
                        <a href="{{ remote_stream_url }}" title="{{ remote_stream_url }}" target="_blank">Link</a>
                        <i class="bi-link-45deg ms-1 cursor-pointer fs-5 btnLinkCamera" data-bs-toggle="modal"
                            data-bs-target="#linkCameraModal" data-id="{{ camera[CameraTableIndex.ID] }}"
                            data-link-type="remote" title="Link Remote Camera" tabindex="" role="button"></i>
                        <i class="bi-clipboard ms-1 cursor-pointer fs-5" onclick="copyLink('{{ remote_stream_url }}')"
                            onkeypress="copyLink('{{ remote_stream_url }}')" title="Copy Remote Stream URL" tabindex=""
                            role="button"></i>
                        {% else %}
                        <span class="text-danger">Not Available</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        {% if camera[CameraTableIndex.STREAM_STATUS] == 1
                        and status in ['running', 'sleeping', 'waking', 'idle'] %}
                        <span class="badge bg-success">Running</span>
                        {% elif camera[CameraTableIndex.STREAM_STATUS] == 1
                        and status not in ['running', 'sleeping', 'waking', 'idle'] %}
                        <span class="badge bg-danger">Exited</span>
                        {% else %}
                        <span class="badge bg-secondary">Not Running</span>
                        {% endif %}
                    </td>
                    <td class="text-center d-flex gap-3 justify-content-center px-3">
                        {% if camera[CameraTableIndex.STREAM_STATUS] == 1
                        and status in ['running', 'sleeping', 'waking', 'idle'] %}
                        <a href="/camera/unpublish?camera_id={{ camera[CameraTableIndex.ID] }}" title="Stop"
                            class="text-decoration-none">
                            <i class="bi-stop-circle text-danger cursor-pointer fs-4"></i>
                        </a>
                        {% else %}
                        <a href="/camera/publish?camera_id={{ camera[CameraTableIndex.ID] }}" title="Publish"
                            class="text-decoration-none">
                            <i class="bi-play-circle text-success cursor-pointer fs-4"></i>
                        </a>
                        {% endif %}

                        <i class="bi-plus-circle text-secondary cursor-pointer fs-4" data-bs-toggle="modal"
                            data-bs-target="#createCameraModal" data-id="{{ camera[CameraTableIndex.ID] }}"
                            title="Create New Camera on Platform" tabindex="" role="button"></i>

                        <i class="bi-play-btn text-warning cursor-pointer fs-4 btnCameraPreview" data-bs-toggle="modal"
                            data-bs-target="#fullScreenModal" data-id="{{ camera[CameraTableIndex.ID] }}"
                            title="Camera Preview" tabindex="" role="button"></i>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div id="gridView" class="row g-4 mt-4" style="display: none">
            <div class="col-12">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                    <input type="text" id="gridSearch" class="form-control w-50 me-2" placeholder="Search cameras..." />
                    <select id="gridFilter" class="form-select w-25 me-2">
                        <option value="">Filter by Status</option>
                        <option value="Running">Running</option>
                        <option value="Exited">Exited</option>
                        <option value="Not Running">Not Running</option>
                    </select>
                    <select id="itemsPerPage" class="form-select w-auto">
                        <option value="8" selected>8 per page</option>
                        <option value="16">16 per page</option>
                        <option value="24">24 per page</option>
                    </select>
                </div>
            </div>

            <div id="gridContainer" class="row g-4">
                {% for camera in cameras %}
                {% set local_stream_url = get_rtsp_url(camera, 'local') %}
                {% set remote_stream_url = get_rtsp_url(camera, 'remote') %}
                {% set _, remote_port = tunnel_helper.parse_address(remote_stream_url) %}
                {% set status = ffmpeg_helper.check_stream_status(remote_stream_url) if streaming_method == 'ffmpeg'
                else
                tunnel_helper.check_tunnel_status(remote_port) if remote_stream_url else None %}
                <div class="col-xl-3 col-lg-4 col-md-6 camera-card"
                    data-status="{% if camera[CameraTableIndex.STREAM_STATUS] == 1 and status in ['running', 'sleeping', 'waking', 'idle'] %}Running{% elif camera[CameraTableIndex.STREAM_STATUS] == 1 and status not in ['running', 'sleeping', 'waking', 'idle'] %}Exited{% else %}Not Running{% endif %}">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="card-img-top position-relative">
                            <div class="position-relative ratio ratio-16x9 rounded-top overflow-hidden">
                                <div class="iframe-container" style="cursor: pointer;">
                                    <div class="iframe-loader" id="loader-{{camera[CameraTableIndex.ID]}}">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                    <div class="position-absolute w-100 h-100 top-0 btnCameraPreview"
                                        style="z-index: 10;" data-bs-toggle="modal" data-bs-target="#fullScreenModal"
                                        data-id="{{ camera[CameraTableIndex.ID] }}"></div>
                                    <iframe title="Camera Preview" data-id="{{ camera[CameraTableIndex.ID] }}"
                                        id="iframe-{{camera[CameraTableIndex.ID]}}" src=""
                                        class="camera-stream-container lazy-iframe" loading="lazy"
                                        onload="window.hideLoader && hideLoader('{{camera[CameraTableIndex.ID]}}')">
                                    </iframe>
                                </div>
                            </div>
                            <div class="position-absolute top-0 end-0 p-2">
                                {% if camera[CameraTableIndex.STREAM_STATUS] == 1
                                and status in ['running', 'sleeping', 'waking', 'idle'] %}
                                <span class="badge bg-success">Running</span>
                                {% elif camera[CameraTableIndex.STREAM_STATUS] == 1
                                and status not in ['running', 'sleeping', 'waking', 'idle'] %}
                                <span class="badge bg-danger">Exited</span>
                                {% else %}
                                <span class="badge bg-secondary">Not Running</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="card-title text-truncate mb-1">
                                        {{ camera[CameraTableIndex.HOSTNAME] }}
                                    </h5>
                                    <small class="text-muted">
                                        {{ camera[CameraTableIndex.IP_ADDRESS] }}:{{
                                        camera[CameraTableIndex.PORT_NUMBER] }}
                                    </small>
                                </div>
                                <div class="d-flex flex-wrap gap-2 justify-content-end">
                                    {% if camera[CameraTableIndex.STREAM_STATUS] == 1
                                    and status in ['running', 'sleeping', 'waking', 'idle'] %}
                                    <a href="/camera/unpublish?camera_id={{ camera[CameraTableIndex.ID] }}"
                                        class="btn btn-sm btn-danger" title="Stop">
                                        <i class="bi-stop-circle cursor-pointer"></i> Stop
                                    </a>
                                    {% else %}
                                    <a href="/camera/publish?camera_id={{ camera[CameraTableIndex.ID] }}"
                                        class="btn btn-sm btn-success" title="Publish">
                                        <i class="bi-play-circle cursor-pointer"></i> Publish
                                    </a>
                                    {% endif %}

                                    <button class="btn btn-warning btn-sm btnCreateCamera" data-bs-toggle="modal"
                                        data-bs-target="#createCameraModal" data-id="{{ camera[CameraTableIndex.ID] }}"
                                        title="Create New Camera on Platform">
                                        <i class="bi-plus cursor-pointer"></i> Create
                                    </button>
                                </div>
                            </div>
                            <div class="camera-details mt-3 p-3 bg-light rounded shadow-sm">
                                <div class="detail-item mb-2 d-flex align-items-center">
                                    <i class="bi bi-camera text-primary me-2"></i>
                                    <small class="text-muted">
                                        <strong>Profile:</strong> {{
                                        camera[CameraTableIndex.PROFILE_TOKEN]
                                        }}
                                    </small>
                                </div>
                                <div class="detail-item mb-2 d-flex align-items-center">
                                    <i class="bi bi-cpu text-success me-2"></i>
                                    <small class="text-muted">
                                        <strong>Model:</strong> {{
                                        camera[CameraTableIndex.MODEL] }}
                                    </small>
                                </div>
                                <div class="detail-item mb-2 d-flex align-items-center">
                                    <i class="bi bi-aspect-ratio text-info me-2"></i>
                                    <small class="text-muted">
                                        <strong>Resolution:</strong> {{
                                        camera[CameraTableIndex.RESOLUTION]
                                        }}
                                    </small>
                                </div>
                                <div class="detail-item mb-2 d-flex align-items-center">
                                    <i class="bi bi-speedometer text-warning me-2"></i>
                                    <small class="text-muted">
                                        <strong>Bitrate:</strong> {{
                                        camera[CameraTableIndex.BITRATE] }}
                                    </small>
                                </div>
                                <div class="detail-item mb-2 d-flex align-items-center">
                                    <i class="bi bi-code-square text-danger me-2"></i>
                                    <small class="text-muted">
                                        <strong>Encoding:</strong> {{
                                        camera[CameraTableIndex.ENCODING] }}
                                    </small>
                                </div>
                                <div class="detail-item mb-2 d-flex align-items-center">
                                    <i class="bi bi-link text-primary me-2"></i>
                                    <small class="text-muted">
                                        <strong>Stream URL:</strong>
                                        <a href="{{ local_stream_url }}" title="{{ local_stream_url }}" target="_blank"
                                            class="text-decoration-none">
                                            Link
                                        </a>
                                        <i class="bi bi-clipboard ms-2 cursor-pointer text-secondary fs-6"
                                            onclick="copyLink('{{ local_stream_url }}')"
                                            onkeypress="copyLink('{{ local_stream_url }}')" tabindex=""
                                            role="button"></i>
                                        <i class="bi bi-link-45deg ms-2 cursor-pointer text-secondary fs-6 btnLinkCamera"
                                            data-bs-toggle="modal" data-bs-target="#linkCameraModal"
                                            data-id="{{ camera[CameraTableIndex.ID] }}" data-link-type="local"
                                            title="Link Local Camera" tabindex="" role="button"></i>
                                    </small>
                                </div>
                                <div class="detail-item d-flex align-items-center">
                                    <i class="bi bi-link-45deg text-secondary me-2"></i>
                                    <small class="text-muted">
                                        <strong>Remote Stream:</strong>
                                        {% if
                                        camera[CameraTableIndex.REMOTE_STREAM_URL]
                                        != None %}
                                        <a href="{{ remote_stream_url }}" title="{{ remote_stream_url }}"
                                            target="_blank" class="text-decoration-none">
                                            Link
                                        </a>
                                        <i class="bi bi-clipboard ms-2 cursor-pointer text-secondary fs-6"
                                            onclick="copyLink('{{ remote_stream_url }}')"
                                            onkeypress="copyLink('{{ remote_stream_url }}')" tabindex=""
                                            role="button"></i>
                                        <i class="bi bi-link-45deg ms-2 cursor-pointer text-secondary fs-6 btnLinkCamera"
                                            data-bs-toggle="modal" data-bs-target="#linkCameraModal"
                                            data-id="{{ camera[CameraTableIndex.ID] }}" data-link-type="remote"
                                            title="Link Remote Camera" tabindex="" role="button"></i>
                                        {% else %}
                                        <span class="text-danger">Not Available</span>
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if not cameras %}
            <div class="col-12">
                <div class="alert alert-info text-center" role="alert">
                    <i class="bi-info-circle me-2"></i>No cameras found.
                    Scan cameras by clicking on the scan button.
                </div>
            </div>
            {% endif %}

            <div class="col-12 mt-4">
                <nav>
                    <ul class="pagination justify-content-center" id="gridPagination">
                        <!-- Pagination will be dynamically generated -->
                    </ul>
                </nav>
            </div>

            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const gridSearch =
                        document.getElementById("gridSearch");
                    const gridFilter =
                        document.getElementById("gridFilter");
                    const gridContainer =
                        document.getElementById("gridContainer");
                    const gridPagination =
                        document.getElementById("gridPagination");
                    const itemsPerPageSelect =
                        document.getElementById("itemsPerPage");
                    let itemsPerPage = parseInt(itemsPerPageSelect.value);
                    let currentPage = 1;

                    function filterAndPaginate() {
                        const searchQuery = gridSearch.value.toLowerCase();
                        const filterValue = gridFilter.value;
                        const cameraCards = Array.from(
                            gridContainer.getElementsByClassName(
                                "camera-card"
                            )
                        );

                        const filteredCards = cameraCards.filter((card) => {
                            const matchesSearch = card.innerText
                                .toLowerCase()
                                .includes(searchQuery);
                            const matchesFilter =
                                !filterValue ||
                                card.dataset.status === filterValue;
                            return matchesSearch && matchesFilter;
                        });

                        cameraCards.forEach(
                            (card) => (card.style.display = "none")
                        );
                        const totalPages = Math.ceil(
                            filteredCards.length / itemsPerPage
                        );
                        const start = (currentPage - 1) * itemsPerPage;
                        const end = start + itemsPerPage;

                        filteredCards
                            .slice(start, end)
                            .forEach(
                                (card) => (card.style.display = "block")
                            );
                        updatePagination(totalPages);
                    }

                    function updatePagination(totalPages) {
                        gridPagination.innerHTML = "";
                        for (let i = 1; i <= totalPages; i++) {
                            const li = document.createElement("li");
                            li.className = `page-item ${i === currentPage ? "active" : ""
                                }`;
                            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                            li.addEventListener("click", function (e) {
                                e.preventDefault();
                                currentPage = i;
                                filterAndPaginate();
                            });
                            gridPagination.appendChild(li);
                        }
                    }

                    gridSearch.addEventListener("input", () => {
                        currentPage = 1;
                        filterAndPaginate();
                    });

                    gridFilter.addEventListener("change", () => {
                        currentPage = 1;
                        filterAndPaginate();
                    });

                    itemsPerPageSelect.addEventListener("change", () => {
                        itemsPerPage = parseInt(itemsPerPageSelect.value);
                        currentPage = 1;
                        filterAndPaginate();
                    });

                    filterAndPaginate();
                });
            </script>
        </div>
    </div>

    <!-- Link Camera Modal -->
    <div class="modal fade" id="linkCameraModal" tabindex="-1" aria-labelledby="linkCameraModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="linkCameraModalLabel">
                        Link Camera With
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table id="cameraLinkTable" class="table table-striped table-hover w-100">
                            <thead>
                                <tr>
                                    <th searchable>Organization</th>
                                    <th searchable>Camera Name</th>
                                    <th searchable>Location</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for camera in api.get_cameras().data %}
                                <tr>
                                    <td>{{ camera.organization.name}}</td>
                                    <td>{{ camera.name }}</td>
                                    <td>{{ camera.location.name }}</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm linkCamera" data-local-cam-id=""
                                            data-id="{{ camera.id }}" data-link-type="">
                                            <i class="bi-link-45deg"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Camera Modal -->
    <div class="modal fade" id="createCameraModal" tabindex="-1" aria-labelledby="createCameraModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <form id="createCameraForm" method="post" action="/camera/create">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createCameraModalLabel">
                            Create Camera
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="camera_id" id="cameraId" />
                        <div class="mb-3">
                            <label for="organization" class="form-label">Organization</label>
                            <select class="form-control" name="organization_id" required>
                                {% for organization in
                                api.get_organizations().data %}
                                <option value="{{ organization.id }}" {% if loop.first %}selected{% endif %}>
                                    {{ organization.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="name" class="form-label">Camera Name</label>
                            <input type="text" class="form-control" name="name" placeholder="Enter camera name"
                                required />
                        </div>
                        <div class="mb-3">
                            <label for="location" class="form-label">Location</label>
                            <select class="form-control" name="location_id" required>
                                <option value="">Select Location</option>
                                {% for location in api.get_locations().data
                                %}
                                <option value="{{ location.id }}">
                                    {{ location.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="source" class="form-label">Source</label>
                            <select class="form-control" name="source" required>
                                <option value="local" selected>
                                    Local
                                </option>
                                <option value="remote">Remote</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Create
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="editForm" method="post" action="/camera/bulkUpdate">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel">
                            Edit Camera
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="selectedCameraIds" id="selectedCameraIds" value="" />
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" placeholder="Enter username" />
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" name="password"
                                    placeholder="Enter password" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Update
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Full Screen Modal -->
    <div class="modal fade" id="fullScreenModal" tabindex="-1" aria-labelledby="fullScreenModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fullScreenModalLabel">
                        Camera Preview
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex justify-content-center align-items-center p-0">
                    <div id="fullscreenLoader" class="iframe-loader">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <iframe id="fullScreenFrame" class="lazy-iframe-fullscreen"
                        style="width: 100%; height: 100%; border: none;"
                        onload="document.getElementById('fullscreenLoader').style.display = 'none';">
                    </iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Scan Modal -->
    <div class="modal fade" id="scanModal" tabindex="-1" aria-labelledby="scanModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="scanForm" method="post" action="/camera/scan" class="needs-validation" novalidate>
                <div class="modal-content shadow rounded">
                    <div class="modal-header bg-light border-bottom">
                        <h5 class="modal-title fw-bold text-primary" id="scanModalLabel">
                            <i class="bi bi-search me-2"></i>Scan Cameras
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <!-- Discovered Devices Section -->
                        <div class="mb-4">
                            <h6 class="fw-bold text-secondary mb-3">
                                <i class="bi bi-hdd-network me-2"></i>Discovered Devices
                                <button type="button" class="btn btn-sm btn-outline-primary float-end"
                                    onclick="discoverDevices()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                </button>
                            </h6>
                            <div id="discoveredDevices" class="list-group shadow-sm rounded mt-2">
                                <div id="discoveryLoader" class="text-center p-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div class="mt-2">Discovering devices...</div>
                                </div>
                                <!-- Devices will be populated here -->
                            </div>
                        </div>

                        <!-- Horizontal Divider -->
                        <hr class="my-4 border-secondary opacity-25" />

                        <div class="mb-4">
                            <label for="scanType" class="form-label fw-semibold">Scan Type</label>
                            <select class="form-select form-select shadow-sm" id="scanType" name="scanType" required>
                                <option value="automatic" selected>
                                    Automatic Scan
                                </option>
                                <option value="manual">Manual Configuration</option>
                            </select>
                        </div>
                        <div id="manualScanFields" style="display: none" class="animate__animated animate__fadeIn">
                            <div class="mb-3">
                                <label for="manualIp" class="form-label fw-semibold">IP Address</label>
                                <input type="text" class="form-control form-control shadow-sm" id="manualIp"
                                    name="manualIp" placeholder="e.g. 192.168.1.100" />
                            </div>
                            <div class="mb-3">
                                <label for="manualPort" class="form-label fw-semibold">Port</label>
                                <input type="number" class="form-control form-control shadow-sm" id="manualPort"
                                    name="manualPort" placeholder="Enter Port" value="8080" />
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="manualUsername" class="form-label fw-semibold">Username (Optional)</label>
                            <div class="input-group input-group">
                                <span class="input-group-text"><i class="bi bi-person"></i></span>
                                <input type="text" class="form-control shadow-sm" id="manualUsername"
                                    name="manualUsername" placeholder="Enter Username" />
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label fw-semibold">Password (Optional)</label>
                            <div class="input-group input-group">
                                <span class="input-group-text"><i class="bi bi-lock"></i></span>
                                <input type="password" class="form-control shadow-sm" name="manualPassword"
                                    placeholder="Enter password" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-top p-3">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x me-2"></i>Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" id="startScan">
                            <i class="bi bi-play me-2"></i>Start Scan
                        </button>
                    </div>
                </div>
            </form>

            <script>
                function discoverDevices() {
                    const devicesList = document.getElementById('discoveredDevices');
                    const loader = document.getElementById('discoveryLoader');
                    if (!devicesList.contains(loader)) {
                        devicesList.insertAdjacentHTML('afterbegin', `
                            <div id="discoveryLoader" class="text-center p-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="mt-2">Discovering devices...</div>
                            </div>
                        `);
                    }

                    fetch('/camera/discover')
                        .then(response => response.json())
                        .then(devices => {
                            const loader = document.getElementById('discoveryLoader');
                            if (loader) {
                                loader.remove();
                            }

                            devices.forEach(device => {
                                const existingDevice = Array.from(devicesList.children).find(el =>
                                    el.textContent.includes(device.ip_address) && el.textContent.includes(device.port)
                                );

                                if (!existingDevice) {
                                    const deviceElement = document.createElement('a');
                                    deviceElement.className = 'list-group-item list-group-item-action';
                                    deviceElement.innerHTML = `
                                        ${device.ip_address} (${device.port})
                                        <button type="button" class="btn btn-sm btn-primary float-end" onclick="autofillDevice('${device.ip_address}', '${device.port}')">
                                            Use
                                        </button>
                                    `;
                                    devicesList.appendChild(deviceElement);
                                }
                            });
                        })
                        .catch(error => {
                            console.error('Error discovering devices:', error);
                            const loader = document.getElementById('discoveryLoader');
                            if (loader) {
                                loader.innerHTML = `
                                    <div class="text-center p-3 text-danger">
                                        <i class="bi bi-exclamation-triangle me-2"></i>Error discovering devices
                                    </div>
                                `;
                            }
                        });
                }

                function autofillDevice(address, port) {
                    document.getElementById('scanType').value = 'manual';
                    document.getElementById('manualScanFields').style.display = 'block';
                    document.getElementById('manualIp').value = address;
                    document.getElementById('manualPort').value = port;
                }

                // Initial discovery
                discoverDevices();

                // Periodic discovery every 60 seconds
                setInterval(discoverDevices, 60000);

                // Show/hide manual scan fields based on scan type
                document.getElementById('scanType').addEventListener('change', function () {
                    document.getElementById('manualScanFields').style.display =
                        this.value === 'manual' ? 'block' : 'none';
                });
            </script>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/jquery-3.7.1.slim.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dataTables.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dataTables.bootstrap5.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dataTables.responsive.js') }}"></script>
    <script src="{{ url_for('static', filename='js/responsive.bootstrap5.js') }}"></script>

    {% with messages = get_flashed_messages(with_categories=true) %} {% if
    messages %} {% for category, message in messages %}
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div class="toast align-items-center text-white bg-{{ category }} border-0" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i
                        class="bi {% if category == 'success' %}bi-check-circle{% elif category == 'danger' %}bi-exclamation-triangle{% elif category == 'warning' %}bi-exclamation-circle{% elif category == 'info' %}bi-info-circle{% endif %} me-2"></i>
                    {{ message }}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var toastElList = [].slice.call(
                document.querySelectorAll(".toast")
            );
            var toastList = toastElList.map(function (toastEl) {
                return new bootstrap.Toast(toastEl, {
                    autohide: true,
                    delay: 3000,
                });
            });
            toastList.forEach((toast) => toast.show());
        });
    </script>
    {% endfor %} {% endif %} {% endwith %}

    <script>
        $(document).ready(function () {
            $("#cameraTable").DataTable({
                stateSave: true,
                order: [[1, "desc"]],
                responsive: true,
                columnDefs: [
                    { responsivePriority: 1, targets: 0 },
                    { responsivePriority: 2, targets: 17 },
                    { responsivePriority: 3, targets: 18 },
                    { responsivePriority: 10002, targets: 16 },
                    { responsivePriority: 10003, targets: 15 },
                    { responsivePriority: 10004, targets: 1 },
                    { responsivePriority: 10005, targets: 4 },
                    { responsivePriority: 10010, targets: 6 },
                    { responsivePriority: 10011, targets: 7 },
                    { responsivePriority: 10012, targets: 8 },
                    { responsivePriority: 10013, targets: 12 },
                    { responsivePriority: 10014, targets: 10 },
                    { responsivePriority: 10015, targets: 11 },
                    { responsivePriority: 10016, targets: 9 },
                    { responsivePriority: 10017, targets: 13 },
                    { responsivePriority: 10018, targets: 14 },
                ],
                language: {
                    emptyTable:
                        "No cameras found. Scan cameras by clicking on scan button.",
                },
                initComplete: function () {
                    this.api()
                        .columns()
                        .every(function () {
                            var column = this;
                            var header = $(column.header());
                            var title = header.text().trim();

                            if (header.attr("searchable") !== undefined) {
                                $(
                                    '<input type="text" class="form-control form-control-sm mt-1" placeholder="Search ' +
                                    title +
                                    '" />'
                                )
                                    .appendTo(header)
                                    .on("click", function (e) {
                                        e.stopPropagation();
                                    })
                                    .on("keyup change", function () {
                                        if (
                                            column.search() !== this.value
                                        ) {
                                            column
                                                .search(this.value)
                                                .draw();
                                        }
                                    });
                            }
                        });
                },
            });

            $("#cameraLinkTable").DataTable({
                pageLength: 10,
                searching: true,
                ordering: true,
                info: true,
                lengthChange: true,
                initComplete: function () {
                    this.api()
                        .columns()
                        .every(function () {
                            var column = this;
                            var header = $(column.header());
                            var title = header.text().trim();

                            if (header.attr("searchable") !== undefined) {
                                $(
                                    '<input type="text" class="form-control form-control-sm mt-1" placeholder="Search ' +
                                    title +
                                    '" />'
                                )
                                    .appendTo(header)
                                    .on("click", function (e) {
                                        e.stopPropagation();
                                    })
                                    .on("keyup change", function () {
                                        if (
                                            column.search() !== this.value
                                        ) {
                                            column
                                                .search(this.value)
                                                .draw();
                                        }
                                    });
                            }
                        });
                },
            });

            $("#selectionBtnGroup").css("visibility", "hidden");

            // Save camera ID to local database
            $(".btnLinkCamera").on("click", function () {
                $(".linkCamera").data("local-cam-id", $(this).data("id"));
                $(".linkCamera").data(
                    "link-type",
                    $(this).data("link-type")
                );
            });

            $(".linkCamera").on("click", function () {
                window.location =
                    "/camera/" +
                    $(this).data("local-cam-id") +
                    "/link_to/" +
                    $(this).data("id") +
                    "?link_type=" +
                    $(this).data("link-type");
            });

            $(".btnCreateCamera").on("click", function () {
                $("#cameraId").val($(this).data("id"));
            });

            $(".btnCameraPreview").click(function () {
                // Show loader before loading iframe
                $('#fullscreenLoader').hide();
                $("#fullScreenFrame").data("id", $(this).data("id"));
                $("#fullScreenFrame").attr(
                    "src",
                    "/play?camera_id=" + $(this).data("id") + "&hd=true"
                );
            });

            // Check all checkboxes
            $("#checkAll").click(function () {
                $(".checkRow").prop("checked", $(this).prop("checked"));
                update();
            });

            // Get selected checkbox ids
            $(".checkRow").click(function () {
                update();
            });

            $("#btnPublishSelected").click(function () {
                let selectedIds = getSelectedIds();
                window.location = "/camera/bulkPublish?ids=" + selectedIds;
            });

            $("#btnStopSelected").click(function () {
                let selectedIds = getSelectedIds();
                window.location = "/camera/bulkStop?ids=" + selectedIds;
            });

            $("#btnDeleteSelected").click(function () {
                let selectedIds = getSelectedIds();
                window.location = "/camera/bulkDelete?ids=" + selectedIds;
            });

            const tableView = $("#cameraTable_wrapper");
            const gridView = $("#gridView");
            const viewToggle = $("#viewToggle");
            const viewToggleIcon = $("#viewToggleIcon");
            const viewToggleText = $("#viewToggleText");
            const currentView =
                localStorage.getItem("cameraViewPreference") || "table";
            if (currentView === "grid") {
                tableView.hide();
                gridView.show();
                viewToggleIcon.removeClass("bi-grid").addClass("bi-list");
                viewToggleText.text("List View");
            }

            viewToggle.click(function () {
                if (tableView.is(":visible")) {
                    tableView.hide();
                    gridView.show();
                    viewToggleIcon
                        .removeClass("bi-grid")
                        .addClass("bi-list");
                    viewToggleText.text("List View");
                    localStorage.setItem("cameraViewPreference", "grid");

                    // Reinitialize iframes in grid view
                    document
                        .querySelectorAll(".lazy-iframe")
                        .forEach((iframe) => {
                            if (iframe.getAttribute("data-id") !== null) {
                                iframe.src =
                                    "/play?camera_id=" +
                                    iframe.getAttribute("data-id");
                            }
                        });
                } else {
                    gridView.hide();
                    tableView.show();
                    viewToggleIcon
                        .removeClass("bi-list")
                        .addClass("bi-grid");
                    viewToggleText.text("Grid View");
                    localStorage.setItem("cameraViewPreference", "table");
                }
            });
        });

        function update() {
            let selectedIds = getSelectedIds();
            $("#selectedCameraIds").val(selectedIds);

            if (selectedIds.length > 0) {
                $("#selectionBtnGroup").css("visibility", "visible");
            } else {
                $("#selectionBtnGroup").css("visibility", "hidden");
            }
        }

        function getSelectedIds() {
            let selectedIds = [];
            $(".checkRow:checked").each(function () {
                selectedIds.push($(this).data("id"));
            });

            return selectedIds.join(",");
        }

        function copyLink(link) {
            if (navigator.clipboard) {
                navigator.clipboard
                    .writeText(link)
                    .then(() => {
                        showToast("Link copied to clipboard");
                    })
                    .catch(() => {
                        fallbackCopyTextToClipboard(link);
                    });
            } else {
                fallbackCopyTextToClipboard(link);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand("copy");
                showToast("Link copied to clipboard");
            } catch (err) {
                console.error("Failed to copy link: ", err);
                showToast("Failed to copy link");
            }
            document.body.removeChild(textArea);
        }

        function showToast(message) {
            var toast = document.createElement("div");
            toast.classList.add(
                "toast",
                "fade",
                "show",
                "position-fixed",
                "end-0",
                "bottom-0",
                "me-2",
                "mb-2",
                "bg-success",
                "text-white"
            );
            toast.setAttribute("role", "alert");
            toast.setAttribute("aria-live", "assertive");
            toast.setAttribute("aria-atomic", "true");
            toast.innerHTML = `
                <div class="toast-body">
                    <i class="bi-info me-1"></i>
                    ${message}
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(function () {
                toast.classList.remove("show");
                setTimeout(function () {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // Hide the loader when iframe is loaded
        function hideLoader(cameraId) {
            const iframe = document.getElementById('iframe-' + cameraId);
            const loader = document.getElementById('loader-' + cameraId);

            // Only hide the loader if the iframe has a valid source
            if (iframe.src && iframe.src !== 'about:blank' && iframe.src !== '') {
                if (loader) {
                    loader.style.display = 'none';
                }
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const observer = new IntersectionObserver(
                (entries) => {
                    entries.forEach((entry) => {
                        const iframe = entry.target;
                        const cameraId = iframe.getAttribute("data-id");
                        const loader = document.getElementById('loader-' + cameraId);

                        if (entry.isIntersecting) {
                            // Show loader before loading iframe
                            if (loader) {
                                loader.style.display = 'flex';
                            }

                            iframe.src = "/play?camera_id=" + cameraId;
                        } else {
                            iframe.src = ""; // Stop/destroy iframe when not visible

                            // Show loader again for next time
                            if (loader) {
                                loader.style.display = 'flex';
                            }
                        }
                    });
                },
                {
                    threshold: 0.1,
                }
            );

            document.querySelectorAll(".lazy-iframe").forEach((iframe) => {
                observer.observe(iframe);
            });

            // Add lazy loading for fullscreen iframe
            const fullscreenObserver = new IntersectionObserver(
                (entries) => {
                    entries.forEach((entry) => {
                        const iframe = entry.target;
                        const cameraId = iframe.getAttribute("data-id");
                        const loader = document.getElementById('fullscreenLoader');

                        if (cameraId) {
                            if (entry.isIntersecting) {
                                if (loader) {
                                    loader.style.display = 'flex';
                                }
                                iframe.src = "/play?camera_id=" + cameraId + "&hd=true";
                            } else {
                                iframe.src = "";
                                if (loader) {
                                    loader.style.display = 'flex';
                                }
                            }
                        }
                    });
                },
                {
                    threshold: 0.1,
                }
            );

            document.querySelectorAll(".lazy-iframe-fullscreen").forEach((iframe) => {
                fullscreenObserver.observe(iframe);
            });

            // Find all password fields and add toggle functionality
            document
                .querySelectorAll('input[type="password"]')
                .forEach(function (passwordField) {
                    // Create a unique ID for the field if it doesn't have one
                    if (!passwordField.id) {
                        passwordField.id =
                            "password-" +
                            Math.random().toString(36).substring(2, 10);
                    }

                    // Check if there's already a toggle icon
                    const parentElement = passwordField.parentElement;
                    if (!parentElement.querySelector(".toggle-password")) {
                        // Create the toggle container
                        const toggleContainer =
                            document.createElement("span");
                        toggleContainer.className =
                            "input-group-text bg-light toggle-password";
                        toggleContainer.style.cursor = "pointer";

                        // Create the eye icon
                        const toggleIcon = document.createElement("i");
                        toggleIcon.className = "bi bi-eye-slash";
                        toggleIcon.setAttribute(
                            "data-for",
                            passwordField.id
                        );

                        // Add the icon to the toggle container
                        toggleContainer.appendChild(toggleIcon);

                        // Add the toggle container to the parent
                        parentElement.appendChild(toggleContainer);

                        // Add click event
                        toggleContainer.addEventListener(
                            "click",
                            function () {
                                const targetField = document.getElementById(
                                    toggleIcon.getAttribute("data-for")
                                );
                                const type =
                                    targetField.getAttribute("type") ===
                                        "password"
                                        ? "text"
                                        : "password";
                                targetField.setAttribute("type", type);
                                toggleIcon.classList.toggle("bi-eye");
                                toggleIcon.classList.toggle("bi-eye-slash");
                            }
                        );
                    }
                });

            const scanType = document.getElementById("scanType");
            const manualScanFields =
                document.getElementById("manualScanFields");

            scanType.addEventListener("change", function () {
                if (scanType.value === "manual") {
                    manualScanFields.style.display = "block";
                    document
                        .getElementById("manualIp")
                        .setAttribute("required", "true");
                    document
                        .getElementById("manualPort")
                        .setAttribute("required", "true");
                } else {
                    manualScanFields.style.display = "none";
                    document
                        .getElementById("manualIp")
                        .removeAttribute("required");
                    document
                        .getElementById("manualPort")
                        .removeAttribute("required");
                }
            });
        });
    </script>
</body>

</html>