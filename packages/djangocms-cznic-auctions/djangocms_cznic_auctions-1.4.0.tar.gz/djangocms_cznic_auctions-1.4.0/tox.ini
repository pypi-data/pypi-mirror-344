[tox]
envlist =
    clear-coverage
    quality
    py{39}-cms{3}
    py{310,311}-cms{3,4}
    py{312}-cms{4}
    compute-coverage
skip_missing_interpreters = True

[testenv]
setenv =
    DJANGO_SETTINGS_MODULE = cznic_auctions.tests.settings
deps =
    coverage
    cms3: django==4.2.*
    cms3: django-cms==3.11.*
    cms4: django-cms==4.1.*
extras =
    test
commands =
    coverage run --parallel-mode --source=cznic_auctions --branch -m django test {posargs}

[testenv:clear-coverage]
depends =
extras =
commands =
    coverage erase

[testenv:codecov]
depends = clear-coverage
deps = codecov
commands = codecov

[testenv:compute-coverage]
depends =
    py{39}-cms{3}
    py{310,311}-cms{3,4}
    py{312}-cms{4}
extras =
parallel_show_output = True
commands =
    coverage combine
    coverage report --show-missing --include=*/tests/* --fail-under=100
    coverage report --show-missing --include=cznic_auctions/* --omit=*/tests/*
    coverage html

[testenv:quality]
basepython = python3
depends =
extras =
    quality
    types
    test
# Do not fail on first error, but run all the checks
ignore_errors = True
allowlist_externals =
    ruff
    mypy
commands =
    ruff --version
    ruff check cznic_auctions
    ruff format --check cznic_auctions
    mypy cznic_auctions
    django-admin makemigrations --no-input --dry-run --check --verbosity 3 cznic_auctions

[testenv:translations]
depends = quality
deps =
    polint
setenv =
    SKIP_NPM = 1
    DJANGO_SETTINGS_MODULE =
    LANG = en_US.UTF-8
allowlist_externals =
    msgcmp
    rm
# Do not fail on first error, but run all the checks
ignore_errors = True
extras = quality
changedir = {toxinidir}/cznic_auctions
commands =
    polint --show-msg locale/cs/LC_MESSAGES/django.po
    django-admin makemessages --locale c --no-obsolete --no-location --keep-pot
    msgcmp locale/cs/LC_MESSAGES/django.po locale/django.pot
    -rm -r locale/django.pot locale/c
