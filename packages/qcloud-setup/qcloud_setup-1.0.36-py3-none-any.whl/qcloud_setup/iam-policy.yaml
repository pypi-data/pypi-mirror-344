AWSTemplateFormatVersion: 2010-09-09
Description: Q-Cloud IAM policy
Resources:
 QCloudIamPolicy:
  Type: AWS::IAM::ManagedPolicy
  Properties:
   ManagedPolicyName: QCloudIamPolicy
   PolicyDocument:
    Version: 2012-10-17
    Statement:
    - Action:
      - iam:GetRolePolicy
      - iam:GetPolicy
      - iam:SimulatePrincipalPolicy
      - iam:GetInstanceProfile
      - iam:PutRolePolicy
      Resource:
      - !Sub arn:aws:iam::${AWS::AccountId}:role/*
      - !Sub arn:aws:iam::${AWS::AccountId}:policy/*
      - !Sub arn:aws:iam::${AWS::AccountId}:instance-profile/*
      Effect: Allow
    - Action:
      - iam:CreateInstanceProfile
      - iam:DeleteInstanceProfile
      - iam:AddRoleToInstanceProfile
      - iam:RemoveRoleFromInstanceProfile
      Resource:
      - !Sub arn:aws:iam::${AWS::AccountId}:instance-profile/parallelcluster/*
      Effect: Allow
    - Action:
      - iam:CreatePolicy
      - iam:DeletePolicy
      - iam:CreateRole
      - iam:DeleteRole
      - iam:TagRole
      - iam:AttachRolePolicy
      - iam:DetachRolePolicy
      - iam:DeleteRolePolicy
      - iam:ListPolicyVersions
      Resource:
      - !Sub arn:aws:iam::${AWS::AccountId}:policy/*
      - !Sub arn:aws:iam::${AWS::AccountId}:role/*
      Effect: Allow
    - Action:
      - iam:PassRole
      Condition:
       StringEqualsIfExists:
         iam:PassedToService:
         - lambda.amazonaws.com
         - ec2.amazonaws.com
         - spotfleet.amazonaws.com
         - apigateway.amazonaws.com
      Resource:
      - !Sub arn:aws:iam::${AWS::AccountId}:policy/*
      - !Sub arn:aws:iam::${AWS::AccountId}:role/*
      Effect: Allow
    - Action:
      - iam:GetServiceLinkedRoleDeletionStatus
      - iam:DeleteServiceLinkedRole
      Resource:
      - arn:aws:iam::*:role/aws-service-role/cognito-idp.amazonaws.com/AWSServiceRoleForAmazonCognitoIdp*
      - arn:aws:iam::*:role/aws-service-role/email.cognito-idp.amazonaws.com/AWSServiceRoleForAmazonCognitoIdpEmail*
      Effect: Allow
    - Action: iam:CreateServiceLinkedRole
      Resource: "*"
      Condition:
       StringEquals:
         iam:AWSServiceName:
         - cognito-idp.amazonaws.com
         - email.cognito-idp.amazonaws.com
      Effect: Allow
    - Action:
      - ec2:Describe*
      - ec2:*KeyPair
      - ec2:*LaunchTemplate*
      - ec2:*NetworkInterface
      - ec2:*PlacementGroup
      - ec2:ModifyVolume*
      - ec2:RevokeSecurityGroup*
      - ec2:AuthorizeSecurityGroup*
      - ec2:*SecurityGroup
      - ec2:*Snapshot
      - ec2:ModifyNetworkInterfaceAttribute
      - ec2:AllocateAddress
      - ec2:AssociateAddress
      - ec2:ReleaseAddress
      - ec2:CreateFleet
      - ec2:CreateVolume
      - ec2:DeleteVolume
      - ec2:CreateTags
      - ec2:DisassociateAddress
      - ec2:RunInstances
      - ec2:TerminateInstances
      - ec2:CreateInternetGateway
      - ec2:CreateVpcEndpoint
      - ec2:CreateRoute
      - ec2:CreateVpc
      - ec2:CreateRouteTable
      - ec2:AttachInternetGateway
      - ec2:ModifyVpcAttribute
      - ec2:CreateSubnet
      - ec2:AssociateRouteTable
      Resource: "*"
      Effect: Allow
    - Action:
      - dynamodb:DescribeTable
      - dynamodb:ListTagsOfResource
      - dynamodb:CreateTable
      - dynamodb:DeleteTable
      - dynamodb:GetItem
      - dynamodb:PutItem
      - dynamodb:UpdateItem
      - dynamodb:Query
      - dynamodb:TagResource
      Resource: !Sub arn:aws:dynamodb:*:${AWS::AccountId}:table/parallelcluster-*
      Effect: Allow
    - Action:
      - lambda:CreateFunction
      - lambda:DeleteFunction
      - lambda:GetFunctionConfiguration
      - lambda:GetFunction
      - lambda:InvokeFunction
      - lambda:AddPermission
      - lambda:RemovePermission
      - lambda:UpdateFunctionConfiguration
      - lambda:TagResource
      - lambda:ListTags
      - lambda:UntagResource
      Resource:
      - !Sub arn:aws:lambda:*:${AWS::AccountId}:function:parallelcluster-*
      - !Sub arn:aws:lambda:*:${AWS::AccountId}:function:pcluster-*
      - !Sub arn:aws:lambda:*:${AWS::AccountId}:function:*-s3submit
      - !Sub arn:aws:lambda:*:${AWS::AccountId}:function:*-qcloud
      Effect: Allow
    - Action:
      - s3:*
      Resource:
      - arn:aws:s3:::parallelcluster-*
      - arn:aws:s3:::*aws-parallelcluster*
      - arn:aws:s3:::qcloud-bucket-*
      - arn:aws:s3:::qchem-qcloud/*
      Effect: Allow
    - Action:
      - elasticfilesystem:*
      Resource:
      - !Sub arn:aws:elasticfilesystem:*:${AWS::AccountId}:*
      Effect: Allow
    - Action:
      - logs:*
      - acm:ListCertificates
      - apigateway:*
      - cloudformation:*
      - cloudwatch:*
      - cognito-identity:*
      - cognito-sync:*
      - cognito-idp:*
      - iam:ListSAMLProviders
      - iam:ListOpenIDConnectProviders
      - iam:GetSAMLProvider
      - iam:GetRole
      - iam:ListRoles
      - lambda:ListFunctions
      - lambda:GetPolicy
      - kinesis:ListStreams
      - mobiletargeting:GetApps
      - resource-groups:ListGroupResources
      - route53:ChangeResourceRecordSets
      - route53:ChangeTagsForResource
      - route53:CreateHostedZone
      - route53:DeleteHostedZone
      - route53:GetChange
      - route53:GetHostedZone
      - route53:ListResourceRecordSets
      - route53:ListQueryLoggingConfigs
      - route53:AssociateVPCWithHostedZone
      - sns:GetSMSSandboxAccountStatus
      - ses:ListIdentities
      - ses:GetIdentityVerificationAttributes
      - sns:ListPlatformApplications
      Resource: "*"
      Effect: Allow
    - Action: secretsmanager:DescribeSecret
      Resource: !Sub arn:aws:secretsmanager:*:${AWS::AccountId}:secret:*
      Effect: Allow
    - Action:
      - aws-portal:ViewBilling
      - aws-portal:ModifyBilling
      - budgets:ViewBudget
      - budgets:ModifyBudget
      - budgets:CreateBudget
      - budgets:DescribeBudget
      - ce:GetCostAndUsage
      - ce:GetDimensionValues
      Resource: "*"
      Effect: Allow
    - Action: sns:*
      Resource: arn:aws:sns:*::*
      Effect: Allow
