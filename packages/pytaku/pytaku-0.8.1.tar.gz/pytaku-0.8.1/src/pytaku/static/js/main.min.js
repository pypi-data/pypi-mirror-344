(()=>{function V(t){let e={};return t.split(";").forEach(r=>{let[o,l]=r.split("=");e[o]=l}),e}var a={username:sessionStorage.getItem("username"),userId:sessionStorage.getItem("userId"),token:V(document.cookie).token||null,isLoggedIn:()=>a.username!==null&&a.userId!==null,init:()=>a.isLoggedIn()?(console.log("Already logged in"),Promise.resolve()):a.token===null?(console.log("No saved token found"),Promise.resolve()):m.request({method:"GET",url:"/api/verify-token"}).then(t=>{sessionStorage.setItem("username",t.username),sessionStorage.setItem("userId",t.user_id),a.username=t.username,a.userId=t.user_id}).catch(t=>{t.code==401&&a.clearCredentials()}).finally(m.redraw),saveLoginResults:({userId:t,username:e,token:r,remember:o})=>{sessionStorage.setItem("userId",t),sessionStorage.setItem("username",e),a.userId=t,a.username=e,a.token=r},logout:()=>a.request({method:"POST",url:"/api/logout"}).then(a.clearCredentials).catch(t=>{t.code==401?a.clearCredentials():console.log(t)}),clearCredentials:()=>{a.username=null,a.token=null,a.userId=null,sessionStorage.clear()},request:t=>m.request(t).catch(e=>{throw e.code==401?a.clearCredentials():e.code==500&&alert(e.response.message),e})},f={query:"",result:{},cache:{},isLoading:!0,performSearch:t=>{f.query=t,f.cache[t]?f.result=f.cache[t]:(f.isLoading=!0,m.redraw(),m.request({method:"GET",url:"/api/search/:query",params:{query:t}}).then(e=>{f.cache[t]=e.results,f.result=e.results}).catch(e=>{console.log("TODO",e)}).finally(()=>{f.isLoading=!1}))}},x={cache:{},cacheGet:(t,e,r)=>{let o=[t,e,r].join(",");return x.cache[o]||null},cacheSet:(t,e,r,o)=>{let l=[t,e,r].join(",");x.cache[l]=o},get:({site:t,titleId:e,chapterId:r})=>{let o=x.cacheGet(t,e,r);return o?Promise.resolve(o):a.request({method:"GET",url:"/api/chapter/:site/:titleId/:chapterId",params:{site:t,titleId:e,chapterId:r}}).then(l=>(x.cacheSet(t,e,r,l),l))}};var E={view:t=>m("h2.blink",[m("i.icon.icon-loader.spin")," loading..."])},w={view:t=>m("button",Object.assign({class:t.attrs.color||""},t.attrs),[t.attrs.icon?m(`i.icon.icon-${t.attrs.icon}`):null,t.attrs.text?m("span",t.attrs.text):null])},D={view:t=>m("div.utils--chapter",[m(m.route.Link,{href:`/m/${t.attrs.site}/${t.attrs.titleId}/${t.attrs.chapter.id}`,class:"touch-friendly"},[t.attrs.chapter.is_read?m("i.icon.icon-check-square.utils--chapter--read-icon"):null,m("span",A(t.attrs.chapter)),t.attrs.chapter.groups.map(e=>m("span.utils--chapter--group",$(e,20)))])])};function $(t,e){return t.length>e?`${t.substring(0,e)}...`:t}function A(t){let e="";return typeof t.num_major<"u"&&(e+=(t.volume?"Ch.":"Chapter ")+t.num_major),t.num_minor&&(e+="."+t.num_minor),t.volume&&(e+=" Vol. "+t.volume),t.name&&(e+=" - "+t.name),e}function Y(t){let e=!1;return{view:r=>{let o;return a.isLoggedIn()?o=m("span.nav--greeting",[m("span",["Welcome, ",m("b",a.username)]),m(w,{text:e?" logging out":" logout",icon:"log-out",color:"red",title:"Log out",onclick:l=>{e=!0,m.redraw(),a.logout().then(()=>{m.route.set("/")}).finally(()=>{e=!1})},disabled:e?"disabled":null})]):o=m(m.route.Link,{class:"nav--link",href:"/a"},[m("i.icon.icon-log-in"),"login / register"]),m("nav",[m(m.route.Link,{class:"nav--logo",href:a.isLoggedIn()?"/f":"/"},[m("img.nav--logo--favicon",{src:"/static/favicon.svg",alt:"home"}),m("img.nav--logo--img",{src:"/static/pytaku.svg",alt:"home"})]),m("form.nav--search-form",{onsubmit:l=>{l.preventDefault(),m.route.set("/s/:query",{query:f.query})}},[m("input[placeholder=search manga title]",{onchange:l=>{f.query=l.target.value},value:f.query}),m(w,{color:"red",icon:"search",type:"submit"})]),o])}}}var j={view:t=>[m(Y),t.children]},C=j;function W(t){let e,r,o=!1,l,u,s,d,h,v,I=!1,g=!1;return{oncreate:p=>{document.title="Authentication - Pytaku"},view:p=>m("div.content.auth",[m("form.auth--form",{onsubmit:i=>{i.preventDefault(),l="",g=!0,m.redraw(),m.request({method:"POST",url:"/api/login",body:{username:e,password:r,remember:o}}).then(c=>{let L=c.user_id,S=c.token,_=e;a.saveLoginResults({userId:L,username:_,token:S,remember:o}),m.route.set("/f")}).catch(c=>{l=c.response.message}).finally(()=>{g=!1})}},[m("h1","Login"),m("input[placeholder=username][name=username][required]",{value:e,oninput:i=>{e=i.target.value}}),m("input[placeholder=password][name=password][type=password][required]",{value:r,oninput:i=>{r=i.target.value}}),m("label[for=auth--remember].auth--checkbox-label",[m("input[type=checkbox][name=remember][id=auth--remember]",{checked:o,onchange:i=>{o=i.target.checked}})," Remember me"]),m(w,{type:"submit",disabled:g?"disabled":null,text:g?" Logging in...":" Log in",icon:"log-in",color:"blue"}),m("p.auth--form--error-message",l)]),m("form.auth--form",{onsubmit:i=>{if(i.preventDefault(),h="",m.redraw(),s!==d){h="Password confirmation didn't match!",v=!1;return}I=!0,m.redraw(),m.request({method:"POST",url:"/api/register",body:{username:u,password:s}}).then(c=>{v=!0,h=c.message,e=u,r=s}).catch(c=>{h=c.response.message,v=!1}).finally(()=>{I=!1})}},[m("h1","Register"),m("input[placeholder=username][name=username][required]",{value:u,oninput:i=>{u=i.target.value}}),m("input[placeholder=password][name=password][type=password][required]",{value:s,oninput:i=>{s=i.target.value}}),m("input[placeholder=confirm password][name=confirm][type=password][required]",{value:d,oninput:i=>{d=i.target.value}}),m(w,{type:"submit",disabled:I?"disabled":null,text:I?" Registering...":" Register",icon:"user-plus",color:"green"}),m("p",{class:"auth--form--message-"+(v?"success":"error")},h)])])}}var M=W;var z={oncreate:t=>{document.title="Pytaku"},view:t=>m("div.content",[m("p","Try searching for some manga title using the box above."),m("p","Logging in allows you to follow manga titles.")])},O=z;var H={view:t=>{let e=t.attrs.title,r=3;return m("div.follows--title"+(e.chapters.length===0?".empty":".non-empty"),[m("div",[m(m.route.Link,{href:`/m/${e.site}/${e.id}`,title:`${e.name} - ${e.site}`},[m("img.follows--cover",{src:e.thumbnail,alt:e.name})])]),m("div.follows--chapters",[e.chapters.length>r?m("div.utils--chapter",[m(m.route.Link,{href:`/m/${e.site}/${e.id}`,style:{"font-style":"italic"},class:"touch-friendly"},`and ${e.chapters.length-r} more...`)]):"",e.chapters.slice(-r).map(o=>m(D,{site:e.site,titleId:e.id,chapter:o}))])])}};function J(t){let e=[],r=!1;return{oninit:()=>{r=!0,a.request({method:"GET",url:"/api/follows"}).then(o=>{e=o.titles}).catch(o=>{console.log(o)}).finally(()=>{r=!1})},oncreate:o=>{document.title="Stuff I follow - Pytaku"},view:o=>{let l="";return r?m("div.content",m(E)):e.length===0?m("div.content",[m("p","You're not following any title yet. Try searching for some."),m("p",["Migrating from Tachiyomi? ",m(m.route.Link,{href:"/i"},"Use the importer"),"!"])]):m("div.follows.content",[e.map(u=>m(H,{title:u}))])}}}var N=J;var Q={oninit:t=>{document.title=`"${t.attrs.query}" search results`,f.performSearch(t.attrs.query)},view:t=>m("div.content",f.isLoading?m(E):f.result.map(({site:e,titles:r})=>m("div",[m("h1.search--site-heading",e),r?m("p.search--result-text",["Showing ",m("strong",r.length),` result${r.length>1?"s":""} for `,f.query]):m("p.search--result-text",`No results for "${f.query}"`),m("div.search--results",r.map(o=>m(m.route.Link,{class:"search--result",href:`/m/${e}/${o.id}`,title:o.name},[m("img",{src:o.thumbnail,alt:o.name}),m("span",$(o.name,50))])))])))},R=Q;function Z(t){let e=!1,r=!1,o=!1,l=!1,u=null,s={},d,h,v;return{oninit:I=>{document.title="Manga",e=!0,m.redraw(),a.request({method:"GET",url:"/api/title/:site/:titleId",params:{site:I.attrs.site,titleId:I.attrs.titleId}}).then(g=>{s=g,document.title=s.name}).finally(()=>{e=!1})},view:I=>{if(!e&&a.isLoggedIn()){d=!0,h=!0,v=s.chapters.length;for(var g=s.chapters.length-1;g>=0;g--)s.chapters[g].is_read?(v===g+1&&(v=g),h=!1):d=!1}return m("div.content",e?m(E):[m("h1",s.name),m("div.title--details",[a.isLoggedIn()?[m(w,{icon:"bookmark",disabled:r?"disabled":null,text:r?"submitting...":s.is_following?"following":"follow",color:s.is_following?"red":"green",title:s.is_following?"Click to unfollow":"Click to follow",onclick:p=>{r=!0,m.redraw(),a.request({method:"POST",url:"/api/follow",body:{site:s.site,title_id:s.id,follow:!s.is_following}}).then(i=>{s.is_following=i.follow}).finally(()=>{r=!1})}}),m(w,{icon:"check-square",disabled:o||d?"disabled":null,text:o?"submitting...":d?"all read!":"read all",color:"green",title:d?null:"Click to mark all chapters as read",onclick:p=>{window.confirm("Are you sure you want to read all chapters?")&&(o=!0,m.redraw(),a.request({method:"POST",url:"/api/read",body:{read:s.chapters.filter(c=>!c.is_read).map(c=>({site:s.site,title_id:s.id,chapter_id:c.id}))}}).then(c=>{s.chapters.forEach(L=>{L.is_read=!0})}).finally(()=>{o=!1}))}}),m(w,{icon:"x-square",disabled:l||h?"disabled":null,text:l?"submitting...":h?"all unread!":"unread all",color:"white",title:h?null:"Click to mark all chapters as unread",onclick:p=>{window.confirm("Are you sure you want to unread all chapters?")&&(l=!0,m.redraw(),a.request({method:"POST",url:"/api/read",body:{unread:s.chapters.filter(c=>c.is_read).map(c=>({site:s.site,title_id:s.id,chapter_id:c.id}))}}).then(c=>{s.chapters.forEach(L=>{L.is_read=!1})}).finally(()=>{l=!1}))}})]:null,m("a.touch-friendly[title=Go to source site][target=_blank]",{href:s.source_url},[s.site,m("i.icon.icon-arrow-up-right")])]),m("img.title--cover[alt=cover]",{src:s.cover}),m(".title--descriptions",{},[s.descriptions.map(p=>m("p",s.descriptions_format==="html"?m.trust(p):p))]),s.chapters?s.chapters.map((p,i)=>m(".title--chapter-row",[i<v?m(w,{icon:u!==null&&i>=u?"loader":"chevrons-down",color:"green",title:"Mark all read up to this chapter",disabled:u!==null&&i>=u?"disabled":null,onclick:c=>{if(!window.confirm("Are you sure you want to mark all chapters up to this point as read?"))return;u=i,m.redraw();let S=s.chapters.slice(i).filter(_=>!_.is_read);if(S.length==0){u=null,m.redraw();return}a.request({method:"POST",url:"/api/read",body:{read:S.map(_=>({site:s.site,title_id:s.id,chapter_id:_.id}))}}).then(_=>{S.forEach(n=>{n.is_read=!0})}).finally(()=>{u=null})}}):null,m(D,{site:s.site,titleId:s.id,chapter:p})])):m("p","This one has no chapters.")])}}}var U=Z;var X=43,ee=45,te=48,re=63,oe=106,ae=107,se=104,ne=108,ie={view:()=>m("h2",[m("i.icon.icon-loader.spin")])},le={view:()=>m("h2",[m("i.icon.icon-loader")])},me={view:t=>m(w,{text:"Errored. Try again?",color:"red",onclick:e=>{let{page:r}=t.attrs;r.status=P.LOADING,r.src=r.src.endsWith("?")?r.src.slice(0,-1):r.src+"?"}})},P={LOADING:"loading",SUCCEEDED:"succeeded",FAILED:"failed"};function G(t){let e;return{oninit:r=>{e=r.attrs.src},view:r=>m("img",{src:e,style:r.attrs.style,onload:r.attrs.onload,onerror:o=>{e===r.attrs.src&&r.attrs.altsrc!==null?e=r.attrs.altsrc:r.attrs.onerror(o)}})}}function ce(t){let e=!1,r=!1,o={},l=[],u=[],s,d,h=null,v=null,I=[],g="chapter--pageMaxWidth",p=Number(sessionStorage.getItem(g)||"100");function i(n){if(n.target.tagName!=="INPUT"){switch(n.keyCode){case X:p<=90&&(p+=10),sessionStorage.setItem(g,p.toString());break;case ee:p>20&&(p-=10),sessionStorage.setItem(g,p.toString());break;case te:p=100,sessionStorage.setItem(g,p.toString());break;case re:window.alert(`Keyboard shortcuts:
    - to decrease page size
    + to increase page size (max 100%)
    0 (zero) to reset page size
    j to scroll down
    k to scroll up
    h to go to previous chapter
    l to go to next chapter`);break;case oe:window.scrollBy({top:350,behavior:"smooth"});break;case ae:window.scrollBy({top:-350,behavior:"smooth"});break;case se:document.querySelector(".chapter--prev-button").click();break;case ne:document.querySelector(".chapter--next-button").click();break}m.redraw()}}function c(){if(u.length>0){let[n,y]=u.splice(0,1)[0];l.push({status:P.LOADING,src:n,altsrc:y})}else o.next_chapter&&h===null&&(h=x.get({site:s,titleId:d,chapterId:o.next_chapter.id}).then(n=>{console.log("Preloading next chapter:",A(n)),n.pages_alt.length>0?v=n.pages.map((y,b)=>[y,n.pages_alt[b]]):v=n.pages.map(y=>[y,null]),L(),L()}))}function L(){if(v!==null&&v.length>0){let[n,y]=v.splice(0,1)[0];I.push({src:n,altsrc:y})}}function S(n,y,b){return a.request({method:"POST",url:"/api/read",body:{read:[{site:n,title_id:y,chapter_id:b}]}})}function _(n,y,b){let q=b?`/m/${n}/${d}/${b.id}`:`/m/${n}/${d}`;return m("div.chapter--buttons",[y?m(m.route.Link,{class:"touch-friendly chapter--prev-button",href:`/m/${n}/${d}/${y.id}`},[m("i.icon.icon-chevrons-left"),m("span","prev")]):m(w,{class:"chapter--prev-button",text:"prev",icon:"chevrons-left",disabled:!0}),m(m.route.Link,{class:"touch-friendly",href:`/m/${n}/${d}`},[m("i.icon.icon-list"),m("span"," chapter list")]),m(m.route.Link,{class:"touch-friendly chapter--next-button"+(r?" disabled":""),href:q,disabled:r,onclick:T=>{a.isLoggedIn()&&(b?S(n,d,o.id):(T.preventDefault(),r=!0,m.redraw(),S(n,d,o.id).finally(()=>{r=!1,m.route.set(q)})))}},[m("span",b?"next":r?"finishing...":"finish"),r?null:m("i.icon.icon-"+(b?"chevrons-right":"check-circle"))])])}return{oncreate:n=>{document.addEventListener("keypress",i)},onremove:n=>{document.removeEventListener("keypress",i)},oninit:n=>{document.title="Manga chapter",s=n.attrs.site,d=n.attrs.titleId,e=!0,m.redraw(),x.get({site:n.attrs.site,titleId:n.attrs.titleId,chapterId:n.attrs.chapterId}).then(y=>{o=y,document.title=A(o),o.pages_alt.length>0?u=o.pages.map((b,q)=>[b,o.pages_alt[q]]):u=o.pages.map(b=>[b,null]),c(),c(),c()}).finally(()=>{e=!1})},view:n=>{if(e)return m("div.chapter.content",m(E));let{site:y,titleId:b}=n.attrs,q=o.prev_chapter,T=o.next_chapter;return m("div.chapter.content",[m("h1",A(o)),_(y,q,T),m("div",{class:"chapter--pages"+(o.is_webtoon?" chapter--webtoon":"")},[l.map((k,de)=>m("div.chapter--page-container",{key:k.src,style:{width:`${p}%`,backgroundColor:p===100?"transparent":"#333"}},[m(G,{src:k.src,altsrc:k.altsrc,style:{display:k.status===P.SUCCEEDED?"inline":"none"},onload:F=>{k.status=P.SUCCEEDED,c()},onerror:F=>{k.status=P.FAILED,c()}}),k.status===P.LOADING?m(ie):null,k.status===P.FAILED?m("div",{style:{"margin-bottom":".5rem"}},m(me,{page:k})):null])),u.map(()=>m(le))]),_(y,q,T),I.map(k=>m(G,{style:{display:"none"},onload:L,onerror:L,src:k.src,altsrc:k.altsrc}))])}}}var K=ce;function ue(t){let e=null,r=null,o=!1;return{oninit:l=>{document.title="Import from Tachiyomi"},view:l=>m("div.content",[m("h1","Importing from Tachiyomi"),m("form[enctype=multipart/form-data]",{onsubmit:u=>{u.preventDefault();let s=document.getElementById("tachiyomi").files[0],d=new FormData;d.append("tachiyomi",s),o=!0,e=null,m.redraw(),a.request({method:"POST",url:"/api/import",body:d}).then(h=>{e=h.message,r=!0}).catch(h=>{e=h.response.message,r=!1}).finally(()=>{o=!1})}},[m("p",["Go to ",m("b","Settings > Backup > Create backup"),", then upload the generated json file here:"]),m("input[type=file][id=tachiyomi].importer--filepicker"),m("br"),m(w,{type:"submit",text:o?"uploading...":"upload",color:"green",icon:"upload",disabled:o?"disabled":null})]),m("p",{class:`importer--${r?"success":"failure"}`},e),r?m(m.route.Link,{href:"/f"},"See your following list here."):null])}}var B=ue;a.init().then(()=>{let t=document.getElementById("spa-root");m.route.prefix="",m.route(t,"/",{"/":{onmatch:()=>{if(a.isLoggedIn())m.route.set("/f",null,{replace:!0});else return O},render:e=>m(C,e)},"/a":{onmatch:()=>{if(a.isLoggedIn())m.route.set("/f",null,{replace:!0});else return M},render:e=>m(C,e)},"/f":{onmatch:()=>{if(a.isLoggedIn())return N;m.route.set("/a",null,{replace:!0})},render:e=>m(C,e)},"/s/:query":{render:e=>m(C,m(R,{query:e.attrs.query,key:e.attrs.query}))},"/m/:site/:titleId":{render:e=>m(C,m(U,{site:e.attrs.site,titleId:e.attrs.titleId}))},"/m/:site/:titleId/:chapterId":{render:e=>m(C,m(K,{site:e.attrs.site,titleId:e.attrs.titleId,chapterId:e.attrs.chapterId,key:e.attrs.chapterId}))},"/i":{onmatch:()=>{if(a.isLoggedIn())return B;m.route.set("/a",null,{replace:!0})},render:e=>m(C,e)}})});})();
//# sourceMappingURL=main.min.js.map
