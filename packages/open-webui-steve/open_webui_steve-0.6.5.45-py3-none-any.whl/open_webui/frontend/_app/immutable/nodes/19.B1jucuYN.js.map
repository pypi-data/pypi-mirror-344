{"version":3,"file":"19.B1jucuYN.js","sources":["../../../../../../src/lib/components/playground/Completions.svelte"],"sourcesContent":["<script lang=\"ts\">\r\n\timport { toast } from 'svelte-sonner';\r\n\r\n\timport { goto } from '$app/navigation';\r\n\timport { onMount, tick, getContext } from 'svelte';\r\n\r\n\timport { WEBUI_BASE_URL } from '$lib/constants';\r\n\timport { WEBUI_NAME, config, user, models, settings, showSidebar } from '$lib/stores';\r\n\timport { chatCompletion } from '$lib/apis/openai';\r\n\r\n\timport { splitStream } from '$lib/utils';\r\n\timport Selector from '$lib/components/chat/ModelSelector/Selector.svelte';\r\n\timport MenuLines from '../icons/MenuLines.svelte';\r\n\r\n\tconst i18n = getContext('i18n');\r\n\r\n\tlet loaded = false;\r\n\tlet text = '';\r\n\r\n\tlet selectedModelId = '';\r\n\r\n\tlet loading = false;\r\n\tlet stopResponseFlag = false;\r\n\r\n\tlet textCompletionAreaElement: HTMLTextAreaElement;\r\n\r\n\tconst scrollToBottom = () => {\r\n\t\tconst element = textCompletionAreaElement;\r\n\r\n\t\tif (element) {\r\n\t\t\telement.scrollTop = element?.scrollHeight;\r\n\t\t}\r\n\t};\r\n\r\n\tconst stopResponse = () => {\r\n\t\tstopResponseFlag = true;\r\n\t\tconsole.log('stopResponse');\r\n\t};\r\n\r\n\tconst textCompletionHandler = async () => {\r\n\t\tconst model = $models.find((model) => model.id === selectedModelId);\r\n\r\n\t\tconst [res, controller] = await chatCompletion(\r\n\t\t\tlocalStorage.token,\r\n\t\t\t{\r\n\t\t\t\tmodel: model.id,\r\n\t\t\t\tstream: true,\r\n\t\t\t\tmessages: [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\trole: 'assistant',\r\n\t\t\t\t\t\tcontent: text\r\n\t\t\t\t\t}\r\n\t\t\t\t]\r\n\t\t\t},\r\n\t\t\t`${WEBUI_BASE_URL}/api`\r\n\t\t);\r\n\r\n\t\tif (res && res.ok) {\r\n\t\t\tconst reader = res.body\r\n\t\t\t\t.pipeThrough(new TextDecoderStream())\r\n\t\t\t\t.pipeThrough(splitStream('\\n'))\r\n\t\t\t\t.getReader();\r\n\r\n\t\t\twhile (true) {\r\n\t\t\t\tconst { value, done } = await reader.read();\r\n\t\t\t\tif (done || stopResponseFlag) {\r\n\t\t\t\t\tif (stopResponseFlag) {\r\n\t\t\t\t\t\tcontroller.abort('User: Stop Response');\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\r\n\t\t\t\ttry {\r\n\t\t\t\t\tlet lines = value.split('\\n');\r\n\r\n\t\t\t\t\tfor (const line of lines) {\r\n\t\t\t\t\t\tif (line !== '') {\r\n\t\t\t\t\t\t\tif (line.includes('[DONE]')) {\r\n\t\t\t\t\t\t\t\tconsole.log('done');\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tlet data = JSON.parse(line.replace(/^data: /, ''));\r\n\t\t\t\t\t\t\t\tconsole.log(data);\r\n\r\n\t\t\t\t\t\t\t\ttext += data.choices[0].delta.content ?? '';\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (error) {\r\n\t\t\t\t\tconsole.log(error);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tscrollToBottom();\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tconst submitHandler = async () => {\r\n\t\tif (selectedModelId) {\r\n\t\t\tloading = true;\r\n\t\t\tawait textCompletionHandler();\r\n\r\n\t\t\tloading = false;\r\n\t\t\tstopResponseFlag = false;\r\n\t\t}\r\n\t};\r\n\r\n\tonMount(async () => {\r\n\t\tif ($user?.role !== 'admin') {\r\n\t\t\tawait goto('/');\r\n\t\t}\r\n\r\n\t\tif ($settings?.models) {\r\n\t\t\tselectedModelId = $settings?.models[0];\r\n\t\t} else if ($config?.default_models) {\r\n\t\t\tselectedModelId = $config?.default_models.split(',')[0];\r\n\t\t} else {\r\n\t\t\tselectedModelId = '';\r\n\t\t}\r\n\t\tloaded = true;\r\n\t});\r\n</script>\r\n\r\n<div class=\" flex flex-col justify-between w-full overflow-y-auto h-full\">\r\n\t<div class=\"mx-auto w-full md:px-0 h-full\">\r\n\t\t<div class=\" flex flex-col h-full px-4\">\r\n\t\t\t<div class=\"flex flex-col justify-between mb-1 gap-1\">\r\n\t\t\t\t<div class=\"flex flex-col gap-1 w-full\">\r\n\t\t\t\t\t<div class=\"flex w-full\">\r\n\t\t\t\t\t\t<div class=\"overflow-hidden w-full\">\r\n\t\t\t\t\t\t\t<div class=\"max-w-full\">\r\n\t\t\t\t\t\t\t\t<Selector\r\n\t\t\t\t\t\t\t\t\tplaceholder={$i18n.t('Select a model')}\r\n\t\t\t\t\t\t\t\t\titems={$models.map((model) => ({\r\n\t\t\t\t\t\t\t\t\t\tvalue: model.id,\r\n\t\t\t\t\t\t\t\t\t\tlabel: model.name,\r\n\t\t\t\t\t\t\t\t\t\tmodel: model\r\n\t\t\t\t\t\t\t\t\t}))}\r\n\t\t\t\t\t\t\t\t\tbind:value={selectedModelId}\r\n\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\r\n\t\t\t<div\r\n\t\t\t\tclass=\" pt-0.5 pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0\"\r\n\t\t\t\tid=\"messages-container\"\r\n\t\t\t>\r\n\t\t\t\t<div class=\" h-full w-full flex flex-col\">\r\n\t\t\t\t\t<div class=\"flex-1\">\r\n\t\t\t\t\t\t<textarea\r\n\t\t\t\t\t\t\tid=\"text-completion-textarea\"\r\n\t\t\t\t\t\t\tbind:this={textCompletionAreaElement}\r\n\t\t\t\t\t\t\tclass=\"w-full h-full p-3 bg-transparent border border-gray-100 dark:border-gray-850 outline-hidden resize-none rounded-lg text-sm\"\r\n\t\t\t\t\t\t\tbind:value={text}\r\n\t\t\t\t\t\t\tplaceholder={$i18n.t(\"You're a helpful assistant.\")}\r\n\t\t\t\t\t\t/>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\r\n\t\t\t<div class=\"pb-3 flex justify-end\">\r\n\t\t\t\t{#if !loading}\r\n\t\t\t\t\t<button\r\n\t\t\t\t\t\tclass=\"px-3.5 py-1.5 text-sm font-medium bg-black hover:bg-gray-900 text-white dark:bg-white dark:text-black dark:hover:bg-gray-100 transition rounded-full\"\r\n\t\t\t\t\t\ton:click={() => {\r\n\t\t\t\t\t\t\tsubmitHandler();\r\n\t\t\t\t\t\t}}\r\n\t\t\t\t\t>\r\n\t\t\t\t\t\t{$i18n.t('Run')}\r\n\t\t\t\t\t</button>\r\n\t\t\t\t{:else}\r\n\t\t\t\t\t<button\r\n\t\t\t\t\t\tclass=\"px-3 py-1.5 text-sm font-medium bg-gray-300 text-black transition rounded-full\"\r\n\t\t\t\t\t\ton:click={() => {\r\n\t\t\t\t\t\t\tstopResponse();\r\n\t\t\t\t\t\t}}\r\n\t\t\t\t\t>\r\n\t\t\t\t\t\t{$i18n.t('Cancel')}\r\n\t\t\t\t\t</button>\r\n\t\t\t\t{/if}\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n\r\n<style>\r\n\t.scrollbar-hidden::-webkit-scrollbar {\r\n\t\tdisplay: none; /* for Chrome, Safari and Opera */\r\n\t}\r\n\r\n\t.scrollbar-hidden {\r\n\t\t-ms-overflow-style: none; /* IE and Edge */\r\n\t\tscrollbar-width: none; /* Firefox */\r\n\t}\r\n</style>\r\n"],"names":["ctx","insert_hydration","target","button","anchor","set_data","t","t_value","func","create_if_block","div11","append_hydration","div10","div9","div4","div3","div2","div1","div0","div7","div6","div5","textarea","div8","dirty","selector_changes","model","i18n","getContext","text","selectedModelId","loading","stopResponseFlag","textCompletionAreaElement","scrollToBottom","element","stopResponse","textCompletionHandler","$models","res","controller","chatCompletion","WEBUI_BASE_URL","reader","splitStream","value","done","lines","line","data","$$invalidate","error","submitHandler","onMount","$user","goto","$settings","$config","$$value"],"mappings":"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"}