version: '3.8'

services:
  task1:
    image: registry.mthreads.com/public/kuae/vllm-mp22-py310:0415-dev
    entrypoint: ["/bin/sh", "-c"]
    command: ["service ssh start && sleep infinity"]
    networks:
      - host_net
    environment:
      - HOST_IP=${HOST_IP}
      - MODEL_PATH=${MODEL_PATH}

    deploy:
      replicas: 3
      placement:
        max_replicas_per_node: 1
        constraints:
          - node.role == worker    # 约束条件：仅在工作节点运行

  task2:
    image: registry.mthreads.com/public/kuae/vllm-mp22-py310:0415-dev
    entrypoint: ["/bin/sh", "-c"]
    command: ["service ssh start && sleep 5 && bash /tmp/run_deepseek_671b_r1.sh 8 4 $${MODEL_PATH} 16,15,15,15 "]
    networks:
      - host_net
    environment:
      - HOST_IP=${HOST_IP}
      - MODEL_PATH=${MODEL_PATH}

    deploy:
      replicas: 1                  # 根据工作节点数量调整
      placement:
        max_replicas_per_node: 1
        constraints:
          - node.role == manager   # 约束条件：仅在管理节点运行

  task3:
    image: mthreads-cn-beijing.cr.volces.com/kuaecloud/kuae-cloud-core-web:prod_ds_0.0.3
    networks:
      - host_net
    volumes:
      - type: bind
        source: /tmp/kuae-chat-public/
        target: /app/public/models/



    deploy:
      replicas: 1                  # 根据工作节点数量调整
      placement:
        max_replicas_per_node: 1
        constraints:
          - node.role == manager   # 约束条件：仅在管理节点运行

networks:
  host_net:
    external: true
    name: host  # 显式声明使用主机网络
