name: openapi publish on push

on:
  push:
    branches:
      - "**"
    tags-ignore:
      - '**'
  workflow_dispatch:

jobs:
  openapi-publish:
    name: OpenAPI Generate and Publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
      - name: Get branch name (merge)
        run: |
          BRANCH_NAME=$(echo ${{ github.ref }} | sed -e 's,.*/\(.*\),\1,')
          BRANCH_NAME=${BRANCH_NAME#v}
          echo "BRANCH_NAME=$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      - name: Setup python for openapi generate
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Generate openapi json
        if: ${{ github.event_name != 'workflow_dispatch' }}
        uses: ./.github/actions/openapi-generate
      - name: Commit Changes
        uses: EndBug/add-and-commit@v7
        if: ${{ github.event_name != 'workflow_dispatch' && env.OPENAPI_CHANGED == 'true' }}
        with:
          default_author: github_actions
          message: "Generated new openapi.json on push to ${{ github.event.inputs.git-ref }}"
          add: "api-docs/generated/openapi.json"
      - name: Setup nodejs
        uses: actions/setup-node@v4
        if: ${{ github.event_name == 'workflow_dispatch' || env.OPENAPI_CHANGED == 'true' }}
        with:
          node-version: '18'
      - name: Publish to stoplight
        if: ${{ github.event_name == 'workflow_dispatch' || env.OPENAPI_CHANGED == 'true' }}
        run: |
          npx @stoplight/cli@5 push --ci-token ${{ secrets.STOPLIGHT_PROJECT_TOKEN }} --url https://openg2p.stoplight.io --branch ${{ env.BRANCH_NAME }} --directory api-docs/generated
