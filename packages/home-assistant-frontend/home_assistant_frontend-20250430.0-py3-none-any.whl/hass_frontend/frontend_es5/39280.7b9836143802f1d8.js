"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([["39280"],{44548:function(t,e,o){o.a(t,(async function(t,r){try{o.d(e,{AH:()=>b,Ai:()=>w,Al:()=>A,vA:()=>v});var n=o(26306),s=o(34635),a=o(73228),i=o(11736),l=o(59085),c=o(46021),_=o(56858),g=o(7722),u=o(21343),f=o(29426),d=o(72937),y=o(27537),m=o(38763),p=t([y]);y=(p.then?(await p)():p)[0];const h=(t,e,o,r)=>{const n=o((0,y.zW)(t,e),r);return n instanceof Date?(0,y.Nm)(n,e):n},b=(t,e,o,r,n)=>o.time_zone===m.c_.server?h(t,r.time_zone,e,n):e(t,n),v=(t,e,o,r,n)=>o.time_zone===m.c_.server?h(t,r.time_zone,e,n):e(t,n),w=(t,e,o,r,n)=>v(t,o,r,n,r.time_zone===m.c_.server?(0,y.zW)(e,n.time_zone):e),A=(t,e,o,r,y)=>{let m,p;if(v(t,n.b,r,y)&&v(e,s.h,r,y)){const n=(w(e,t,a.d,r,y)+1)*(o?1:-1);m=b(t,i.z,r,y,n),p=b(b(e,i.z,r,y,n),l.V,r,y)}else if(v(t,(t=>(0,c.b)(t).getMilliseconds()===t.getMilliseconds()),r,y)&&v(e,(t=>(0,_.i)(t).getMilliseconds()===t.getMilliseconds()),r,y)){const n=(w(e,t,g.j,r,y)+1)*(o?1:-1);m=b(t,u.E,r,y,n),p=b(e,u.E,r,y,n)}else{const n=(w(e,t,f._,r,y)+1)*(o?1:-1);m=b(t,d.n,r,y,n),p=b(e,d.n,r,y,n)}return{start:m,end:p}};r()}catch(h){r(h)}}))},97711:function(t,e,o){o.a(t,(async function(t,r){try{o.d(e,{p:()=>w});var n=o(46021),s=o(56858),a=o(21343),i=o(66233),l=o(90964),c=o(98853),_=o(59085),g=o(40635),u=o(66297),f=o(2061),d=o(68503),y=o(25025),m=o(20215),p=o(38039),h=o(44548),b=o(34302),v=t([b,h]);[b,h]=v.then?(await v)():v;const w=(t,e)=>{const o=new Date,r=(0,b.Bt)(t.locale);switch(e){case"today":return[(0,h.AH)(o,n.b,t.locale,t.config,{weekStartsOn:r}),(0,h.AH)(o,s.i,t.locale,t.config,{weekStartsOn:r})];case"yesterday":return[(0,h.AH)((0,a.E)(o,-1),n.b,t.locale,t.config,{weekStartsOn:r}),(0,h.AH)((0,a.E)(o,-1),s.i,t.locale,t.config,{weekStartsOn:r})];case"this_week":return[(0,h.AH)(o,i.z,t.locale,t.config,{weekStartsOn:r}),(0,h.AH)(o,l.v,t.locale,t.config,{weekStartsOn:r})];case"this_month":return[(0,h.AH)(o,c.N,t.locale,t.config),(0,h.AH)(o,_.V,t.locale,t.config)];case"this_quarter":return[(0,h.AH)(o,g.x,t.locale,t.config),(0,h.AH)(o,u.x,t.locale,t.config)];case"this_year":return[(0,h.AH)(o,f.e,t.locale,t.config),(0,h.AH)(o,d.w,t.locale,t.config)];case"now-7d":return[(0,h.AH)(o,y.k,t.locale,t.config,7),(0,h.AH)(o,y.k,t.locale,t.config,0)];case"now-30d":return[(0,h.AH)(o,y.k,t.locale,t.config,30),(0,h.AH)(o,y.k,t.locale,t.config,0)];case"now-12m":return[(0,h.AH)((0,m.W)(o,12),c.N,t.locale,t.config),(0,h.AH)((0,m.W)(o,1),_.V,t.locale,t.config)];case"now-1h":return[(0,h.AH)(o,p.b,t.locale,t.config,1),(0,h.AH)(o,p.b,t.locale,t.config,0)];case"now-12h":return[(0,h.AH)(o,p.b,t.locale,t.config,12),(0,h.AH)(o,p.b,t.locale,t.config,0)];case"now-24h":return[(0,h.AH)(o,p.b,t.locale,t.config,24),(0,h.AH)(o,p.b,t.locale,t.config,0)]}return[o,o]};r()}catch(w){r(w)}}))},64564:function(t,e,o){o.d(e,{v:()=>r});o(26847),o(2394),o(27530);const r=(t,e)=>{const o={};for(const r of t){const t=e(r);t in o?o[t].push(r):o[t]=[r]}return o}},6640:function(t,e,o){o.a(t,(async function(t,r){try{o.d(e,{Bm:()=>k,Cj:()=>O,E4:()=>Q,EH:()=>U,G9:()=>$,Jj:()=>x,KU:()=>W,P:()=>E,ST:()=>Y,UB:()=>K,ZC:()=>z,_Z:()=>M,b:()=>G,gy:()=>j,iK:()=>S,jB:()=>N,kJ:()=>J,o1:()=>T,rl:()=>D,vE:()=>q,xZ:()=>C,yH:()=>L});o(40777),o(39710),o(26847),o(2394),o(18574),o(81738),o(22960),o(6989),o(87799),o(1455),o(67886),o(65451),o(46015),o(38334),o(94880),o(75643),o(29761),o(56389),o(44261),o(27530);var n=o(7722),s=o(26306),a=o(34635),i=o(11736),l=o(73228),c=o(21343),_=o(72937),g=o(46021),u=o(56858),f=o(46363),d=o(5657),y=o(28105),m=o(44548),p=o(45691),h=o(64564),b=o(7214),v=o(97711),w=o(28598),A=t([p,v,m,w]);[p,v,m,w]=A.then?(await A)():A;const H=[],k=()=>({stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),T=()=>({stat_energy_to:"",stat_compensation:null,entity_energy_price:null,number_energy_price:null}),S=()=>({type:"grid",flow_from:[],flow_to:[],cost_adjustment_day:0}),D=()=>({type:"solar",stat_energy_from:"",config_entry_solar_forecast:null}),E=()=>({type:"battery",stat_energy_from:"",stat_energy_to:""}),W=()=>({type:"gas",stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),O=()=>({type:"water",stat_energy_from:"",stat_cost:null,entity_energy_price:null,number_energy_price:null}),C=t=>t.callWS({type:"energy/info"}),j=async t=>(await t.loadBackendTranslation("issues","energy"),t.callWS({type:"energy/validate"})),z=t=>t.callWS({type:"energy/get_prefs"}),M=async(t,e)=>{const o=t.callWS(Object.assign({type:"energy/save_prefs"},e));return B(t),o},P=async(t,e,o,r,n,s="hour")=>t.callWS({type:"energy/fossil_energy_consumption",start_time:e.toISOString(),end_time:null==n?void 0:n.toISOString(),energy_statistic_ids:o,co2_statistic_id:r,period:s}),x=t=>(0,h.v)(t.energy_sources,(t=>t.type)),L=(t,e,o)=>{const r=[];for(const n of t.energy_sources)if(!o||o.includes(n.type))if("solar"!==n.type)if("gas"!==n.type&&"water"!==n.type)if("battery"!==n.type){for(const t of n.flow_from){r.push(t.stat_energy_from),t.stat_cost&&r.push(t.stat_cost);const o=e.cost_sensors[t.stat_energy_from];o&&r.push(o)}for(const t of n.flow_to){r.push(t.stat_energy_to),t.stat_compensation&&r.push(t.stat_compensation);const o=e.cost_sensors[t.stat_energy_to];o&&r.push(o)}}else r.push(n.stat_energy_from),r.push(n.stat_energy_to);else{r.push(n.stat_energy_from),n.stat_cost&&r.push(n.stat_cost);const t=e.cost_sensors[n.stat_energy_from];t&&r.push(t)}else r.push(n.stat_energy_from);return o&&!o.includes("device")||r.push(...t.device_consumption.map((t=>t.stat_consumption))),r},Z=async(t,e,o,r,g)=>{const u=await C(t);let f;for(const n of Object.values(t.entities)){if("co2signal"!==n.platform)continue;const e=t.states[n.entity_id];if(e&&"%"===e.attributes.unit_of_measurement){f=e.entity_id;break}}const d=[];for(const n of e.energy_sources)if("grid"===n.type)for(const t of n.flow_from)d.push(t.stat_energy_from);const y=L(e,u,["grid","solar","battery","gas","device"]),p=L(e,u,["water"]),h=[...y,...p],v=(0,n.j)(r||new Date,o),w=(0,s.b)(o)&&(!r||(0,a.h)(r))&&v>35?"month":v>2?"day":"hour",A=t.config.unit_system.length||"",H={energy:"kWh",volume:"km"===A?"m続":"ft続"},k={volume:"km"===A?"L":"gal"},T=y.length?(0,b.dL)(t,o,r,y,w,H,["change"]):{},S=p.length?(0,b.dL)(t,o,r,p,w,k,["change"]):{};let D,E,W,O,j,z={},M={};g&&(E=(0,m.vA)(o,s.b,t.locale,t.config)&&(0,m.vA)(r||new Date,a.h,t.locale,t.config)?(0,m.AH)(o,i.z,t.locale,t.config,-(0,m.Ai)(r||new Date,o,l.d,t.locale,t.config)-1):(0,m.AH)(o,c.E,t.locale,t.config,-1*(v+1)),W=(0,_.n)(o,-1),y.length&&(z=(0,b.dL)(t,E,W,y,w,H,["change"])),p.length&&(M=(0,b.dL)(t,E,W,p,w,k,["change"]))),void 0!==f&&(O=P(t,o,d,f,r,v>35?"month":v>2?"day":"hour"),g&&(j=P(t,E,d,f,W,v>35?"month":v>2?"day":"hour")));const x={},Z=h.length?(0,b.Py)(t,h):[],[B,I,K,N,V,$,q]=await Promise.all([T,S,z,M,Z,O,j]),G=Object.assign(Object.assign({},B),I);g&&(D=Object.assign(Object.assign({},K),N)),h.length&&V.forEach((t=>{x[t.statistic_id]=t}));return{start:o,end:r,startCompare:E,endCompare:W,info:u,prefs:e,stats:G,statsMetadata:x,statsCompare:D,co2SignalEntity:f,fossilEnergyConsumption:$,fossilEnergyConsumptionCompare:q}},B=t=>{H.forEach((e=>{const o=K(t,{key:e});o.clearPrefs(),o._active&&o.refresh()}))},I=t=>{if(t._refreshTimeout&&clearTimeout(t._refreshTimeout),t._active&&(!t.end||t.end>new Date)){const e=new Date;e.getMinutes()>=20&&e.setHours(e.getHours()+1),e.setMinutes(20,0,0),t._refreshTimeout=window.setTimeout((()=>t.refresh()),e.getTime()-Date.now())}},K=(t,e={})=>{let o="_energy";if(e.key){if(!e.key.startsWith("energy_"))throw new Error("Key need to start with energy_");o=`_${e.key}`}if(t.connection[o])return t.connection[o];H.push(e.key);const r=(0,d._)(t.connection,o,(async()=>(r.prefs||(r.prefs=await z(t)),I(r),Z(t,r.prefs,r.start,r.end,r.compare)))),n=r.subscribe;r.subscribe=t=>{const e=n(t);return r._active++,void 0===r._refreshTimeout&&I(r),()=>{r._active--,r._active<1&&(clearTimeout(r._refreshTimeout),r._refreshTimeout=void 0),e()}},r._active=0,r.prefs=e.prefs;const s=new Date,a=(0,p.Zs)(s,t.locale,t.config).split(":")[0],i=localStorage.getItem(`energy-default-period-${o}`)||"today",l="today"===i&&"0"===a?"yesterday":i;[r.start,r.end]=(0,v.p)(t,l);const c=()=>{r._updatePeriodTimeout=window.setTimeout((()=>{r.start=(0,m.AH)(new Date,g.b,t.locale,t.config),r.end=(0,m.AH)(new Date,u.i,t.locale,t.config),c()}),(0,f.T)((0,m.AH)(new Date,u.i,t.locale,t.config),1).getTime()-Date.now())};return c(),r.clearPrefs=()=>{r.prefs=void 0},r.setPeriod=(e,o)=>{var n;r._updatePeriodTimeout&&(clearTimeout(r._updatePeriodTimeout),r._updatePeriodTimeout=void 0),r.start=e,r.end=o,r.start.getTime()===(0,m.AH)(new Date,g.b,t.locale,t.config).getTime()&&(null===(n=r.end)||void 0===n?void 0:n.getTime())===(0,m.AH)(new Date,u.i,t.locale,t.config).getTime()&&c()},r.setCompare=t=>{r.compare=t},r},N=t=>t.callWS({type:"energy/solar_forecast"}),V=["volume","energy"],$=(t,e,o={})=>{for(const r of t.energy_sources){if("gas"!==r.type)continue;if(e&&e===r.stat_energy_from)continue;const t=o[r.stat_energy_from];if(V.includes(null==t?void 0:t.unit_class))return t.unit_class}},q=(t,e,o={})=>"energy"===$(e,void 0,o)?"kWh":"km"===t.config.unit_system.length?"m続":"ft続",G=t=>"km"===t.config.unit_system.length?"L":"gal",J="/docs/energy/faq/#troubleshooting-missing-entities",U=(0,y.Z)((t=>({summedData:F(t),compareSummedData:t.statsCompare?F(t,!0):void 0}))),F=(t,e)=>{const o={};for(const s of t.prefs.energy_sources)if("solar"!==s.type)if("battery"!==s.type){if("grid"===s.type){for(const t of s.flow_from)o.from_grid?o.from_grid.push(t.stat_energy_from):o.from_grid=[t.stat_energy_from];for(const t of s.flow_to)o.to_grid?o.to_grid.push(t.stat_energy_to):o.to_grid=[t.stat_energy_to]}}else o.to_battery?(o.to_battery.push(s.stat_energy_to),o.from_battery.push(s.stat_energy_from)):(o.to_battery=[s.stat_energy_to],o.from_battery=[s.stat_energy_from]);else o.solar?o.solar.push(s.stat_energy_from):o.solar=[s.stat_energy_from];const r={total:{},timestamps:[]},n=new Set;return Object.entries(o).forEach((([o,s])=>{const a={},i={};let l=0;s.forEach((o=>{const r=e?t.statsCompare[o]:t.stats[o];if(!r)return;r.forEach((t=>{if(null===t.change||void 0===t.change)return;const e=t.change;l+=e,a[t.start]=t.start in a?a[t.start]+e:e,n.add(t.start)})),i[o]={}})),r[o]=a,r.total[o]=l})),r.timestamps=Array.from(n).sort(),r},Q=(0,y.Z)(((t,e)=>({consumption:R(t),compareConsumption:e?R(e):void 0}))),R=t=>{const e={used_total:{},grid_to_battery:{},battery_to_grid:{},solar_to_battery:{},solar_to_grid:{},used_solar:{},used_grid:{},used_battery:{},total:{used_total:0,grid_to_battery:0,battery_to_grid:0,solar_to_battery:0,solar_to_grid:0,used_solar:0,used_grid:0,used_battery:0}};return t.timestamps.forEach((o=>{var r,n,s,a,i,l,c,_,g,u;const f=((null===(r=t.from_grid)||void 0===r?void 0:r[o])||0)+((null===(n=t.solar)||void 0===n?void 0:n[o])||0)+((null===(s=t.from_battery)||void 0===s?void 0:s[o])||0)-((null===(a=t.to_grid)||void 0===a?void 0:a[o])||0)-((null===(i=t.to_battery)||void 0===i?void 0:i[o])||0);e.used_total[o]=f,e.total.used_total+=f;const{grid_to_battery:d,battery_to_grid:y,used_solar:m,used_grid:p,used_battery:h,solar_to_battery:b,solar_to_grid:v}=X({from_grid:t.from_grid&&(null!==(l=t.from_grid[o])&&void 0!==l?l:0),to_grid:t.to_grid&&(null!==(c=t.to_grid[o])&&void 0!==c?c:0),solar:t.solar&&(null!==(_=t.solar[o])&&void 0!==_?_:0),to_battery:t.to_battery&&(null!==(g=t.to_battery[o])&&void 0!==g?g:0),from_battery:t.from_battery&&(null!==(u=t.from_battery[o])&&void 0!==u?u:0)});e.grid_to_battery[o]=d,e.total.grid_to_battery+=d,e.battery_to_grid[o]=y,e.total.battery_to_grid+=y,e.used_battery[o]=h,e.total.used_battery+=h,e.used_grid[o]=p,e.total.used_grid+=p,e.used_solar[o]=m,e.total.used_solar+=m,e.solar_to_battery[o]=b,e.total.solar_to_battery+=b,e.solar_to_grid[o]=v,e.total.solar_to_grid+=v})),e},X=t=>{const e=t.to_grid,o=t.to_battery,r=t.solar,n=t.from_grid,s=t.from_battery;let a=0,i=0,l=0,c=0,_=0,g=0,u=0;return null==e&&null==o||null==r||(a=(r||0)-(e||0)-(o||0),a<0&&(null!=o&&(i=-1*a,i>(n||0)&&(l=i-(n||0),i=n||0)),a=0)),null!=s&&(g=(s||0)-l),null!=n&&(u=n-i),null!=r&&(null!=o&&(c=Math.max(0,(o||0)-i)),null!=e&&(_=Math.max(0,(e||0)-l))),{used_solar:a,used_grid:u,used_battery:g,grid_to_battery:i,battery_to_grid:l,solar_to_battery:c,solar_to_grid:_}},Y=(t,e,o)=>{if(!e)return`0 ${o}`;const r=["kWh","MWh","GWh","TWh"];let n=o,s=e,a=r.findIndex((t=>t===o));if(a>=0){for(;s>=1e3&&a<r.length-1;)s/=1e3,a++;n=r[a]}return(0,w.uf)(s,t.locale,{maximumFractionDigits:s<10?2:s<100?1:0})+" "+n};r()}catch(H){r(H)}}))}}]);
//# sourceMappingURL=39280.7b9836143802f1d8.js.map