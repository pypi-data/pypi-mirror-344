# Generated by Django 3.2.20 on 2023-08-01 14:45

from django.db import migrations

from core.utils import insert_role_right_for_system

SCHEMA_ADMIN_ID = 4194304
IMIS_ADMIN = 64
ROLE_NAME = "Schema Admin"
SCHEMA_ADMIN_ROLE_RIGHTS = ["171001", "171002", "171003", "171004"]


def _get_role(role_id, Role):
    return Role.objects.filter(is_system=role_id).first()


def _add_rights_to_role(role, apps):
    for right in SCHEMA_ADMIN_ROLE_RIGHTS:
        insert_role_right_for_system(role, right, apps)


def _remove_rights_from_role(role, RoleRight):
    RoleRight.objects.filter(
        role__is_system=role,
        right_id__in=SCHEMA_ADMIN_ROLE_RIGHTS,
        validity_to__isnull=True
    ).delete()


def _create_task_triage_role(Role):
    role = _get_role(SCHEMA_ADMIN_ID, Role)
    if not role:
        task_triage = Role(is_system=SCHEMA_ADMIN_ID, name=ROLE_NAME, is_blocked=False)
        task_triage.save()


def _delete_task_triage_role(Role):
    role = _get_role(SCHEMA_ADMIN_ID, Role)
    if role:
        role.delete()


def on_migration(apps, schema_editor):
    Role = apps.get_model('core', 'Role')
    _create_task_triage_role(Role)
    _add_rights_to_role(IMIS_ADMIN, apps)
    _add_rights_to_role(SCHEMA_ADMIN_ID, apps)


def on_migration_reverse(apps, schema_editor):
    RoleRight = apps.get_model('core', 'RoleRight')
    Role = apps.get_model('core', 'Role')
    _remove_rights_from_role(IMIS_ADMIN, RoleRight)
    _remove_rights_from_role(SCHEMA_ADMIN_ID, RoleRight)
    _delete_task_triage_role(Role)


class Migration(migrations.Migration):
    dependencies = [
        ('social_protection', '0008_benefitplandatauploadrecords_historicalbenefitplandatauploadrecords'),
    ]

    operations = [
        migrations.RunPython(on_migration, on_migration_reverse)
    ]
