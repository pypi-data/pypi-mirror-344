(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1617],{54543:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/systems/configure/[id]/test-datasets",function(){return s(94010)}])},18225:function(e,t,s){"use strict";var n=s(24246),r=s(91922);t.Z=e=>{let{...t}=e;return(0,n.jsx)(r.kCb,{boxSize:"full",align:"center",justify:"center",children:(0,n.jsx)(r.$jN,{color:"primary",...t})})}},812:function(e,t,s){"use strict";s.d(t,{D4:function(){return i.D4},MM:function(){return f},Ot:function(){return c},c6:function(){return r},cj:function(){return h},e$:function(){return l},fn:function(){return o},iC:function(){return y},nU:function(){return d},tB:function(){return u}});var n,r,i=s(19043);let a="An unexpected error occurred. Please try again.",l=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a;if((0,i.Bw)(e)){if((0,i.hE)(e.data))return e.data.detail;if((0,i.cz)(e.data)){var s;let t=null===(s=e.data.detail)||void 0===s?void 0:s[0];return"".concat(null==t?void 0:t.msg,": ").concat(null==t?void 0:t.loc)}if(409===e.status&&(0,i.Dy)(e.data)||404===e.status&&(0,i.XD)(e.data))return"".concat(e.data.detail.error," (").concat(e.data.detail.fides_key,")")}return t};function o(e){return"object"==typeof e&&null!=e&&"status"in e}function c(e){return"object"==typeof e&&null!=e&&"data"in e&&"string"==typeof e.data.detail}function u(e){return"object"==typeof e&&null!=e&&"data"in e&&Array.isArray(e.data.detail)}let d=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{status:500,message:a};if((0,i.oK)(e))return{status:e.originalStatus,message:e.data};if((0,i.Bw)(e)){let{status:s}=e;return{status:s,message:l(e,t.message)}}return t},f=e=>Object.entries(e).map(e=>({value:e[1],label:e[1]}));(n=r||(r={})).GVL="gvl",n.AC="gacp",n.COMPASS="compass";let y={gvl:{label:"GVL",fullName:"Global Vendor List"},gacp:{label:"AC",fullName:"Google Additional Consent List"},compass:{label:"",fullName:""}},h=e=>{let t=e.split(".")[0];return"gacp"===t?"gacp":"gvl"===t?"gvl":"compass"}},46628:function(e,t,s){"use strict";s.d(t,{MA:function(){return l},Vo:function(){return c},t5:function(){return o}});var n=s(24246),r=s(91922);let i=e=>{let{children:t,title:s="Success"}=e;return(0,n.jsxs)(r.xvT,{"data-testid":"toast-success-msg",children:[(0,n.jsxs)("strong",{children:[s,":"]})," ",t]})},a=e=>{let{children:t}=e;return(0,n.jsxs)(r.xvT,{"data-testid":"toast-error-msg",children:[(0,n.jsx)("strong",{children:"Error:"})," ",t]})},l={variant:"subtle",position:"top",description:"",duration:5e3,status:"success",isClosable:!0},o=(e,t)=>{let s=(0,n.jsx)(i,{title:t,children:e});return{...l,description:s}},c=e=>{let t=(0,n.jsx)(a,{children:e});return{...l,description:t,status:"error"}}},94010:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return M}});var n=s(24246),r=s(91922),i=s(86677),a=s(27378),l=s(16134),o=s(18225),c=s(77213),u=s(77830),d=s(58754),f=s(1315),y=s(66527),h=s(88340),p=s(812),m=s(46628),v=s(41207),g=s(41966),x=s(94725),j=s(88124);let b=e=>Array.isArray(e)?e.map(e=>b(e)).filter(e=>null!==e):e&&"object"==typeof e?Object.fromEntries(Object.entries(e).map(e=>{let[t,s]=e;return[t,b(s)]}).filter(e=>{let[,t]=e;return null!==t})):e,_=e=>{if(Array.isArray(e)){let t=e[0];if(!t)return"";let s=t.msg||"",n=t.loc?" (".concat(t.loc,")"):"";return"".concat(s).concat(n)}return e};var k=e=>{let{connectionKey:t}=e,s=(0,r.pmc)(),i=(0,l.T)(),[o]=(0,g.TG)(),[c,u]=(0,a.useState)(""),d=(0,l.C)(j.fD),f=(0,l.C)(j.lR),{data:k,isLoading:w,refetch:T}=(0,x.Eg)(t,{skip:!t}),{data:S,refetch:C}=(0,x.tW)({connectionKey:t,datasetKey:(null==d?void 0:d.fides_key)||"",policyKey:f},{skip:!t||!(null==d?void 0:d.fides_key)||!f});(0,a.useEffect)(()=>{S&&i((0,j.x0)(S.reachable))},[S,i]);let E=(0,a.useMemo)(()=>((null==k?void 0:k.items)||[]).map(e=>({value:e.fides_key,label:e.fides_key})),[null==k?void 0:k.items]);(0,a.useEffect)(()=>{if((null==k?void 0:k.items.length)&&(!d||!k.items.find(e=>e.fides_key===d.fides_key))){let e=k.items[0];i((0,j.w7)(e))}},[k,d,i]),(0,a.useEffect)(()=>{(null==d?void 0:d.ctl_dataset)&&u(y.ZP.dump(b(null==d?void 0:d.ctl_dataset)))},[d]),(0,a.useEffect)(()=>{f&&(null==d?void 0:d.fides_key)&&t&&C()},[f,null==d?void 0:d.fides_key,t,C]),(0,a.useEffect)(()=>{S&&i((0,j.x0)(S.reachable))},[S,i]);let N=async e=>{let t=null==k?void 0:k.items.find(t=>t.fides_key===e);t&&i((0,j.w7)(t))},R=async()=>{let e;if(!d)return;try{e=y.ZP.load(c)}catch(e){s((0,m.Vo)("YAML Parsing Error: ".concat(e instanceof y._L?"".concat(e.reason," ").concat(e.mark?"at line ".concat(e.mark.line):""):"Invalid YAML format")));return}let t=await o(e);if((0,p.D4)(t)){s((0,m.Vo)((0,p.e$)(t.error)));return}i((0,j.w7)({fides_key:d.fides_key,ctl_dataset:t.data})),s((0,m.t5)("Successfully modified dataset")),await T(),await C()},O=async()=>{try{let{data:e}=await T(),t=null==e?void 0:e.items.find(e=>e.fides_key===(null==d?void 0:d.fides_key));(null==t?void 0:t.ctl_dataset)&&u(y.ZP.dump(b(t.ctl_dataset))),s((0,m.t5)("Successfully refreshed datasets"))}catch(e){s((0,m.Vo)((0,p.e$)(e)))}};return(0,n.jsxs)(r.gCW,{alignItems:"stretch",flex:"1",maxWidth:"70vw",maxHeight:"100vh",children:[(0,n.jsxs)(r.X6q,{as:"h3",size:"sm",display:"flex",alignItems:"center",justifyContent:"space-between",children:[(0,n.jsxs)(r.Ugi,{children:[(0,n.jsx)(r.xvT,{children:"Edit dataset: "}),(0,n.jsx)(r.WPr,{id:"format","data-testid":"export-format-select",value:(null==d?void 0:d.fides_key)||"",options:E,onChange:N,className:"w-64"}),(0,n.jsx)(h.Z,{copyText:c})]}),(0,n.jsxs)(r.Ugi,{spacing:2,children:[(0,n.jsx)(r.esZ,{title:"Refresh to load the latest data from the database. This will overwrite any unsaved local changes.",placement:"top",children:(0,n.jsx)(r.wpx,{htmlType:"submit",size:"small","data-testid":"refresh-btn",onClick:O,loading:w,children:"Refresh"})}),(0,n.jsx)(r.esZ,{title:"Save your changes to update the dataset in the database.",placement:"top",children:(0,n.jsx)(r.wpx,{htmlType:"submit",size:"small",onClick:R,children:"Save"})})]})]}),(0,n.jsx)(r.Kqy,{border:"1px solid",borderColor:"gray.200",borderRadius:"md",justifyContent:"space-between",py:4,pr:4,"data-testid":"empty-state",flex:"1 1 auto",minHeight:"200px",children:(0,n.jsx)(v.M,{defaultLanguage:"yaml",value:c,height:"100%",onChange:e=>u(e||""),onMount:()=>{},options:{fontFamily:"Menlo",fontSize:13,minimap:{enabled:!1},readOnly:!1,hideCursorInOverviewRuler:!0,overviewRulerBorder:!1,scrollBeyondLastLine:!1},theme:"light"})}),S&&(0,n.jsx)(r.Kqy,{backgroundColor:(null==S?void 0:S.reachable)?"green.50":"red.50",border:"1px solid",borderColor:(null==S?void 0:S.reachable)?"green.500":"red.500",borderRadius:"md",p:2,flexShrink:0,mt:2,children:(0,n.jsx)(r.Ugi,{alignItems:"center",children:(0,n.jsxs)(r.Ugi,{flex:"1",children:[(null==S?void 0:S.reachable)?(0,n.jsx)(r.StI,{}):(0,n.jsx)(r.f9v,{}),(0,n.jsx)(r.xvT,{fontSize:"sm",whiteSpace:"pre-wrap",children:(null==S?void 0:S.reachable)?"Dataset is reachable":"Dataset is not reachable. ".concat(_(null==S?void 0:S.details))})]})})})]})},w=s(54458),T=s(16125),S=s(99716);let C=e=>{let t=new Date(e);return(0,w.WU)(t,"yyyy-MM-dd HH:mm:ss.SSS")},E=e=>{switch(e){case"ERROR":return"red.500";case"WARNING":return"orange.500";case"INFO":return"blue.500";default:return"gray.500"}},N=(0,a.memo)(e=>{let{log:t}=e;return(0,n.jsxs)(r.xuv,{as:"pre",margin:0,fontSize:"xs",fontFamily:"monospace",whiteSpace:"pre-wrap",wordBreak:"break-word",children:[(0,n.jsx)(r.xvT,{as:"span",color:"green.500",children:C(t.timestamp)}),(0,n.jsx)(r.xvT,{as:"span",children:" | "}),(0,n.jsx)(r.xvT,{as:"span",color:E(t.level),children:t.level.padEnd(8)}),(0,n.jsx)(r.xvT,{as:"span",children:" | "}),(0,n.jsx)(r.xvT,{as:"span",color:"cyan.500",children:t.module_info}),(0,n.jsx)(r.xvT,{as:"span",children:" - "}),(0,n.jsx)(r.xvT,{as:"span",color:"ERROR"===t.level||"WARNING"===t.level?E(t.level):"gray.800",children:t.message})]})});N.displayName="LogLine";var R=(0,a.memo)(()=>{let e=(0,l.T)(),t=(0,a.useRef)(null),s=(0,T.v9)(j.HN),i=(0,T.v9)(j.pz),{data:o}=(0,S.fV)({privacy_request_id:s},{skip:!s,pollingInterval:1e3});(0,a.useEffect)(()=>{o&&e((0,j.Hy)(o))},[o,e]);let c=(0,a.useCallback)(()=>{t.current&&(t.current.scrollTop=t.current.scrollHeight)},[]);(0,a.useEffect)(()=>{c()},[i,c]);let u=(0,a.useMemo)(()=>(null==i?void 0:i.map(e=>"".concat(C(e.timestamp)," | ").concat(e.level," | ").concat(e.module_info," - ").concat(e.message)).join("\n"))||"",[i]);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.X6q,{as:"h3",size:"sm",display:"flex",alignItems:"center",justifyContent:"space-between",children:(0,n.jsxs)(r.Ugi,{children:[(0,n.jsx)(r.xvT,{children:"Test logs"}),(0,n.jsx)(h.Z,{copyText:u})]})}),(0,n.jsx)(r.xuv,{ref:t,height:"200px",overflowY:"auto",borderWidth:1,borderColor:"gray.200",borderRadius:"md",p:2,children:null==i?void 0:i.map(e=>(0,n.jsx)(N,{log:e},"".concat(e.timestamp,"-").concat(e.module_info,"-").concat(e.message)))})]})}),O=s(46238);let{useGetPoliciesQuery:A}=s(78780).u.injectEndpoints({endpoints:e=>({getPolicies:e.query({query:()=>({url:"/dsr/policy"}),providesTags:()=>["Policies"]})})});var D=s(16643),q=s(31883),I=e=>{let{connectionKey:t}=e,s=(0,r.pmc)(),i=(0,l.T)(),[o]=(0,x.s7)(),c=(0,T.v9)(j.fD),u=(0,T.v9)(j.YS),d=(0,T.v9)(j.Af),f=(0,T.v9)(j.zn),y=(0,T.v9)(j.lR),v=(0,T.v9)(j.M_),g=(0,T.v9)(j.HN),[b,_]=(0,a.useState)("{}");(0,a.useEffect)(()=>{c&&_(JSON.stringify(f,null,2))},[c,f]);let{data:k,error:w}=(0,S.Z2)({privacy_request_id:g},{skip:!g||!(null==c?void 0:c.fides_key),pollingInterval:2e3}),{refetch:C}=(0,S.fV)({privacy_request_id:g},{skip:!g}),{refetch:E}=(0,x.I1)({connectionKey:t,datasetKey:(null==c?void 0:c.fides_key)||""},{skip:!t||!(null==c?void 0:c.fides_key),refetchOnMountOrArgChange:!0}),{data:N}=A(),R=(0,a.useMemo)(()=>((null==N?void 0:N.items)||[]).filter(e=>{var t;return null===(t=e.rules)||void 0===t?void 0:t.some(e=>"access"===e.action_type)}).map(e=>({value:e.key,label:e.name})),[null==N?void 0:N.items]);(0,a.useEffect)(()=>{let e=null==c?void 0:c.fides_key;t&&e&&E().then(t=>{t.data&&(null==c?void 0:c.fides_key)===e&&i((0,j.qD)({datasetKey:e,values:t.data}))})},[c,t,i,E]),(0,a.useEffect)(()=>{let e=null==c?void 0:c.fides_key;if(w&&"status"in w&&404===w.status){i((0,j.hT)()),s((0,m.Vo)("Test run failed"));return}if(!k||k.privacy_request_id!==g||!e)return;let t={datasetKey:e,values:JSON.stringify(k,null,2)};k.status===D.q2.COMPLETE?v&&C().then(()=>{i((0,j.EO)(t)),i((0,j.hT)()),s((0,m.t5)("Test run completed successfully"))}):k.status===D.q2.ERROR&&C().then(()=>{i((0,j.EO)(t)),i((0,j.hT)()),s((0,m.Vo)("Test run failed"))})},[k,w,g,c,v,i,s,C]);let I=(0,a.useMemo)(()=>y&&(null==N?void 0:N.items)?y:null,[y,null==N?void 0:N.items]),L=async()=>{if((null==c?void 0:c.fides_key)&&y)try{let e;try{e=JSON.parse(b)}catch(e){s((0,m.Vo)("Invalid JSON in test input"));return}i((0,j.Vh)(c.fides_key)),s((0,m.t5)("Test run started"));let n=await o({connection_key:t,dataset_key:c.fides_key,identities:e,policy_key:y});(0,q.D4)(n)?(s((0,m.Vo)((0,p.e$)(n.error))),i((0,j.hT)())):"data"in n?i((0,j.eY)(n.data.privacy_request_id)):(i((0,j.hT)()),s((0,m.Vo)("No privacy request ID in response")))}catch(e){i((0,j.hT)()),s((0,m.Vo)("Failed to start test run"))}};return(0,n.jsxs)(r.gCW,{alignItems:"stretch",flex:"1",maxWidth:"70vw",minHeight:"0",children:[(0,n.jsxs)(r.X6q,{as:"h3",size:"sm",display:"flex",alignItems:"center",justifyContent:"space-between",children:[(0,n.jsxs)(r.Ugi,{children:[(0,n.jsx)(r.xvT,{children:"Test inputs"}),(0,n.jsx)(h.Z,{copyText:b})]}),(0,n.jsxs)(r.Ugi,{children:[(0,n.jsx)(r.WPr,{id:"policy","aria-label":"Policy selector","data-testid":"policy-select",placeholder:"Select policy",value:I,options:R,onChange:e=>{i((0,j.kF)(e))},className:"w-64"}),(0,n.jsx)(r.wpx,{htmlType:"submit",size:"small",type:"primary","data-testid":"run-btn",onClick:v?()=>{i((0,j.qU)()),s((0,m.t5)("Test manually stopped by user"))}:L,disabled:!y||!u,children:v?"Stop":"Run"}),(0,n.jsx)(O.b,{label:v?"Stop the currently running test":"Run a test access request using the provided test input data and the selected access policy"})]})]}),(0,n.jsx)(r.gxH,{size:"sm",focusBorderColor:"primary.600",color:"gray.800",isDisabled:v,height:"100%",value:b,onChange:e=>{let t=e.target.value;_(t);try{let e=JSON.parse(t);c&&i((0,j.qD)({datasetKey:c.fides_key,values:e}))}catch(e){}}}),(0,n.jsxs)(r.X6q,{as:"h3",size:"sm",children:["Test results ",(0,n.jsx)(h.Z,{copyText:d})]}),(0,n.jsx)(r.gxH,{isReadOnly:!0,size:"sm",focusBorderColor:"primary.600",color:"gray.800",isDisabled:!1,height:"100%",value:d})]})};let L=e=>e.id?Array.isArray(e.id)?e.id[0]:e.id:"";var M=()=>{var e;let t=(0,i.useRouter)(),s=(0,l.T)(),y=L(t.query),{data:h,isLoading:p}=(0,f.rn)(y,{skip:!y}),m=(null==h?void 0:null===(e=h.connection_configs)||void 0===e?void 0:e.key)||"";return((0,a.useEffect)(()=>{s((0,f.db)(h))},[h,s]),p)?(0,n.jsx)(c.Z,{title:"Systems",children:(0,n.jsx)(o.Z,{})}):(0,n.jsxs)(c.Z,{title:"System inventory",mainProps:{height:"100vh",display:"flex",flexDirection:"column"},children:[(0,n.jsx)(d.Z,{heading:"System inventory",breadcrumbItems:[{title:"System inventory",href:u.So},{title:(null==h?void 0:h.name)||"",href:"/systems/configure/".concat(y,"#integrations")},{title:"Test datasets"}]}),(0,n.jsxs)(r.gCW,{alignItems:"stretch",flex:"1",minHeight:"0",spacing:"4",padding:"0",children:[(0,n.jsxs)(r.Ugi,{alignItems:"stretch",flex:"1",minHeight:"0",spacing:"4",maxHeight:"60vh",children:[(0,n.jsx)(k,{connectionKey:m}),(0,n.jsx)(I,{connectionKey:m})]}),(0,n.jsx)(r.xuv,{flex:"0 0 auto",children:(0,n.jsx)(R,{})})]})]})}},19043:function(e,t,s){"use strict";s.d(t,{Bw:function(){return a},D4:function(){return r},Dy:function(){return o},XD:function(){return c},cz:function(){return u},hE:function(){return l},oK:function(){return i}});var n=s(76649);let r=e=>"error"in e,i=e=>(0,n.Ln)({status:"string"},e)&&"PARSING_ERROR"===e.status,a=e=>(0,n.Ln)({status:"number",data:{}},e),l=e=>(0,n.Ln)({detail:"string"},e),o=e=>(0,n.Ln)({detail:{error:"string",resource_type:"string",fides_key:"string"}},e),c=e=>(0,n.Ln)({detail:{error:"string",resource_type:"string",fides_key:"string"}},e),u=e=>(0,n.Ln)({detail:[{loc:["string","number"],msg:"string",type:"string"}]},e)},31883:function(e,t,s){"use strict";s.d(t,{Bw:function(){return n.Bw},D4:function(){return n.D4}});var n=s(19043)},76649:function(e,t,s){"use strict";s.d(t,{Ln:function(){return n}});let n=(e,t)=>i(e,t),r=Symbol("SOME"),i=(e,t)=>"string"==typeof e?e===typeof t:Array.isArray(e)?r in e?e.some(e=>i(e,t)):!!Array.isArray(t)&&(0===e.length||t.every(t=>e.some(e=>i(e,t)))):"object"==typeof t&&null!==t&&Object.entries(e).every(([e,s])=>i(s,t[e]));class a{static narrow(e){return new a(t=>n(e,t))}constructor(e){this.NF=void 0,this.NF=e}satisfied(e){return this.NF(e)}build(e){return e}and(e){let t=this.NF,s=e instanceof a?e.NF:e instanceof Function?e:t=>n(e,t);return new a(e=>t(e)&&s(e))}}new a(e=>!0)}},function(e){e.O(0,[6527,9327,2888,9774,179],function(){return e(e.s=54543)}),_N_E=e.O()}]);